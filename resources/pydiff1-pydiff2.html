<html>
<head>
<META http-equiv="Content-Type" content="text/html; charset=utf-8">
<LINK href="diff.css" rel="stylesheet" type="text/css">
<script type="text/javascript" src="nav.js"></script>
</head>
<body>
<div id="left" class="src"><pre><a id="leftstart" tid="rightstart"></a><a id='2' tid='3' class='u'>import</a> <a id='0' tid='1' class='u'>sys</a>
<a id='6' tid='7' class='u'>import</a> <a id='4' tid='5' class='u'>re</a>
<a id='8' tid='9' class='u'>from</a> ast import *
<a id='10' tid='11' class='u'>from</a> lists import *




#-------------------------------------------------------------
# global parameters
#-------------------------------------------------------------

<span class='d'>DEBUG = False</span>
# sys.setrecursionlimit(10000)


<span class='d'>MOVE_RATIO     = 0.2</span>
<span class='d'>MOVE_SIZE      = 10</span>
<span class='d'>MOVE_ROUND     = 5</span>

<span class='d'>FRAME_DEPTH    = 1</span>
<span class='d'>FRAME_SIZE     = 20</span>

<span class='d'>NAME_PENALTY   = 1</span>
<span class='d'>IF_PENALTY     = 1</span>
<span class='d'>ASSIGN_PENALTY = 1</span>


#-------------------------------------------------------------
# utilities
#-------------------------------------------------------------

<span class='d'>IS = isinstance</span>


<span class='d'>def debug(*args):
    if DEBUG:
        print args</span>


<span class='d'>def dot():
    sys.stdout.write(&#39;.&#39;)</span>


<span class='d'>def isAlpha(c):
    return (c == &#39;_&#39;
            or (&#39;0&#39; &lt;= c &lt;= &#39;9&#39;)
            or (&#39;a&#39; &lt;= c &lt;= &#39;z&#39;)
            or (&#39;A&#39; &lt;= c &lt;= &#39;Z&#39;</span>))


<span class='d'>def div(m, n):
    if n == 0:
        return m
    else:
        return m/float(n)</span>


# for debugging
<span class='d'>def ps(s):
    v = parse(s).body[0]
    if IS(v, Expr):
        return v.value
    else:
        return v</span>


<span class='d'>def sz(s):
    return nodeSize(parse(s), True) - 1</span>


<span class='d'>def dp(s):
    return dump(parse(s))</span>


<span class='d'>def run(name, closure=True, debug=False):
    fullname1 = name + &#39;1.py&#39;
    fullname2 = name + &#39;2.py&#39;

    global DEBUG
    olddebug = DEBUG
    DEBUG = debug

    diff(fullname1, fullname2, closure)

    DEBUG = olddebug</span>


<span class='d'>def demo():
    run(&#39;demo&#39;)</span>


<span class='d'>def go():
    run(&#39;heavy&#39;)</span>


<span class='d'>def pf():
    import cProfile
    cProfile.run(&quot;run(&#39;heavy&#39;)&quot;, sort=&quot;cumulative&quot;)</span>




#------------------------ file system support -----------------------

<span class='d'>def pyFileName(filename):
    try:
        start = filename.rindex(&#39;/&#39;) + 1
    except ValueError:
        start = 0
    end = filename.rindex(&#39;.py&#39;)
    return filename[start:end]</span>


## file system support
<span class='d'>def parseFile(filename):
    f = open(filename, &#39;r&#39;);
    lines = f.read()
    ast = parse(lines)
    improveAST(ast, lines, filename, &#39;left&#39;)
    return ast</span>




#-------------------------------------------------------------
#            tests and operations on AST nodes
#-------------------------------------------------------------

# get list of fields from a node
<span class='d'>def nodeFields(node):
    ret = []
    for field in node._fields:
        if field &lt;&gt; &#39;ctx&#39; and hasattr(node, field):
            ret.append(getattr(node, field))
    return ret</span>



# get full source text where the node is from
<span class='d'>def nodeSource(node):
    if hasattr(node, &#39;nodeSource&#39;):
        return node.nodeSource
    else:
        return None</span>



# utility for getting exact source code part of the node
<span class='d'>def src(node):
    return node.nodeSource[node.nodeStart : node.nodeEnd]</span>



<span class='d'>def nodeStart(node):
    if (hasattr(node, &#39;nodeStart&#39;)):
        return node.nodeStart
    else:
        return 0</span>



<span class='d'>def nodeEnd(node):
    return node.nodeEnd</span>



<span class='d'>def isAtom(x):
    return type(x) in [int, str, bool, float]</span>



<span class='d'>def isDef(node):
    return IS(node, FunctionDef) or IS(node, ClassDef)</span>



# whether a node is a &quot;frame&quot; which can contain others and be
# labeled
<span class='d'>def isFrame(node):
    return type(node) in [ClassDef, FunctionDef, Import, ImportFrom]</span>



<span class='d'>def isEmptyContainer(node):

    if IS(node, List) and node.elts == []:
        return True
    if IS(node, Tuple) and node.elts == []:
        return True
    if IS(node, Dict) and node.keys == []:
        return True

    return False</span>


<span class='d'>def sameDef(node1, node2):
    if IS(node1, FunctionDef) and IS(node2, FunctionDef):
        return node1.name == node2.name
    elif IS(node1, ClassDef) and IS(node2, ClassDef):
        return node1.name == node2.name
    else:
        return False</span>


<span class='d'>def differentDef(node1, node2):
    if isDef(node1) and isDef(node2):
        return node1.name &lt;&gt; node2.name
    return False</span>


# decide whether it is reasonable to consider two nodes to be
# moves of each other
<span class='d'>def canMove(node1, node2, c):
    return (sameDef(node1, node2) or
            c &lt;= (nodeSize(node1) + nodeSize(node2)) * MOVE_RATIO</span>)


# whether the node is considered deleted or inserted because
# the other party matches a substructure of it.
<span class='d'>def nodeFramed(node, changes):
    for c in changes:
        if (c.isFrame and (node == c.orig or node == c.cur)):
            return True
    return False</span>



# helper for turning nested if statements into sequences,
# otherwise we will be trapped in the nested structure and find
# too many differences
<span class='d'>def serializeIf(node):
    if IS(node, If):
        if not hasattr(node, &#39;nodeEnd&#39;):
            print &quot;has no end:&quot;, node

        newif = If(node.test, node.body, [])
        newif.lineno = node.lineno
        newif.col_offset = node.col_offset
        newif.nodeStart = node.nodeStart
        newif.nodeEnd = node.nodeEnd
        newif.nodeSource = node.nodeSource
        newif.fileName = node.fileName
        return [newif] + serializeIf(node.orelse)
    elif IS(node, list):
        ret = []
        for n in node:
            ret += serializeIf(n)
        return ret
    else:
        return [node]</span>


<span class='d'>def nodeName(node):
    if IS(node, Name):
        return node.id
    elif IS(node, FunctionDef) or IS(node, ClassDef):
        return node.name
    else:
        return None</span>


<span class='d'>def attr2str(node):
    if IS(node, Attribute):
        vName = attr2str(node.value)
        if vName &lt;&gt; None:
            return vName + &quot;.&quot; + node.attr
        else:
            return None
    elif IS(node, Name):
        return node.id
    else:
        return None</span>


### utility for counting size of terms
<span class='d'>def nodeSize(node, test=False):

    if not test and hasattr(node, &#39;nodeSize&#39;):
        ret = node.nodeSize

    elif IS(node, list):
        ret = sum(map(lambda x: nodeSize(x, test), node))

    elif isAtom(node):
        ret = 1

    elif IS(node, Name):
        ret = 1

    elif IS(node, Num):
        ret = 1

    elif IS(node, Str):
        ret = 1

    elif IS(node, Expr):
        ret = nodeSize(node.value, test)

    elif IS(node, AST):
        ret = 1 + sum(map(lambda x: nodeSize(x, test), nodeFields(node)))

    else:
        ret = 0

    if test:
        print &quot;node:&quot;, node, &quot;size=&quot;, ret

    if IS(node, AST):
        node.nodeSize = ret

    return ret</span>




#------------------------------- types ------------------------------
# global storage of running stats
<a id='20' tid='21' class='u'>class <a id='18' tid='19' class='u'>Stat</a>:
    <a id='16' tid='17' class='u'>def <a id='14' tid='15' class='u'>__init__</a>(<a id='12' tid='13' class='u'>self</a>):
        pass</a></a>

<a id='22' tid='23' class='u'>stat</a> = <a id='24' tid='25' class='u'>Stat</a>()



# The difference between nodes are stored as a Change structure.
<a id='214' tid='215' class='c'>class <a id='212' tid='213' class='u'>Change</a>:
    <a id='98' tid='99' class='c'>def <a id='96' tid='97' class='u'>__init__</a>(<a id='36' tid='37' class='u'>self</a>, <a id='34' tid='35' class='u'>orig</a>, <a id='32' tid='33' class='u'>cur</a>, <a id='30' tid='31' class='u'>cost</a>, <a id='28' tid='29' class='c'>isFrame</a>=<a id='26' tid='27' class='u'>False</a>):
        <a id='38' tid='39' class='u'>self.orig</a> = <a id='40' tid='41' class='u'>orig</a>
        <a id='42' tid='43' class='u'>self.cur</a> = <a id='44' tid='45' class='u'>cur</a>
        if <a id='50' tid='51' class='u'>orig</a> <a id='46' tid='47' class='u'>==</a> <a id='48' tid='49' class='u'>None</a>:
            <a id='52' tid='53' class='u'>self.cost</a> = <a id='56' tid='57' class='c'>nodeSize</a>(<a id='54' tid='55' class='u'>cur</a>)
        elif <a id='62' tid='63' class='u'>cur</a> <a id='58' tid='59' class='u'>==</a> <a id='60' tid='61' class='u'>None</a>:
            <a id='64' tid='65' class='u'>self.cost</a> = <a id='68' tid='69' class='c'>nodeSize</a>(<a id='66' tid='67' class='u'>orig</a>)
        elif <a id='74' tid='75' class='u'>cost</a> <a id='70' tid='71' class='u'>==</a> <a id='72' tid='73' class='u'>&#39;all&#39;</a>:
            <a id='76' tid='77' class='u'>self.cost</a> = <a id='84' tid='85' class='c'>nodeSize</a>(<a id='86' tid='87' class='u'>orig</a>) <a id='78' tid='79' class='u'>+</a> <a id='80' tid='81' class='c'>nodeSize</a>(<a id='82' tid='83' class='u'>cur</a>)
        else:
            <a id='88' tid='89' class='u'>self.cost</a> = <a id='90' tid='91' class='u'>cost</a>
        <a id='92' tid='93' class='c'>self.isFrame</a> = <a id='94' tid='95' class='c'>isFrame</a></a>
    <a id='182' tid='183' class='c'>def <a id='180' tid='181' class='u'>__repr__</a>(<a id='100' tid='101' class='u'>self</a>):
        <a id='102' tid='103' class='u'>fr</a> = <a id='106' tid='107' class='u'>&quot;F&quot;</a> if <a id='108' tid='109' class='c'>self.isFrame</a> else <a id='104' tid='105' class='u'>&quot;-&quot;</a>
        <a id='124' tid='125' class='u'>def <a id='122' tid='123' class='u'>hole</a>(<a id='110' tid='111' class='u'>x</a>):
            if <a id='116' tid='117' class='u'>x</a> <a id='112' tid='113' class='u'>==</a> <a id='114' tid='115' class='u'>None</a>:
                return <a id='118' tid='119' class='u'>&quot;[]&quot;</a>
            else:
                return <a id='120' tid='121' class='u'>x</a></a>
        return (<a id='146' tid='147' class='u'>&quot;(C:&quot;</a> <a id='154' tid='155' class='u'>+</a> <a id='152' tid='153' class='u'>str</a>(<a id='150' tid='151' class='u'>hole</a>(<a id='148' tid='149' class='u'>self.orig</a>)) <a id='142' tid='143' class='u'>+</a> <a id='144' tid='145' class='u'>&quot;:&quot;</a> <a id='162' tid='163' class='u'>+</a> <a id='160' tid='161' class='u'>str</a>(<a id='158' tid='159' class='u'>hole</a>(<a id='156' tid='157' class='u'>self.cur</a>))
                <a id='138' tid='139' class='u'>+</a> <a id='140' tid='141' class='u'>&quot;:&quot;</a> <a id='168' tid='169' class='u'>+</a> <a id='166' tid='167' class='u'>str</a>(<a id='164' tid='165' class='u'>self.cost</a>) <a id='134' tid='135' class='u'>+</a> <a id='136' tid='137' class='u'>&quot;:&quot;</a> <a id='174' tid='175' class='u'>+</a> <a id='172' tid='173' class='u'>str</a>(<a id='170' tid='171' class='u'>self.similarity</a>())
                <a id='130' tid='131' class='u'>+</a> <a id='132' tid='133' class='u'>&quot;:&quot;</a> <a id='178' tid='179' class='u'>+</a> <a id='176' tid='177' class='u'>fr</a> <a id='126' tid='127' class='u'>+</a> <a id='128' tid='129' class='u'>&quot;)&quot;</a></a>)
    <a id='210' tid='211' class='c'>def <a id='208' tid='209' class='u'>similarity</a>(<a id='184' tid='185' class='u'>self</a>):
        <a id='186' tid='187' class='u'>total</a> = <a id='194' tid='195' class='c'>nodeSize</a>(<a id='196' tid='197' class='u'>self.orig</a>) <a id='188' tid='189' class='u'>+</a> <a id='190' tid='191' class='c'>nodeSize</a>(<a id='192' tid='193' class='u'>self.cur</a>)
        return <a id='206' tid='207' class='u'>1</a> <a id='198' tid='199' class='u'>-</a> <a id='200' tid='201' class='u'>div</a>(<a id='202' tid='203' class='u'>self.cost</a>, <a id='204' tid='205' class='u'>total</a>)</a></a>



# Three major kinds of changes:
# * modification
# * deletion
# *insertion
<a id='234' tid='235' class='c'>def <a id='232' tid='233' class='c'>modifyNode</a>(<a id='220' tid='221' class='u'>node1</a>, <a id='218' tid='219' class='u'>node2</a>, <a id='216' tid='217' class='u'>cost</a>):
    return <a id='230' tid='231' class='u'>loner</a>(<a id='228' tid='229' class='u'>Change</a>(<a id='226' tid='227' class='u'>node1</a>, <a id='224' tid='225' class='u'>node2</a>, <a id='222' tid='223' class='u'>cost</a>))</a>

<a id='252' tid='253' class='c'>def <a id='250' tid='251' class='c'>delNode</a>(<a id='236' tid='237' class='u'>node</a>):
    return <a id='248' tid='249' class='u'>loner</a>(<a id='246' tid='247' class='u'>Change</a>(<a id='244' tid='245' class='u'>node</a>, <a id='242' tid='243' class='u'>None</a>, <a id='240' tid='241' class='c'>nodeSize</a>(<a id='238' tid='239' class='u'>node</a>)))</a>

<a id='270' tid='271' class='c'>def <a id='268' tid='269' class='c'>insNode</a>(<a id='254' tid='255' class='u'>node</a>):
    return <a id='266' tid='267' class='u'>loner</a>(<a id='264' tid='265' class='u'>Change</a>(<a id='262' tid='263' class='u'>None</a>, <a id='260' tid='261' class='u'>node</a>, <a id='258' tid='259' class='c'>nodeSize</a>(<a id='256' tid='257' class='u'>node</a>)))</a>



# general cache table for acceleration
<a id='340' tid='341' class='u'>class <a id='338' tid='339' class='u'>Cache</a>:
    <a id='278' tid='279' class='u'>def <a id='276' tid='277' class='u'>__init__</a>(<a id='272' tid='273' class='u'>self</a>):
        <a id='274' tid='275' class='u'>self.table</a> = {}</a>
    <a id='292' tid='293' class='u'>def <a id='290' tid='291' class='u'>__repr__</a>(<a id='280' tid='281' class='u'>self</a>):
        return <a id='288' tid='289' class='u'>&quot;Cache:&quot;</a> <a id='282' tid='283' class='u'>+</a> <a id='284' tid='285' class='u'>str</a>(<a id='286' tid='287' class='u'>self.table</a>)</a>
    <a id='302' tid='303' class='u'>def <a id='300' tid='301' class='u'>__len__</a>(<a id='294' tid='295' class='u'>self</a>):
        return <a id='298' tid='299' class='u'>len</a>(<a id='296' tid='297' class='u'>self.table</a>)</a>
    <a id='318' tid='319' class='u'>def <a id='316' tid='317' class='u'>put</a>(<a id='308' tid='309' class='u'>self</a>, <a id='306' tid='307' class='u'>key</a>, <a id='304' tid='305' class='u'>value</a>):
        <a id='310' tid='311' class='u'>self.table</a>[<a id='312' tid='313' class='u'>key</a>] = <a id='314' tid='315' class='u'>value</a></a>
    <a id='336' tid='337' class='u'>def <a id='334' tid='335' class='u'>get</a>(<a id='322' tid='323' class='u'>self</a>, <a id='320' tid='321' class='u'>key</a>):
        if <a id='326' tid='327' class='u'>self.table.has_key</a>(<a id='324' tid='325' class='u'>key</a>):
            return <a id='330' tid='331' class='u'>self.table</a>[<a id='328' tid='329' class='u'>key</a>]
        else:
            return <a id='332' tid='333' class='u'>None</a></a></a>



# 2-D array table for memoization of dynamic programming
<a id='374' tid='375' class='c'>def <a id='372' tid='373' class='c'>createTable</a>(<a id='344' tid='345' class='u'>x</a>, <a id='342' tid='343' class='u'>y</a>):
    <a id='346' tid='347' class='u'>table</a> = []
    for <a id='348' tid='349' class='u'>i</a> in <a id='356' tid='357' class='u'>range</a>(<a id='354' tid='355' class='u'>x</a><a id='350' tid='351' class='u'>+</a><a id='352' tid='353' class='u'>1</a>):
        <a id='368' tid='369' class='u'>table.append</a>([<a id='366' tid='367' class='u'>None</a>] <a id='358' tid='359' class='u'>*</a> (<a id='360' tid='361' class='u'>y</a><a id='364' tid='365' class='u'>+</a><a id='362' tid='363' class='u'>1</a>))
    return <a id='370' tid='371' class='u'>table</a></a>

<a id='390' tid='391' class='u'>def <a id='388' tid='389' class='u'>tableLookup</a>(<a id='380' tid='381' class='u'>t</a>, <a id='378' tid='379' class='u'>x</a>, <a id='376' tid='377' class='u'>y</a>):
    return <a id='384' tid='385' class='u'>t</a>[<a id='386' tid='387' class='u'>x</a>]</a>[<a id='382' tid='383' class='u'>y</a>]

<a id='410' tid='411' class='u'>def <a id='408' tid='409' class='u'>tablePut</a>(<a id='398' tid='399' class='u'>t</a>, <a id='396' tid='397' class='u'>x</a>, <a id='394' tid='395' class='u'>y</a>, <a id='392' tid='393' class='u'>v</a>):
    <a id='402' tid='403' class='u'>t</a>[<a id='400' tid='401' class='u'>x</a>][<a id='404' tid='405' class='u'>y</a>] = <a id='406' tid='407' class='u'>v</a></a>





#-------------------------------------------------------------
#                  string distance function
#-------------------------------------------------------------

### diff cache for AST nodes
<a id='412' tid='413' class='c'>strDistCache</a> = <a id='414' tid='415' class='u'>Cache</a>()
<span class='d'>def clearStrDistCache():
    global strDistCache
    strDistCache = Cache()</span>


### string distance function
<a id='518' tid='519' class='c'>def <a id='516' tid='517' class='c'>strDist</a>(<a id='418' tid='419' class='u'>s1</a>, <a id='416' tid='417' class='u'>s2</a>):
    <a id='420' tid='421' class='u'>cached</a> = <a id='426' tid='427' class='c'>strDistCache.get</a>((<a id='424' tid='425' class='u'>s1</a>, <a id='422' tid='423' class='u'>s2</a>))
    if <a id='432' tid='433' class='u'>cached</a> <a id='428' tid='429' class='u'>&lt;&gt;</a> <a id='430' tid='431' class='u'>None</a>:
        return <a id='434' tid='435' class='u'>cached</a>

    if <a id='450' tid='451' class='u'>len</a>(<a id='452' tid='453' class='u'>s1</a>) <a id='446' tid='447' class='u'>&gt;</a> <a id='448' tid='449' class='u'>100</a> <a id='436' tid='437' class='u'>or</a> <a id='442' tid='443' class='u'>len</a>(<a id='444' tid='445' class='u'>s2</a>) <a id='438' tid='439' class='u'>&gt;</a> <a id='440' tid='441' class='u'>100</a>:
        if <a id='458' tid='459' class='u'>s1</a> <a id='454' tid='455' class='u'>&lt;&gt;</a> <a id='456' tid='457' class='u'>s2</a>:
            return <a id='460' tid='461' class='u'>2.0</a>
        else:
            return <a id='462' tid='463' class='u'>0</a>

    <a id='464' tid='465' class='u'>table</a> = <a id='474' tid='475' class='c'>createTable</a>(<a id='472' tid='473' class='u'>len</a>(<a id='470' tid='471' class='u'>s1</a>), <a id='468' tid='469' class='u'>len</a>(<a id='466' tid='467' class='u'>s2</a>))
    <a id='476' tid='477' class='u'>d</a> = <a id='484' tid='485' class='u'>dist1</a>(<a id='482' tid='483' class='u'>table</a>, <a id='480' tid='481' class='u'>s1</a>, <a id='478' tid='479' class='u'>s2</a>)
    <a id='486' tid='487' class='u'>ret</a> = <a id='504' tid='505' class='u'>div</a>(<a id='502' tid='503' class='u'>2</a><a id='498' tid='499' class='u'>*</a><a id='500' tid='501' class='u'>d</a>, <a id='494' tid='495' class='u'>len</a>(<a id='496' tid='497' class='u'>s1</a>) <a id='488' tid='489' class='u'>+</a> <a id='490' tid='491' class='u'>len</a>(<a id='492' tid='493' class='u'>s2</a>))

    <a id='512' tid='513' class='c'>strDistCache.put</a>((<a id='510' tid='511' class='u'>s1</a>, <a id='508' tid='509' class='u'>s2</a>), <a id='506' tid='507' class='u'>ret</a>)
    return <a id='514' tid='515' class='u'>ret</a></a>


# the main dynamic programming part
# similar to the structure of diffList
<a id='692' tid='693' class='u'>def <a id='690' tid='691' class='u'>dist1</a>(<a id='524' tid='525' class='u'>table</a>, <a id='522' tid='523' class='u'>s1</a>, <a id='520' tid='521' class='u'>s2</a>):
    <a id='546' tid='547' class='u'>def <a id='544' tid='545' class='u'>memo</a>(<a id='526' tid='527' class='u'>v</a>):
        <a id='540' tid='541' class='u'>tablePut</a>(<a id='538' tid='539' class='u'>table</a>, <a id='536' tid='537' class='u'>len</a>(<a id='534' tid='535' class='u'>s1</a>), <a id='532' tid='533' class='u'>len</a>(<a id='530' tid='531' class='u'>s2</a>), <a id='528' tid='529' class='u'>v</a>)
        return <a id='542' tid='543' class='u'>v</a></a>

    <a id='548' tid='549' class='u'>cached</a> = <a id='560' tid='561' class='u'>tableLookup</a>(<a id='558' tid='559' class='u'>table</a>, <a id='556' tid='557' class='u'>len</a>(<a id='554' tid='555' class='u'>s1</a>), <a id='552' tid='553' class='u'>len</a>(<a id='550' tid='551' class='u'>s2</a>))
    if (<a id='566' tid='567' class='u'>cached</a> <a id='562' tid='563' class='u'>&lt;&gt;</a> <a id='564' tid='565' class='u'>None</a>):
        return <a id='568' tid='569' class='u'>cached</a>

    if <a id='574' tid='575' class='u'>s1</a> <a id='570' tid='571' class='u'>==</a> <a id='572' tid='573' class='u'>&#39;&#39;</a>:
        return <a id='580' tid='581' class='u'>memo</a>(<a id='578' tid='579' class='u'>len</a>(<a id='576' tid='577' class='u'>s2</a>))
    elif <a id='586' tid='587' class='u'>s2</a> <a id='582' tid='583' class='u'>==</a> <a id='584' tid='585' class='u'>&#39;&#39;</a>:
        return <a id='592' tid='593' class='u'>memo</a>(<a id='590' tid='591' class='u'>len</a>(<a id='588' tid='589' class='u'>s1</a>))
    else:
        if <a id='600' tid='601' class='u'>s1</a>[<a id='602' tid='603' class='u'>0</a>] <a id='594' tid='595' class='u'>==</a> <a id='598' tid='599' class='u'>s2</a>[<a id='596' tid='597' class='u'>0</a>]:
            <a id='604' tid='605' class='u'>d0</a> = <a id='606' tid='607' class='u'>0</a>
        elif <a id='618' tid='619' class='u'>s1</a>[<a id='620' tid='621' class='u'>0</a>].<a id='616' tid='617' class='u'>lower</a>() <a id='608' tid='609' class='u'>==</a> <a id='612' tid='613' class='u'>s2</a>[<a id='610' tid='611' class='u'>0</a>].<a id='614' tid='615' class='u'>lower</a>():
            <a id='622' tid='623' class='u'>d0</a> = <a id='624' tid='625' class='u'>1</a>
        else:
            <a id='626' tid='627' class='u'>d0</a> = <a id='628' tid='629' class='u'>2</a>

        <a id='630' tid='631' class='u'>d0</a> = <a id='646' tid='647' class='u'>d0</a> <a id='632' tid='633' class='u'>+</a> <a id='634' tid='635' class='u'>dist1</a>(<a id='636' tid='637' class='u'>table</a>, <a id='638' tid='639' class='u'>s1</a>[<a id='640' tid='641' class='u'>1</a>:], <a id='642' tid='643' class='u'>s2</a>[<a id='644' tid='645' class='u'>1</a>:])
        <a id='648' tid='649' class='u'>d1</a> = <a id='662' tid='663' class='u'>1</a> <a id='650' tid='651' class='u'>+</a> <a id='652' tid='653' class='u'>dist1</a>(<a id='654' tid='655' class='u'>table</a>, <a id='656' tid='657' class='u'>s1</a>[<a id='658' tid='659' class='u'>1</a>:], <a id='660' tid='661' class='u'>s2</a>)
        <a id='664' tid='665' class='u'>d2</a> = <a id='678' tid='679' class='u'>1</a> <a id='666' tid='667' class='u'>+</a> <a id='668' tid='669' class='u'>dist1</a>(<a id='670' tid='671' class='u'>table</a>, <a id='672' tid='673' class='u'>s1</a>, <a id='674' tid='675' class='u'>s2</a>[<a id='676' tid='677' class='u'>1</a>:])
        return <a id='688' tid='689' class='u'>memo</a>(<a id='686' tid='687' class='u'>min</a>(<a id='684' tid='685' class='u'>d0</a>, <a id='682' tid='683' class='u'>d1</a>, <a id='680' tid='681' class='u'>d2</a>))</a>




#-------------------------------------------------------------
#                        diff of nodes
#-------------------------------------------------------------

<a id='694' tid='695' class='c'>stat.diffCount</a> = <a id='696' tid='697' class='u'>0</a>
<a id='1330' tid='1331' class='c'>def <a id='1328' tid='1329' class='c'>diffNode</a>(<a id='708' tid='709' class='u'>node1</a>, <a id='706' tid='707' class='u'>node2</a>, <a id='704' tid='705' class='u'>env1</a>, <a id='702' tid='703' class='u'>env2</a>, <a id='700' tid='701' class='u'>depth</a>, <a id='698' tid='699' class='u'>move</a>):

    # try substructural diff
    <a id='764' tid='765' class='c'>def <a id='762' tid='763' class='u'>trysub</a>((<a id='712' tid='713' class='u'>changes</a>, <a id='710' tid='711' class='u'>cost</a>)):
        if <a id='714' tid='715' class='u'>not</a> <a id='716' tid='717' class='u'>move</a>:
            return (<a id='720' tid='721' class='u'>changes</a>, <a id='718' tid='719' class='u'>cost</a>)
        elif <a id='728' tid='729' class='c'>canMove</a>(<a id='726' tid='727' class='u'>node1</a>, <a id='724' tid='725' class='u'>node2</a>, <a id='722' tid='723' class='u'>cost</a>):
            return (<a id='732' tid='733' class='u'>changes</a>, <a id='730' tid='731' class='u'>cost</a>)
        else:
            <a id='734' tid='735' class='u'>mc1</a> = <a id='748' tid='749' class='c'>diffSubNode</a>(<a id='746' tid='747' class='u'>node1</a>, <a id='744' tid='745' class='u'>node2</a>, <a id='742' tid='743' class='u'>env1</a>, <a id='740' tid='741' class='u'>env2</a>, <a id='738' tid='739' class='u'>depth</a>, <a id='736' tid='737' class='u'>move</a>)
            if <a id='754' tid='755' class='u'>mc1</a> <a id='750' tid='751' class='u'>&lt;&gt;</a> <a id='752' tid='753' class='u'>None</a>:
                return <a id='756' tid='757' class='u'>mc1</a>
            else:
                return (<a id='760' tid='761' class='u'>changes</a>, <a id='758' tid='759' class='u'>cost</a></a>)

    if <a id='780' tid='781' class='c'>IS</a>(<a id='778' tid='779' class='u'>node1</a>, <a id='776' tid='777' class='u'>list</a>) <a id='766' tid='767' class='u'>and</a> <a id='768' tid='769' class='u'>not</a> <a id='770' tid='771' class='c'>IS</a>(<a id='772' tid='773' class='u'>node2</a>, <a id='774' tid='775' class='u'>list</a>):
        return <a id='794' tid='795' class='c'>diffNode</a>(<a id='792' tid='793' class='u'>node1</a>, [<a id='790' tid='791' class='u'>node2</a>], <a id='788' tid='789' class='u'>env1</a>, <a id='786' tid='787' class='u'>env2</a>, <a id='784' tid='785' class='u'>depth</a>, <a id='782' tid='783' class='u'>move</a>)

    if <a id='804' tid='805' class='u'>not</a> <a id='806' tid='807' class='c'>IS</a>(<a id='808' tid='809' class='u'>node1</a>, <a id='810' tid='811' class='u'>list</a>) <a id='796' tid='797' class='u'>and</a> <a id='802' tid='803' class='c'>IS</a>(<a id='800' tid='801' class='u'>node2</a>, <a id='798' tid='799' class='u'>list</a>):
        return <a id='824' tid='825' class='c'>diffNode</a>([<a id='822' tid='823' class='u'>node1</a>], <a id='820' tid='821' class='u'>node2</a>, <a id='818' tid='819' class='u'>env1</a>, <a id='816' tid='817' class='u'>env2</a>, <a id='814' tid='815' class='u'>depth</a>, <a id='812' tid='813' class='u'>move</a>)

    if (<a id='838' tid='839' class='c'>IS</a>(<a id='836' tid='837' class='u'>node1</a>, <a id='834' tid='835' class='u'>list</a>) <a id='826' tid='827' class='u'>and</a> <a id='832' tid='833' class='c'>IS</a>(<a id='830' tid='831' class='u'>node2</a>, <a id='828' tid='829' class='u'>list</a>)):
        <a id='840' tid='841' class='u'>node1</a> = <a id='844' tid='845' class='c'>serializeIf</a>(<a id='842' tid='843' class='u'>node1</a>)
        <a id='846' tid='847' class='u'>node2</a> = <a id='850' tid='851' class='c'>serializeIf</a>(<a id='848' tid='849' class='u'>node2</a>)
        <a id='852' tid='853' class='u'>table</a> = <a id='862' tid='863' class='c'>createTable</a>(<a id='860' tid='861' class='u'>len</a>(<a id='858' tid='859' class='u'>node1</a>), <a id='856' tid='857' class='u'>len</a>(<a id='854' tid='855' class='u'>node2</a>))
        return <a id='878' tid='879' class='c'>diffList</a>(<a id='876' tid='877' class='u'>table</a>, <a id='874' tid='875' class='u'>node1</a>, <a id='872' tid='873' class='u'>node2</a>, <a id='870' tid='871' class='u'>env1</a>, <a id='868' tid='869' class='u'>env2</a>, <a id='866' tid='867' class='u'>0</a>, <a id='864' tid='865' class='u'>move</a>)

    # statistics
    <a id='880' tid='881' class='c'>stat.diffCount</a> <a id='884' tid='885' class='u'>+</a>= <a id='882' tid='883' class='u'>1</a>
    if <a id='890' tid='891' class='c'>stat.diffCount</a> <a id='894' tid='895' class='u'>%</a> <a id='892' tid='893' class='u'>1000</a> <a id='886' tid='887' class='u'>==</a> <a id='888' tid='889' class='u'>0</a>:
        <a id='896' tid='897' class='u'>dot</a>()

    if <a id='902' tid='903' class='u'>node1</a> <a id='898' tid='899' class='u'>==</a> <a id='900' tid='901' class='u'>node2</a>:
        return (<a id='912' tid='913' class='c'>modifyNode</a>(<a id='910' tid='911' class='u'>node1</a>, <a id='908' tid='909' class='u'>node2</a>, <a id='906' tid='907' class='u'>0</a>), <a id='904' tid='905' class='u'>0</a>)

    if <a id='926' tid='927' class='c'>IS</a>(<a id='924' tid='925' class='u'>node1</a>, <a id='922' tid='923' class='u'>Num</a>) <a id='914' tid='915' class='u'>and</a> <a id='920' tid='921' class='c'>IS</a>(<a id='918' tid='919' class='u'>node2</a>, <a id='916' tid='917' class='u'>Num</a>):
        if <a id='932' tid='933' class='u'>node1.n</a> <a id='928' tid='929' class='u'>==</a> <a id='930' tid='931' class='u'>node2.n</a>:
            return (<a id='942' tid='943' class='c'>modifyNode</a>(<a id='940' tid='941' class='u'>node1</a>, <a id='938' tid='939' class='u'>node2</a>, <a id='936' tid='937' class='u'>0</a>), <a id='934' tid='935' class='u'>0</a>)
        else:
            return (<a id='952' tid='953' class='c'>modifyNode</a>(<a id='950' tid='951' class='u'>node1</a>, <a id='948' tid='949' class='u'>node2</a>, <a id='946' tid='947' class='u'>1</a>), <a id='944' tid='945' class='u'>1</a>)

    if <a id='966' tid='967' class='c'>IS</a>(<a id='964' tid='965' class='u'>node1</a>, <a id='962' tid='963' class='u'>Str</a>) <a id='954' tid='955' class='u'>and</a> <a id='960' tid='961' class='c'>IS</a>(<a id='958' tid='959' class='u'>node2</a>, <a id='956' tid='957' class='u'>Str</a>):
        <a id='968' tid='969' class='u'>cost</a> = <a id='974' tid='975' class='c'>strDist</a>(<a id='972' tid='973' class='u'>node1.s</a>, <a id='970' tid='971' class='u'>node2.s</a>)
        return (<a id='984' tid='985' class='c'>modifyNode</a>(<a id='982' tid='983' class='u'>node1</a>, <a id='980' tid='981' class='u'>node2</a>, <a id='978' tid='979' class='u'>cost</a>), <a id='976' tid='977' class='u'>cost</a>)

    if (<a id='998' tid='999' class='c'>IS</a>(<a id='996' tid='997' class='u'>node1</a>, <a id='994' tid='995' class='u'>Name</a>) <a id='986' tid='987' class='u'>and</a> <a id='992' tid='993' class='c'>IS</a>(<a id='990' tid='991' class='u'>node2</a>, <a id='988' tid='989' class='u'>Name</a>)):
        <a id='1000' tid='1001' class='u'>v1</a> = <a id='1006' tid='1007' class='u'>lookup</a>(<a id='1004' tid='1005' class='u'>node1.id</a>, <a id='1002' tid='1003' class='u'>env1</a>)
        <a id='1008' tid='1009' class='u'>v2</a> = <a id='1014' tid='1015' class='u'>lookup</a>(<a id='1012' tid='1013' class='u'>node2.id</a>, <a id='1010' tid='1011' class='u'>env2</a>)
        if <a id='1036' tid='1037' class='u'>v1</a> <a id='1032' tid='1033' class='u'>&lt;&gt;</a> <a id='1034' tid='1035' class='u'>v2</a> <a id='1016' tid='1017' class='u'>or</a> (<a id='1030' tid='1031' class='u'>v1</a> <a id='1026' tid='1027' class='u'>==</a> <a id='1028' tid='1029' class='u'>None</a> <a id='1018' tid='1019' class='u'>and</a> <a id='1024' tid='1025' class='u'>v2</a> <a id='1020' tid='1021' class='u'>==</a> <a id='1022' tid='1023' class='u'>None</a>):
            <a id='1038' tid='1039' class='u'>cost</a> = <a id='1044' tid='1045' class='c'>strDist</a>(<a id='1042' tid='1043' class='u'>node1.id</a>, <a id='1040' tid='1041' class='u'>node2.id</a>)
            return (<a id='1054' tid='1055' class='c'>modifyNode</a>(<a id='1052' tid='1053' class='u'>node1</a>, <a id='1050' tid='1051' class='u'>node2</a>, <a id='1048' tid='1049' class='u'>cost</a>), <a id='1046' tid='1047' class='u'>cost</a>)
        else:                           # same variable
            return (<a id='1064' tid='1065' class='c'>modifyNode</a>(<a id='1062' tid='1063' class='u'>node1</a>, <a id='1060' tid='1061' class='u'>node2</a>, <a id='1058' tid='1059' class='u'>0</a>), <a id='1056' tid='1057' class='u'>0</a>)

    if (<a id='1108' tid='1109' class='c'>IS</a>(<a id='1106' tid='1107' class='u'>node1</a>, <a id='1104' tid='1105' class='u'>Attribute</a>) <a id='1096' tid='1097' class='u'>and</a> <a id='1102' tid='1103' class='c'>IS</a>(<a id='1100' tid='1101' class='u'>node2</a>, <a id='1098' tid='1099' class='u'>Name</a>) <a id='1066' tid='1067' class='u'>or</a>
        <a id='1094' tid='1095' class='c'>IS</a>(<a id='1092' tid='1093' class='u'>node1</a>, <a id='1090' tid='1091' class='u'>Name</a>) <a id='1082' tid='1083' class='u'>and</a> <a id='1088' tid='1089' class='c'>IS</a>(<a id='1086' tid='1087' class='u'>node2</a>, <a id='1084' tid='1085' class='u'>Attribute</a>) or
        <a id='1080' tid='1081' class='c'>IS</a>(<a id='1078' tid='1079' class='u'>node1</a>, <a id='1076' tid='1077' class='u'>Attribute</a>) <a id='1068' tid='1069' class='u'>and</a> <a id='1074' tid='1075' class='c'>IS</a>(<a id='1072' tid='1073' class='u'>node2</a>, <a id='1070' tid='1071' class='u'>Attribute</a>)):
        <a id='1110' tid='1111' class='u'>s1</a> = <a id='1114' tid='1115' class='c'>attr2str</a>(<a id='1112' tid='1113' class='u'>node1</a>)
        <a id='1116' tid='1117' class='u'>s2</a> = <a id='1120' tid='1121' class='c'>attr2str</a>(<a id='1118' tid='1119' class='u'>node2</a>)
        if <a id='1134' tid='1135' class='u'>s1</a> <a id='1130' tid='1131' class='u'>&lt;&gt;</a> <a id='1132' tid='1133' class='u'>None</a> <a id='1122' tid='1123' class='u'>and</a> <a id='1128' tid='1129' class='u'>s2</a> <a id='1124' tid='1125' class='u'>&lt;&gt;</a> <a id='1126' tid='1127' class='u'>None</a>:
            <a id='1136' tid='1137' class='u'>cost</a> = <a id='1142' tid='1143' class='c'>strDist</a>(<a id='1140' tid='1141' class='u'>s1</a>, <a id='1138' tid='1139' class='u'>s2</a>)
            return (<a id='1152' tid='1153' class='c'>modifyNode</a>(<a id='1150' tid='1151' class='u'>node1</a>, <a id='1148' tid='1149' class='u'>node2</a>, <a id='1146' tid='1147' class='u'>cost</a>), <a id='1144' tid='1145' class='u'>cost</a>)
        # else fall through for things like f(x).y vs x.y

    # if (IS(node1, ClassDef) and IS(node2, ClassDef)):
    #     (m1, c1) = diffNode(node1.bases, node2.bases, env1, env2, depth, move)
    #     (m2, c2) = diffNode(node1.body, node2.body, env1, env2, depth, move)
    #     (m3, c3) = diffNode(node1.decorator_list, node2.decorator_list,
    #                         env1, env2, depth, move)
    #     changes = append(m1, m2, m3)
    #     cost = c1 + c2 + c3 + strDist(node1.name, node2.name)
    #     return trysub((changes, cost))

    # if (IS(node1, FunctionDef) and IS(node2, FunctionDef)):
    #     return trysub(diffFunctionDef(node1, node2,
    #                                   env1, env2, depth, move))

    # if (IS(node1, Assign) and IS(node2, Assign)):
    #     (m1, c1) = diffNode(node1.targets, node2.targets,
    #                         env1, env2, depth, move)
    #     (m2, c2) = diffNode(node1.value, node2.value,
    #                         env1, env2, depth, move)
    #     return (append(m1, m2), c1 * ASSIGN_PENALTY + c2)

    # # flatten nested if nodes
    # if IS(node1, If) and IS(node2, If):
    #     seq1 = serializeIf(node1)
    #     seq2 = serializeIf(node2)
    #     if len(seq1) &gt; 1 and len(seq2) &gt; 1:
    #         return diffNode(seq1, seq2, env1, env2, depth, move)
    #     else:
    #         (m0, c0) = diffNode(node1.test, node2.test, env1, env2, depth, move)
    #         (m1, c1) = diffNode(node1.body, node2.body, env1, env2, depth, move)
    #         (m2, c2) = diffNode(node1.orelse, node2.orelse, env1, env2, depth, move)
    #         changes = append(m0, m1, m2)
    #         cost = c0 * IF_PENALTY + c1 + c2
    #         return trysub((changes, cost))

    if <a id='1166' tid='1167' class='c'>IS</a>(<a id='1164' tid='1165' class='u'>node1</a>, <a id='1162' tid='1163' class='u'>Module</a>) <a id='1154' tid='1155' class='u'>and</a> <a id='1160' tid='1161' class='c'>IS</a>(<a id='1158' tid='1159' class='u'>node2</a>, <a id='1156' tid='1157' class='u'>Module</a>):
        return <a id='1180' tid='1181' class='c'>diffNode</a>(<a id='1178' tid='1179' class='u'>node1.body</a>, <a id='1176' tid='1177' class='u'>node2.body</a>, <a id='1174' tid='1175' class='u'>env1</a>, <a id='1172' tid='1173' class='u'>env2</a>, <a id='1170' tid='1171' class='u'>depth</a>, <a id='1168' tid='1169' class='u'>move</a>)

    # other AST nodes
    if (<a id='1204' tid='1205' class='c'>IS</a>(<a id='1202' tid='1203' class='u'>node1</a>, <a id='1200' tid='1201' class='u'>AST</a>) <a id='1182' tid='1183' class='u'>and</a> <a id='1198' tid='1199' class='c'>IS</a>(<a id='1196' tid='1197' class='u'>node2</a>, <a id='1194' tid='1195' class='u'>AST</a>) and
        <a id='1190' tid='1191' class='u'>type</a>(<a id='1192' tid='1193' class='u'>node1</a>) <a id='1184' tid='1185' class='u'>==</a> <a id='1188' tid='1189' class='u'>type</a>(<a id='1186' tid='1187' class='u'>node2</a>)):

        <a id='1206' tid='1207' class='u'>fs1</a> = <a id='1210' tid='1211' class='c'>nodeFields</a>(<a id='1208' tid='1209' class='u'>node1</a>)
        <a id='1212' tid='1213' class='u'>fs2</a> = <a id='1216' tid='1217' class='c'>nodeFields</a>(<a id='1214' tid='1215' class='u'>node2</a>)
        <a id='1218' tid='1219' class='u'>changes</a>, <a id='1220' tid='1221' class='u'>cost</a> = <a id='1224' tid='1225' class='u'>nil</a>, <a id='1222' tid='1223' class='u'>0</a>

        for <a id='1226' tid='1227' class='u'>i</a> in <a id='1232' tid='1233' class='u'>xrange</a>(<a id='1230' tid='1231' class='u'>len</a>(<a id='1228' tid='1229' class='u'>fs1</a>)):
            (<a id='1234' tid='1235' class='u'>m</a>, <a id='1236' tid='1237' class='u'>c</a>) = <a id='1254' tid='1255' class='c'>diffNode</a>(<a id='1252' tid='1253' class='u'>fs1</a>[<a id='1250' tid='1251' class='u'>i</a>], <a id='1248' tid='1249' class='u'>fs2</a>[<a id='1246' tid='1247' class='u'>i</a>], <a id='1244' tid='1245' class='u'>env1</a>, <a id='1242' tid='1243' class='u'>env2</a>, <a id='1240' tid='1241' class='u'>depth</a>, <a id='1238' tid='1239' class='u'>move</a>)
            <a id='1256' tid='1257' class='u'>changes</a> = <a id='1262' tid='1263' class='u'>append</a>(<a id='1260' tid='1261' class='u'>m</a>, <a id='1258' tid='1259' class='u'>changes</a>)
            <a id='1264' tid='1265' class='u'>cost</a> <a id='1268' tid='1269' class='u'>+</a>= <a id='1266' tid='1267' class='u'>c</a>

        return <a id='1274' tid='1275' class='u'>trysub</a>((<a id='1272' tid='1273' class='u'>changes</a>, <a id='1270' tid='1271' class='u'>cost</a>))

    if (<a id='1292' tid='1293' class='u'>type</a>(<a id='1294' tid='1295' class='u'>node1</a>) <a id='1286' tid='1287' class='u'>==</a> <a id='1290' tid='1291' class='u'>type</a>(<a id='1288' tid='1289' class='u'>node2</a>) <a id='1276' tid='1277' class='u'>and</a>
             <a id='1284' tid='1285' class='c'>isEmptyContainer</a>(<a id='1282' tid='1283' class='u'>node1</a>) and <a id='1280' tid='1281' class='c'>isEmptyContainer</a>(<a id='1278' tid='1279' class='u'>node2</a>)):
        return (<a id='1304' tid='1305' class='c'>modifyNode</a>(<a id='1302' tid='1303' class='u'>node1</a>, <a id='1300' tid='1301' class='u'>node2</a>, <a id='1298' tid='1299' class='u'>0</a>), <a id='1296' tid='1297' class='u'>0</a>)

    # all unmatched types and unequal values
    return <a id='1326' tid='1327' class='u'>trysub</a>((<a id='1324' tid='1325' class='u'>append</a>(<a id='1322' tid='1323' class='c'>delNode</a>(<a id='1320' tid='1321' class='u'>node1</a>), <a id='1318' tid='1319' class='c'>insNode</a>(<a id='1316' tid='1317' class='u'>node2</a>)),
                   <a id='1312' tid='1313' class='c'>nodeSize</a>(<a id='1314' tid='1315' class='u'>node1</a>) <a id='1306' tid='1307' class='u'>+</a> <a id='1308' tid='1309' class='c'>nodeSize</a>(<a id='1310' tid='1311' class='u'>node2</a>)))</a>





###################### diff of a FunctionDef #####################

# separate out because it is too long

<span class='d'>def diffFunctionDef(node1, node2, env1, env2, depth, move):

    # positionals
    len1 = len(node1.args.args)
    len2 = len(node2.args.args)

    if len1 &lt; len2:
        minlen = len1
        rest = node2.args.args[minlen:]
    else:
        minlen = len2
        rest = node1.args.args[minlen:]

    ma = nil
    for i in xrange(minlen):
        a1 = node1.args.args[i]
        a2 = node2.args.args[i]
        if IS(a1, Name) and IS(a2, Name) and a1.id &lt;&gt; a2.id:
            env1 = ext(a1.id, a2, env1)
            env2 = ext(a2.id, a2, env2)
        (m1, c1) = diffNode(a1, a2, env1, env2, depth, move)
        ma = append(m1, ma)

    # handle rest of the positionals
    ca = 0
    if rest &lt;&gt; []:
        if len1 &lt; len2:
            for arg in rest:
                ma = append(insNode(arg), ma)
                ca += nodeSize(arg)
        else:
            for arg in rest:
                ma = append(delNode(arg), ma)
                ca += nodeSize(arg)

    # vararg
    va1 = node1.varargName
    va2 = node2.varargName
    if va1 &lt;&gt; None and va2 &lt;&gt; None:
        if va1.id &lt;&gt; va2.id:
            env1 = ext(va1.id, va2, env1)
            env2 = ext(va2.id, va2, env2)
        cost = strDist(va1.id, va2.id)
        ma = append(modifyNode(va1, va2, cost), ma)
        ca += cost
    elif va1 &lt;&gt; None or va2 &lt;&gt; None:
        cost = nodeSize(va1) if va1 &lt;&gt; None else nodeSize(va2)
        ma = append(modifyNode(va1, va2, cost), ma)
        ca += cost

    # kwarg
    ka1 = node1.kwargName
    ka2 = node2.kwargName
    if ka1 &lt;&gt; None and ka2 &lt;&gt; None:
        if ka1.id &lt;&gt; ka2.id:
            env1 = ext(ka1.id, ka2, env1)
            env2 = ext(ka2.id, ka2, env2)
        cost = strDist(ka1.id, ka2.id)
        ma = append(modifyNode(ka1, ka2, cost), ma)
        ca += cost
    elif ka1 &lt;&gt; None or ka2 &lt;&gt; None:
        cost = nodeSize(ka1) if ka1 &lt;&gt; None else nodeSize(ka2)
        ma = append(modifyNode(ka1, ka2, cost), ma)
        ca += cost

    # defaults and body
    (md, cd) = diffNode(node1.args.defaults, node2.args.defaults,
                        env1, env2, depth, move)
    (mb, cb) = diffNode(node1.body, node2.body, env1, env2, depth, move)

    # sum up cost. penalize functions with different names.
    cost = ca + cd + cb + strDist(node1.name, node2.name)
    if node1.name &lt;&gt; node2.name:
        cost = cost * NAME_PENALTY

    return (append(ma, md, mb), cost</span>)





########################## diff of a list ##########################

# diffList is the main part of dynamic programming

<a id='1764' tid='1765' class='c'>def <a id='1762' tid='1763' class='c'>diffList</a>(<a id='1344' tid='1345' class='u'>table</a>, <a id='1342' tid='1343' class='u'>ls1</a>, <a id='1340' tid='1341' class='u'>ls2</a>, <a id='1338' tid='1339' class='u'>env1</a>, <a id='1336' tid='1337' class='u'>env2</a>, <a id='1334' tid='1335' class='u'>depth</a>, <a id='1332' tid='1333' class='u'>move</a>):

    <a id='1366' tid='1367' class='u'>def <a id='1364' tid='1365' class='u'>memo</a>(<a id='1346' tid='1347' class='u'>v</a>):
        <a id='1360' tid='1361' class='u'>tablePut</a>(<a id='1358' tid='1359' class='u'>table</a>, <a id='1356' tid='1357' class='u'>len</a>(<a id='1354' tid='1355' class='u'>ls1</a>), <a id='1352' tid='1353' class='u'>len</a>(<a id='1350' tid='1351' class='u'>ls2</a>), <a id='1348' tid='1349' class='u'>v</a>)
        return <a id='1362' tid='1363' class='u'>v</a></a>

    <a id='1642' tid='1643' class='c'>def <a id='1640' tid='1641' class='u'>guess</a>(<a id='1376' tid='1377' class='u'>table</a>, <a id='1374' tid='1375' class='u'>ls1</a>, <a id='1372' tid='1373' class='u'>ls2</a>, <a id='1370' tid='1371' class='u'>env1</a>, <a id='1368' tid='1369' class='u'>env2</a>):
        (<a id='1378' tid='1379' class='u'>m0</a>, <a id='1380' tid='1381' class='u'>c0</a>) = <a id='1398' tid='1399' class='c'>diffNode</a>(<a id='1396' tid='1397' class='u'>ls1</a>[<a id='1394' tid='1395' class='u'>0</a>], <a id='1392' tid='1393' class='u'>ls2</a>[<a id='1390' tid='1391' class='u'>0</a>], <a id='1388' tid='1389' class='u'>env1</a>, <a id='1386' tid='1387' class='u'>env2</a>, <a id='1384' tid='1385' class='u'>depth</a>, <a id='1382' tid='1383' class='u'>move</a>)
        (<a id='1400' tid='1401' class='u'>m1</a>, <a id='1402' tid='1403' class='u'>c1</a>) = <a id='1422' tid='1423' class='c'>diffList</a>(<a id='1420' tid='1421' class='u'>table</a>, <a id='1418' tid='1419' class='u'>ls1</a>[<a id='1416' tid='1417' class='u'>1</a>:], <a id='1414' tid='1415' class='u'>ls2</a>[<a id='1412' tid='1413' class='u'>1</a>:], <a id='1410' tid='1411' class='u'>env1</a>, <a id='1408' tid='1409' class='u'>env2</a>, <a id='1406' tid='1407' class='u'>depth</a>, <a id='1404' tid='1405' class='u'>move</a>)
        <a id='1424' tid='1425' class='u'>cost1</a> = <a id='1430' tid='1431' class='u'>c1</a> <a id='1426' tid='1427' class='u'>+</a> <a id='1428' tid='1429' class='u'>c0</a>

        if ((<a id='1464' tid='1465' class='c'>isFrame</a>(<a id='1462' tid='1463' class='u'>ls1</a>[<a id='1460' tid='1461' class='u'>0</a>]) <a id='1432' tid='1433' class='u'>and</a>
             <a id='1458' tid='1459' class='c'>isFrame</a>(<a id='1456' tid='1457' class='u'>ls2</a>[<a id='1454' tid='1455' class='u'>0</a>]) and
             <a id='1444' tid='1445' class='u'>not</a> <a id='1446' tid='1447' class='u'>nodeFramed</a>(<a id='1448' tid='1449' class='u'>ls1</a>[<a id='1450' tid='1451' class='u'>0</a>], <a id='1452' tid='1453' class='u'>m0</a>) and
             <a id='1434' tid='1435' class='u'>not</a> <a id='1436' tid='1437' class='u'>nodeFramed</a>(<a id='1438' tid='1439' class='u'>ls2</a>[<a id='1440' tid='1441' class='u'>0</a>], <a id='1442' tid='1443' class='u'>m0</a>))):
            <a id='1466' tid='1467' class='c'>frameChange</a> = <a id='1478' tid='1479' class='c'>modifyNode</a>(<a id='1476' tid='1477' class='u'>ls1</a>[<a id='1474' tid='1475' class='u'>0</a>], <a id='1472' tid='1473' class='u'>ls2</a>[<a id='1470' tid='1471' class='u'>0</a>], <a id='1468' tid='1469' class='u'>c0</a>)
        else:
            <a id='1480' tid='1481' class='c'>frameChange</a> = <a id='1482' tid='1483' class='u'>nil</a>

        # short cut 1 (func and classes with same names)
        if <a id='1494' tid='1495' class='c'>canMove</a>(<a id='1492' tid='1493' class='u'>ls1</a>[<a id='1490' tid='1491' class='u'>0</a>], <a id='1488' tid='1489' class='u'>ls2</a>[<a id='1486' tid='1487' class='u'>0</a>], <a id='1484' tid='1485' class='u'>c0</a>):
            return (<a id='1504' tid='1505' class='u'>append</a>(<a id='1502' tid='1503' class='c'>frameChange</a>, <a id='1500' tid='1501' class='u'>m0</a>, <a id='1498' tid='1499' class='u'>m1</a>), <a id='1496' tid='1497' class='u'>cost1</a>)

        else:  # do more work
            (<a id='1506' tid='1507' class='u'>m2</a>, <a id='1508' tid='1509' class='u'>c2</a>) = <a id='1526' tid='1527' class='c'>diffList</a>(<a id='1524' tid='1525' class='u'>table</a>, <a id='1522' tid='1523' class='u'>ls1</a>[<a id='1520' tid='1521' class='u'>1</a>:], <a id='1518' tid='1519' class='u'>ls2</a>, <a id='1516' tid='1517' class='u'>env1</a>, <a id='1514' tid='1515' class='u'>env2</a>, <a id='1512' tid='1513' class='u'>depth</a>, <a id='1510' tid='1511' class='u'>move</a>)
            (<a id='1528' tid='1529' class='u'>m3</a>, <a id='1530' tid='1531' class='u'>c3</a>) = <a id='1548' tid='1549' class='c'>diffList</a>(<a id='1546' tid='1547' class='u'>table</a>, <a id='1544' tid='1545' class='u'>ls1</a>, <a id='1542' tid='1543' class='u'>ls2</a>[<a id='1540' tid='1541' class='u'>1</a>:], <a id='1538' tid='1539' class='u'>env1</a>, <a id='1536' tid='1537' class='u'>env2</a>, <a id='1534' tid='1535' class='u'>depth</a>, <a id='1532' tid='1533' class='u'>move</a>)
            <a id='1550' tid='1551' class='u'>cost2</a> = <a id='1560' tid='1561' class='u'>c2</a> <a id='1552' tid='1553' class='u'>+</a> <a id='1554' tid='1555' class='c'>nodeSize</a>(<a id='1556' tid='1557' class='u'>ls1</a>[<a id='1558' tid='1559' class='u'>0</a>])
            <a id='1562' tid='1563' class='u'>cost3</a> = <a id='1572' tid='1573' class='u'>c3</a> <a id='1564' tid='1565' class='u'>+</a> <a id='1566' tid='1567' class='c'>nodeSize</a>(<a id='1568' tid='1569' class='u'>ls2</a>[<a id='1570' tid='1571' class='u'>0</a>])

            if (<a id='1588' tid='1589' class='u'>not</a> <a id='1590' tid='1591' class='c'>differentDef</a>(<a id='1592' tid='1593' class='u'>ls1</a>[<a id='1594' tid='1595' class='u'>0</a>], <a id='1596' tid='1597' class='u'>ls2</a>[<a id='1598' tid='1599' class='u'>0</a>]) <a id='1574' tid='1575' class='u'>and</a>
                <a id='1586' tid='1587' class='u'>cost1</a> <a id='1582' tid='1583' class='u'>&lt;=</a> <a id='1584' tid='1585' class='u'>cost2</a> and <a id='1580' tid='1581' class='u'>cost1</a> <a id='1576' tid='1577' class='u'>&lt;=</a> <a id='1578' tid='1579' class='u'>cost3</a>):
                return (<a id='1608' tid='1609' class='u'>append</a>(<a id='1606' tid='1607' class='c'>frameChange</a>, <a id='1604' tid='1605' class='u'>m0</a>, <a id='1602' tid='1603' class='u'>m1</a>), <a id='1600' tid='1601' class='u'>cost1</a>)
            elif (<a id='1614' tid='1615' class='u'>cost2</a> <a id='1610' tid='1611' class='u'>&lt;=</a> <a id='1612' tid='1613' class='u'>cost3</a>):
                return (<a id='1626' tid='1627' class='u'>append</a>(<a id='1624' tid='1625' class='c'>delNode</a>(<a id='1622' tid='1623' class='u'>ls1</a>[<a id='1620' tid='1621' class='u'>0</a>]), <a id='1618' tid='1619' class='u'>m2</a>), <a id='1616' tid='1617' class='u'>cost2</a>)
            else:
                return (<a id='1638' tid='1639' class='u'>append</a>(<a id='1636' tid='1637' class='c'>insNode</a>(<a id='1634' tid='1635' class='u'>ls2</a>[<a id='1632' tid='1633' class='u'>0</a>]), <a id='1630' tid='1631' class='u'>m3</a>), <a id='1628' tid='1629' class='u'>cost3</a></a>)

    # cache look up
    <a id='1644' tid='1645' class='u'>cached</a> = <a id='1656' tid='1657' class='u'>tableLookup</a>(<a id='1654' tid='1655' class='u'>table</a>, <a id='1652' tid='1653' class='u'>len</a>(<a id='1650' tid='1651' class='u'>ls1</a>), <a id='1648' tid='1649' class='u'>len</a>(<a id='1646' tid='1647' class='u'>ls2</a>))
    if (<a id='1662' tid='1663' class='u'>cached</a> <a id='1658' tid='1659' class='u'>&lt;&gt;</a> <a id='1660' tid='1661' class='u'>None</a>):
        return <a id='1664' tid='1665' class='u'>cached</a>

    if (<a id='1674' tid='1675' class='u'>ls1</a> <a id='1672' tid='1673' class='u'>==</a> [] <a id='1666' tid='1667' class='u'>and</a> <a id='1670' tid='1671' class='u'>ls2</a> <a id='1668' tid='1669' class='u'>==</a> []):
        return <a id='1680' tid='1681' class='u'>memo</a>((<a id='1678' tid='1679' class='u'>nil</a>, <a id='1676' tid='1677' class='u'>0</a>))

    elif (<a id='1690' tid='1691' class='u'>ls1</a> <a id='1688' tid='1689' class='u'>&lt;&gt;</a> [] <a id='1682' tid='1683' class='u'>and</a> <a id='1686' tid='1687' class='u'>ls2</a> <a id='1684' tid='1685' class='u'>&lt;&gt;</a> []):
        return <a id='1704' tid='1705' class='u'>memo</a>(<a id='1702' tid='1703' class='u'>guess</a>(<a id='1700' tid='1701' class='u'>table</a>, <a id='1698' tid='1699' class='u'>ls1</a>, <a id='1696' tid='1697' class='u'>ls2</a>, <a id='1694' tid='1695' class='u'>env1</a>, <a id='1692' tid='1693' class='u'>env2</a>))

    elif <a id='1708' tid='1709' class='u'>ls1</a> <a id='1706' tid='1707' class='u'>==</a> []:
        <a id='1710' tid='1711' class='u'>d</a> = <a id='1712' tid='1713' class='u'>nil</a>
        for <a id='1714' tid='1715' class='u'>n</a> in <a id='1716' tid='1717' class='u'>ls2</a>:
            <a id='1718' tid='1719' class='u'>d</a> = <a id='1726' tid='1727' class='u'>append</a>(<a id='1724' tid='1725' class='c'>insNode</a>(<a id='1722' tid='1723' class='u'>n</a>), <a id='1720' tid='1721' class='u'>d</a>)
        return <a id='1734' tid='1735' class='u'>memo</a>((<a id='1732' tid='1733' class='u'>d</a>, <a id='1730' tid='1731' class='c'>nodeSize</a>(<a id='1728' tid='1729' class='u'>ls2</a>)))

    else: # ls2 == []:
        <a id='1736' tid='1737' class='u'>d</a> = <a id='1738' tid='1739' class='u'>nil</a>
        for <a id='1740' tid='1741' class='u'>n</a> in <a id='1742' tid='1743' class='u'>ls1</a>:
            <a id='1744' tid='1745' class='u'>d</a> = <a id='1752' tid='1753' class='u'>append</a>(<a id='1750' tid='1751' class='c'>delNode</a>(<a id='1748' tid='1749' class='u'>n</a>), <a id='1746' tid='1747' class='u'>d</a>)
        return <a id='1760' tid='1761' class='u'>memo</a>((<a id='1758' tid='1759' class='u'>d</a>, <a id='1756' tid='1757' class='c'>nodeSize</a>(<a id='1754' tid='1755' class='u'>ls1</a>)))</a>




###################### diff into a subnode #######################

# Subnode diff is only used in the moving phase. There is no
# need to compare the substructure of two nodes in the first
# run, because they will be reconsidered if we just consider
# them to be complete deletion and insertions.

<a id='2070' tid='2071' class='c'>def <a id='2068' tid='2069' class='c'>diffSubNode</a>(<a id='1776' tid='1777' class='u'>node1</a>, <a id='1774' tid='1775' class='u'>node2</a>, <a id='1772' tid='1773' class='u'>env1</a>, <a id='1770' tid='1771' class='u'>env2</a>, <a id='1768' tid='1769' class='u'>depth</a>, <a id='1766' tid='1767' class='u'>move</a>):

    if (<a id='1800' tid='1801' class='u'>depth</a> <a id='1796' tid='1797' class='u'>&gt;=</a> <a id='1798' tid='1799' class='u'>FRAME_DEPTH</a> <a id='1778' tid='1779' class='u'>or</a>
        <a id='1792' tid='1793' class='c'>nodeSize</a>(<a id='1794' tid='1795' class='u'>node1</a>) <a id='1788' tid='1789' class='u'>&lt;</a> <a id='1790' tid='1791' class='u'>FRAME_SIZE</a> or
        <a id='1784' tid='1785' class='c'>nodeSize</a>(<a id='1786' tid='1787' class='u'>node2</a>) <a id='1780' tid='1781' class='u'>&lt;</a> <a id='1782' tid='1783' class='u'>FRAME_SIZE</a>):
        return <a id='1802' tid='1803' class='u'>None</a>

    if <a id='1816' tid='1817' class='c'>IS</a>(<a id='1814' tid='1815' class='u'>node1</a>, <a id='1812' tid='1813' class='u'>AST</a>) <a id='1804' tid='1805' class='u'>and</a> <a id='1810' tid='1811' class='c'>IS</a>(<a id='1808' tid='1809' class='u'>node2</a>, <a id='1806' tid='1807' class='u'>AST</a>):

        if <a id='1824' tid='1825' class='c'>nodeSize</a>(<a id='1826' tid='1827' class='u'>node1</a>) <a id='1818' tid='1819' class='u'>==</a> <a id='1822' tid='1823' class='c'>nodeSize</a>(<a id='1820' tid='1821' class='u'>node2</a>):
            return <a id='1828' tid='1829' class='u'>None</a>

        if <a id='1834' tid='1835' class='c'>IS</a>(<a id='1832' tid='1833' class='u'>node1</a>, <a id='1830' tid='1831' class='u'>Expr</a>):
            <a id='1836' tid='1837' class='u'>node1</a> = <a id='1838' tid='1839' class='u'>node1.value</a>

        if <a id='1844' tid='1845' class='c'>IS</a>(<a id='1842' tid='1843' class='u'>node2</a>, <a id='1840' tid='1841' class='u'>Expr</a>):
            <a id='1846' tid='1847' class='u'>node2</a> = <a id='1848' tid='1849' class='u'>node2.value</a>

        if (<a id='1856' tid='1857' class='c'>nodeSize</a>(<a id='1858' tid='1859' class='u'>node1</a>) <a id='1850' tid='1851' class='u'>&lt;</a> <a id='1854' tid='1855' class='c'>nodeSize</a>(<a id='1852' tid='1853' class='u'>node2</a>)):
            for <a id='1860' tid='1861' class='u'>f</a> in <a id='1864' tid='1865' class='c'>nodeFields</a>(<a id='1862' tid='1863' class='u'>node2</a>):
                (<a id='1866' tid='1867' class='u'>m0</a>, <a id='1868' tid='1869' class='u'>c0</a>) = <a id='1886' tid='1887' class='c'>diffNode</a>(<a id='1884' tid='1885' class='u'>node1</a>, <a id='1882' tid='1883' class='u'>f</a>, <a id='1880' tid='1881' class='u'>env1</a>, <a id='1878' tid='1879' class='u'>env2</a>, <a id='1876' tid='1877' class='u'>depth</a><a id='1872' tid='1873' class='u'>+</a><a id='1874' tid='1875' class='u'>1</a>, <a id='1870' tid='1871' class='u'>move</a>)
                if <a id='1894' tid='1895' class='c'>canMove</a>(<a id='1892' tid='1893' class='u'>node1</a>, <a id='1890' tid='1891' class='u'>f</a>, <a id='1888' tid='1889' class='u'>c0</a>):
                    if <a id='1896' tid='1897' class='u'>not</a> <a id='1898' tid='1899' class='c'>IS</a>(<a id='1900' tid='1901' class='u'>f</a>, <a id='1902' tid='1903' class='u'>list</a>):
                        <a id='1904' tid='1905' class='u'>m1</a> = <a id='1912' tid='1913' class='c'>modifyNode</a>(<a id='1910' tid='1911' class='u'>node1</a>, <a id='1908' tid='1909' class='u'>f</a>, <a id='1906' tid='1907' class='u'>c0</a>)
                    else:
                        <a id='1914' tid='1915' class='u'>m1</a> = <a id='1916' tid='1917' class='u'>nil</a>
                    <a id='1918' tid='1919' class='u'>framecost</a> = <a id='1926' tid='1927' class='c'>nodeSize</a>(<a id='1928' tid='1929' class='u'>node2</a>) <a id='1920' tid='1921' class='u'>-</a> <a id='1922' tid='1923' class='c'>nodeSize</a>(<a id='1924' tid='1925' class='u'>node1</a>)
                    <a id='1930' tid='1931' class='u'>m2</a> = <a id='1942' tid='1943' class='u'>loner</a>(<a id='1940' tid='1941' class='u'>Change</a>(<a id='1938' tid='1939' class='u'>None</a>, <a id='1936' tid='1937' class='u'>node2</a>, <a id='1934' tid='1935' class='u'>framecost</a>, <a id='1932' tid='1933' class='u'>True</a>))
                    return (<a id='1956' tid='1957' class='u'>append</a>(<a id='1954' tid='1955' class='u'>m2</a>, <a id='1952' tid='1953' class='u'>m1</a>, <a id='1950' tid='1951' class='u'>m0</a>), <a id='1948' tid='1949' class='u'>c0</a> <a id='1944' tid='1945' class='u'>+</a> <a id='1946' tid='1947' class='u'>framecost</a>)

        if (<a id='1964' tid='1965' class='c'>nodeSize</a>(<a id='1966' tid='1967' class='u'>node1</a>) <a id='1958' tid='1959' class='u'>&gt;</a> <a id='1962' tid='1963' class='c'>nodeSize</a>(<a id='1960' tid='1961' class='u'>node2</a>)):
            for <a id='1968' tid='1969' class='u'>f</a> in <a id='1972' tid='1973' class='c'>nodeFields</a>(<a id='1970' tid='1971' class='u'>node1</a>):
                (<a id='1974' tid='1975' class='u'>m0</a>, <a id='1976' tid='1977' class='u'>c0</a>) = <a id='1994' tid='1995' class='c'>diffNode</a>(<a id='1992' tid='1993' class='u'>f</a>, <a id='1990' tid='1991' class='u'>node2</a>, <a id='1988' tid='1989' class='u'>env1</a>, <a id='1986' tid='1987' class='u'>env2</a>, <a id='1984' tid='1985' class='u'>depth</a><a id='1980' tid='1981' class='u'>+</a><a id='1982' tid='1983' class='u'>1</a>, <a id='1978' tid='1979' class='u'>move</a>)
                if <a id='2002' tid='2003' class='c'>canMove</a>(<a id='2000' tid='2001' class='u'>f</a>, <a id='1998' tid='1999' class='u'>node2</a>, <a id='1996' tid='1997' class='u'>c0</a>):
                    <a id='2004' tid='2005' class='u'>framecost</a> = <a id='2012' tid='2013' class='c'>nodeSize</a>(<a id='2014' tid='2015' class='u'>node1</a>) <a id='2006' tid='2007' class='u'>-</a> <a id='2008' tid='2009' class='c'>nodeSize</a>(<a id='2010' tid='2011' class='u'>node2</a>)
                    if <a id='2016' tid='2017' class='u'>not</a> <a id='2018' tid='2019' class='c'>IS</a>(<a id='2020' tid='2021' class='u'>f</a>, <a id='2022' tid='2023' class='u'>list</a>):
                        <a id='2024' tid='2025' class='u'>m1</a> = <a id='2032' tid='2033' class='c'>modifyNode</a>(<a id='2030' tid='2031' class='u'>f</a>, <a id='2028' tid='2029' class='u'>node2</a>, <a id='2026' tid='2027' class='u'>c0</a>)
                    else:
                        <a id='2034' tid='2035' class='u'>m1</a> = <a id='2036' tid='2037' class='u'>nil</a>
                    <a id='2038' tid='2039' class='u'>m2</a> = <a id='2050' tid='2051' class='u'>loner</a>(<a id='2048' tid='2049' class='u'>Change</a>(<a id='2046' tid='2047' class='u'>node1</a>, <a id='2044' tid='2045' class='u'>None</a>, <a id='2042' tid='2043' class='u'>framecost</a>, <a id='2040' tid='2041' class='u'>True</a>))
                    return (<a id='2064' tid='2065' class='u'>append</a>(<a id='2062' tid='2063' class='u'>m2</a>, <a id='2060' tid='2061' class='u'>m1</a>, <a id='2058' tid='2059' class='u'>m0</a>), <a id='2056' tid='2057' class='u'>c0</a> <a id='2052' tid='2053' class='u'>+</a> <a id='2054' tid='2055' class='u'>framecost</a>)

    return <a id='2066' tid='2067' class='u'>None</a></a>





##########################################################################
##                          move detection
##########################################################################
<a id='2090' tid='2091' class='c'>def <a id='2088' tid='2089' class='c'>moveCandidate</a>(<a id='2072' tid='2073' class='u'>node</a>):
    return (<a id='2086' tid='2087' class='c'>isDef</a>(<a id='2084' tid='2085' class='u'>node</a>) <a id='2074' tid='2075' class='u'>or</a> <a id='2080' tid='2081' class='c'>nodeSize</a>(<a id='2082' tid='2083' class='u'>node</a>) <a id='2076' tid='2077' class='u'>&gt;=</a> <a id='2078' tid='2079' class='u'>MOVE_SIZE</a></a>)


<a id='2092' tid='2093' class='c'>stat.moveCount</a> = <a id='2094' tid='2095' class='u'>0</a>
<a id='2096' tid='2097' class='c'>stat.moveSavings</a> = <a id='2098' tid='2099' class='u'>0</a>
<a id='2374' tid='2375' class='c'>def <a id='2372' tid='2373' class='c'>getmoves</a>(<a id='2104' tid='2105' class='u'>ds</a>, <a id='2102' tid='2103' class='u'>round</a>=<a id='2100' tid='2101' class='u'>0</a>):

    <a id='2106' tid='2107' class='u'>dels</a> = <a id='2130' tid='2131' class='u'>pylist</a>(<a id='2128' tid='2129' class='u'>filterlist</a>(lambda <a id='2126' tid='2127' class='u'>p</a>: (<a id='2110' tid='2111' class='u'>p.cur</a> <a id='2114' tid='2115' class='u'>==</a> <a id='2112' tid='2113' class='u'>None</a> <a id='2124' tid='2125' class='u'>and</a>
                                        <a id='2116' tid='2117' class='c'>moveCandidate</a>(<a id='2118' tid='2119' class='u'>p.orig</a>) and
                                        <a id='2122' tid='2123' class='u'>not</a> <a id='2120' tid='2121' class='c'>p.isFrame</a>),
                             <a id='2108' tid='2109' class='u'>ds</a>))
    <a id='2132' tid='2133' class='u'>adds</a> = <a id='2156' tid='2157' class='u'>pylist</a>(<a id='2154' tid='2155' class='u'>filterlist</a>(lambda <a id='2152' tid='2153' class='u'>p</a>: (<a id='2136' tid='2137' class='u'>p.orig</a> <a id='2140' tid='2141' class='u'>==</a> <a id='2138' tid='2139' class='u'>None</a> <a id='2150' tid='2151' class='u'>and</a>
                                        <a id='2142' tid='2143' class='c'>moveCandidate</a>(<a id='2144' tid='2145' class='u'>p.cur</a>) and
                                        <a id='2148' tid='2149' class='u'>not</a> <a id='2146' tid='2147' class='c'>p.isFrame</a>),
                             <a id='2134' tid='2135' class='u'>ds</a>))

    # print &quot;dels=&quot;, dels
    # print &quot;adds=&quot;, adds

    <a id='2158' tid='2159' class='u'>matched</a> = []
    <a id='2160' tid='2161' class='u'>newChanges</a>, <a id='2162' tid='2163' class='u'>total</a> = <a id='2166' tid='2167' class='u'>nil</a>, <a id='2164' tid='2165' class='u'>0</a>

    print(<a id='2168' tid='2169' class='c'>&quot;\n[getmoves #%d] %d * %d = %d pairs of nodes to consider ...&quot;</a>
          <a id='2190' tid='2191' class='u'>%</a> (<a id='2188' tid='2189' class='u'>round</a>, <a id='2186' tid='2187' class='u'>len</a>(<a id='2184' tid='2185' class='u'>dels</a>), <a id='2182' tid='2183' class='u'>len</a>(<a id='2180' tid='2181' class='u'>adds</a>), <a id='2176' tid='2177' class='u'>len</a>(<a id='2178' tid='2179' class='u'>dels</a>) <a id='2170' tid='2171' class='u'>*</a> <a id='2172' tid='2173' class='u'>len</a>(<a id='2174' tid='2175' class='u'>adds</a>)))

    for <a id='2192' tid='2193' class='u'>d0</a> in <a id='2194' tid='2195' class='u'>dels</a>:
        for <a id='2196' tid='2197' class='u'>a0</a> in <a id='2198' tid='2199' class='u'>adds</a>:
            (<a id='2200' tid='2201' class='u'>node1</a>, <a id='2202' tid='2203' class='u'>node2</a>) = (<a id='2206' tid='2207' class='u'>d0.orig</a>, <a id='2204' tid='2205' class='u'>a0.cur</a>)
            (<a id='2208' tid='2209' class='u'>changes</a>, <a id='2210' tid='2211' class='u'>cost</a>) = <a id='2224' tid='2225' class='c'>diffNode</a>(<a id='2222' tid='2223' class='u'>node1</a>, <a id='2220' tid='2221' class='u'>node2</a>, <a id='2218' tid='2219' class='u'>nil</a>, <a id='2216' tid='2217' class='u'>nil</a>, <a id='2214' tid='2215' class='u'>0</a>, <a id='2212' tid='2213' class='u'>True</a>)
            <a id='2226' tid='2227' class='u'>nterms</a> = <a id='2234' tid='2235' class='c'>nodeSize</a>(<a id='2236' tid='2237' class='u'>node1</a>) <a id='2228' tid='2229' class='u'>+</a> <a id='2230' tid='2231' class='c'>nodeSize</a>(<a id='2232' tid='2233' class='u'>node2</a>)

            if (<a id='2258' tid='2259' class='c'>canMove</a>(<a id='2256' tid='2257' class='u'>node1</a>, <a id='2254' tid='2255' class='u'>node2</a>, <a id='2252' tid='2253' class='u'>cost</a>) <a id='2238' tid='2239' class='u'>or</a>
                <a id='2250' tid='2251' class='u'>nodeFramed</a>(<a id='2248' tid='2249' class='u'>node1</a>, <a id='2246' tid='2247' class='u'>changes</a>) or
                <a id='2244' tid='2245' class='u'>nodeFramed</a>(<a id='2242' tid='2243' class='u'>node2</a>, <a id='2240' tid='2241' class='u'>changes</a>)):

                <a id='2262' tid='2263' class='u'>matched.append</a>(<a id='2260' tid='2261' class='u'>d0</a>)
                <a id='2266' tid='2267' class='u'>matched.append</a>(<a id='2264' tid='2265' class='u'>a0</a>)
                <a id='2270' tid='2271' class='u'>adds.remove</a>(<a id='2268' tid='2269' class='u'>a0</a>)
                <a id='2272' tid='2273' class='u'>newChanges</a> = <a id='2278' tid='2279' class='u'>append</a>(<a id='2276' tid='2277' class='u'>changes</a>, <a id='2274' tid='2275' class='u'>newChanges</a>)
                <a id='2280' tid='2281' class='u'>total</a> <a id='2284' tid='2285' class='u'>+</a>= <a id='2282' tid='2283' class='u'>cost</a>

                if (<a id='2304' tid='2305' class='u'>not</a> <a id='2306' tid='2307' class='u'>nodeFramed</a>(<a id='2308' tid='2309' class='u'>node1</a>, <a id='2310' tid='2311' class='u'>changes</a>) <a id='2286' tid='2287' class='u'>and</a>
                    <a id='2296' tid='2297' class='u'>not</a> <a id='2298' tid='2299' class='u'>nodeFramed</a>(<a id='2300' tid='2301' class='u'>node2</a>, <a id='2302' tid='2303' class='u'>changes</a>) and
                    <a id='2294' tid='2295' class='c'>isDef</a>(<a id='2292' tid='2293' class='u'>node1</a>) and <a id='2290' tid='2291' class='c'>isDef</a>(<a id='2288' tid='2289' class='u'>node2</a>)):
                    <a id='2312' tid='2313' class='u'>newChanges</a> = <a id='2324' tid='2325' class='u'>append</a>(<a id='2322' tid='2323' class='c'>modifyNode</a>(<a id='2320' tid='2321' class='u'>node1</a>, <a id='2318' tid='2319' class='u'>node2</a>, <a id='2316' tid='2317' class='u'>cost</a>),
                                        <a id='2314' tid='2315' class='u'>newChanges</a>)

                <a id='2326' tid='2327' class='c'>stat.moveSavings</a> <a id='2330' tid='2331' class='u'>+</a>= <a id='2328' tid='2329' class='u'>nterms</a>
                <a id='2332' tid='2333' class='c'>stat.moveCount</a> <a id='2336' tid='2337' class='u'>+</a>=<a id='2334' tid='2335' class='u'>1</a>
                if <a id='2342' tid='2343' class='c'>stat.moveCount</a> <a id='2346' tid='2347' class='u'>%</a> <a id='2344' tid='2345' class='u'>1000</a> <a id='2338' tid='2339' class='u'>==</a> <a id='2340' tid='2341' class='u'>0</a>:
                    <a id='2348' tid='2349' class='u'>dot</a>()

                break

    print(<a id='2350' tid='2351' class='u'>&quot;\n\t%d matched pairs found with %d new changes.&quot;</a>
          <a id='2364' tid='2365' class='u'>%</a> (<a id='2362' tid='2363' class='u'>len</a>(<a id='2360' tid='2361' class='u'>pylist</a>(<a id='2358' tid='2359' class='u'>matched</a>)), <a id='2356' tid='2357' class='u'>len</a>(<a id='2354' tid='2355' class='u'>pylist</a>(<a id='2352' tid='2353' class='u'>newChanges</a>))))

    # print &quot;matches=&quot;, matched
    # print &quot;newChanges=&quot;, newChanges

    return (<a id='2370' tid='2371' class='u'>matched</a>, <a id='2368' tid='2369' class='u'>newChanges</a>, <a id='2366' tid='2367' class='u'>total</a></a>)



# Get moves repeatedly because new moves may introduce new
# deletions and insertions.

<a id='2482' tid='2483' class='c'>def <a id='2480' tid='2481' class='c'>closure</a>(<a id='2376' tid='2377' class='u'>res</a>):
    (<a id='2378' tid='2379' class='u'>changes</a>, <a id='2380' tid='2381' class='u'>cost</a>) = <a id='2382' tid='2383' class='u'>res</a>
    <a id='2384' tid='2385' class='u'>matched</a> = <a id='2386' tid='2387' class='u'>None</a>
    <a id='2388' tid='2389' class='u'>moveround</a> = <a id='2390' tid='2391' class='u'>1</a>

    while <a id='2402' tid='2403' class='u'>moveround</a> <a id='2398' tid='2399' class='u'>&lt;=</a> <a id='2400' tid='2401' class='u'>MOVE_ROUND</a> <a id='2392' tid='2393' class='u'>and</a> <a id='2396' tid='2397' class='u'>matched</a> <a id='2394' tid='2395' class='u'>&lt;&gt;</a> []:
        (<a id='2404' tid='2405' class='u'>matched</a>, <a id='2406' tid='2407' class='u'>newChanges</a>, <a id='2408' tid='2409' class='u'>c</a>) = <a id='2414' tid='2415' class='c'>getmoves</a>(<a id='2412' tid='2413' class='u'>changes</a>, <a id='2410' tid='2411' class='u'>moveround</a>)
        <a id='2416' tid='2417' class='u'>moveround</a> <a id='2420' tid='2421' class='u'>+</a>= <a id='2418' tid='2419' class='u'>1</a>
        # print &quot;matched:&quot;, matched
        # print &quot;changes:&quot;, changes
        <a id='2422' tid='2423' class='u'>changes</a> = <a id='2434' tid='2435' class='u'>filterlist</a>(lambda <a id='2432' tid='2433' class='u'>c</a>: <a id='2426' tid='2427' class='u'>c</a> <a id='2430' tid='2431' class='u'>not in</a> <a id='2428' tid='2429' class='u'>matched</a>, <a id='2424' tid='2425' class='u'>changes</a>)
        <a id='2436' tid='2437' class='u'>changes</a> = <a id='2442' tid='2443' class='u'>append</a>(<a id='2440' tid='2441' class='u'>newChanges</a>, <a id='2438' tid='2439' class='u'>changes</a>)
        <a id='2444' tid='2445' class='u'>savings</a> = <a id='2462' tid='2463' class='u'>sum</a>(<a id='2460' tid='2461' class='u'>map</a>(lambda <a id='2458' tid='2459' class='u'>p</a>: <a id='2450' tid='2451' class='c'>nodeSize</a>(<a id='2448' tid='2449' class='u'>p.orig</a>) <a id='2456' tid='2457' class='u'>+</a> <a id='2454' tid='2455' class='c'>nodeSize</a>(<a id='2452' tid='2453' class='u'>p.cur</a>), <a id='2446' tid='2447' class='u'>matched</a>))
        <a id='2464' tid='2465' class='u'>cost</a> = <a id='2470' tid='2471' class='u'>cost</a> <a id='2474' tid='2475' class='u'>+</a> <a id='2472' tid='2473' class='u'>c</a> <a id='2466' tid='2467' class='u'>-</a> <a id='2468' tid='2469' class='u'>savings</a>
    return (<a id='2478' tid='2479' class='u'>changes</a>, <a id='2476' tid='2477' class='u'>cost</a></a>)





#-------------------------------------------------------------
#                   improvements to the AST
#-------------------------------------------------------------

<span class='d'>allNodes1 = set()</span>
<span class='d'>allNodes2 = set()</span>

<span class='d'>def improveNode(node, s, idxmap, filename, side):

    if IS(node, list):
        for n in node:
            improveNode(n, s, idxmap, filename, side)

    elif IS(node, AST):

        if side == &#39;left&#39;:
            allNodes1.add(node)
        else:
            allNodes2.add(node)

        findNodeStart(node, s, idxmap)
        findNodeEnd(node, s, idxmap)
        addMissingNames(node, s, idxmap)

        node.nodeSource = s
        node.fileName = filename

        for f in nodeFields(node):
            improveNode(f, s, idxmap, filename, side)</span>



<span class='d'>def improveAST(node, s, filename, side):
    idxmap = buildIndexMap(s)
    improveNode(node, s, idxmap, filename, side)</span>




#-------------------------------------------------------------
#            finding start and end index of nodes
#-------------------------------------------------------------

<span class='d'>def findNodeStart(node, s, idxmap):

    if hasattr(node, &#39;nodeStart&#39;):
        return node.nodeStart

    elif IS(node, list):
        ret = findNodeStart(node[0], s, idxmap)

    elif IS(node, Module):
        ret = findNodeStart(node.body[0], s, idxmap)

    elif IS(node, BinOp):
        leftstart = findNodeStart(node.left, s, idxmap)
        if leftstart &lt;&gt; None:
            ret = leftstart
        else:
            ret = mapIdx(idxmap, node.lineno, node.col_offset)

    elif hasattr(node, &#39;lineno&#39;):
        if node.col_offset &gt;= 0:
            ret = mapIdx(idxmap, node.lineno, node.col_offset)
        else:                           # special case for &quot;&quot;&quot; strings
            i = mapIdx(idxmap, node.lineno, node.col_offset)
            while i &gt; 0 and i+2 &lt; len(s) and s[i:i+3] &lt;&gt; &#39;&quot;&quot;&quot;&#39;:
                i -= 1
            ret = i
    else:
        ret = None

    if ret == None and hasattr(node, &#39;lineno&#39;):
        raise TypeError(&quot;got None for node that has lineno&quot;, node)

    if IS(node, AST) and ret &lt;&gt; None:
        node.nodeStart = ret

    return ret</span>




<span class='d'>def findNodeEnd(node, s, idxmap):

    if hasattr(node, &#39;nodeEnd&#39;):
        return node.nodeEnd

    elif IS(node, list):
        ret = findNodeEnd(node[-1], s, idxmap)

    elif IS(node, Module):
        ret = findNodeEnd(node.body[-1], s, idxmap)

    elif IS(node, Expr):
        ret = findNodeEnd(node.value, s, idxmap)

    elif IS(node, Str):
        i = findNodeStart(node, s, idxmap)
        if i+2 &lt; len(s) and s[i:i+3] == &#39;&quot;&quot;&quot;&#39;:
            q = &#39;&quot;&quot;&quot;&#39;
            i += 3
        elif s[i] == &#39;&quot;&#39;:
            q = &#39;&quot;&#39;
            i += 1
        elif s[i] == &quot;&#39;&quot;:
            q = &quot;&#39;&quot;
            i += 1
        else:
            print &quot;illegal:&quot;, i, s[i]
        ret = endSeq(s, q, i)

    elif IS(node, Name):
        ret = findNodeStart(node, s, idxmap) + len(node.id)

    elif IS(node, Attribute):
        ret = endSeq(s, node.attr, findNodeEnd(node.value, s, idxmap))

    elif IS(node, FunctionDef):
        # addMissingNames(node, s, idxmap)
        # ret = findNodeEnd(node.nameName, s, idxmap)
        ret = findNodeEnd(node.body, s, idxmap)

    elif IS(node, Lambda):
        ret = findNodeEnd(node.body, s, idxmap)

    elif IS(node, ClassDef):
        # addMissingNames(node, s, idxmap)
        # ret = findNodeEnd(node.nameName, s, idxmap)
        ret = findNodeEnd(node.body, s, idxmap)

    elif IS(node, Call):
        ret = matchParen(s, &#39;(&#39;, &#39;)&#39;, findNodeEnd(node.func, s, idxmap))

    elif IS(node, Yield):
        ret = findNodeEnd(node.value, s, idxmap)

    elif IS(node, Return):
        if node.value &lt;&gt; None:
            ret = findNodeEnd(node.value, s, idxmap)
        else:
            ret = findNodeStart(node, s, idxmap) + len(&#39;return&#39;)

    elif IS(node, Print):
        ret = startSeq(s, &#39;\n&#39;, findNodeStart(node, s, idxmap))

    elif (IS(node, For) or
          IS(node, While) or
          IS(node, If) or
          IS(node, IfExp)):
        if node.orelse &lt;&gt; []:
            ret = findNodeEnd(node.orelse, s, idxmap)
        else:
            ret = findNodeEnd(node.body, s, idxmap)

    elif IS(node, Assign) or IS(node, AugAssign):
        ret = findNodeEnd(node.value, s, idxmap)

    elif IS(node, BinOp):
        ret = findNodeEnd(node.right, s, idxmap)

    elif IS(node, BoolOp):
        ret = findNodeEnd(node.values[-1], s, idxmap)

    elif IS(node, Compare):
        ret = findNodeEnd(node.comparators[-1], s, idxmap)

    elif IS(node, UnaryOp):
        ret = findNodeEnd(node.operand, s, idxmap)

    elif IS(node, Num):
        ret = findNodeStart(node, s, idxmap) + len(str(node.n))

    elif IS(node, List):
        ret = matchParen(s, &#39;[&#39;, &#39;]&#39;, findNodeStart(node, s, idxmap));

    elif IS(node, Subscript):
        ret = matchParen(s, &#39;[&#39;, &#39;]&#39;, findNodeStart(node, s, idxmap));

    elif IS(node, Tuple):
        ret = findNodeEnd(node.elts[-1], s, idxmap)

    elif IS(node, Dict):
        ret = matchParen(s, &#39;{&#39;, &#39;}&#39;, findNodeStart(node, s, idxmap));

    elif IS(node, TryExcept):
        if node.orelse &lt;&gt; []:
            ret = findNodeEnd(node.orelse, s, idxmap)
        elif node.handlers &lt;&gt; []:
            ret = findNodeEnd(node.handlers, s, idxmap)
        else:
            ret = findNodeEnd(node.body, s, idxmap)

    elif IS(node, ExceptHandler):
        ret = findNodeEnd(node.body, s, idxmap)

    elif IS(node, Pass):
        ret = findNodeStart(node, s, idxmap) + len(&#39;pass&#39;)

    elif IS(node, Break):
        ret = findNodeStart(node, s, idxmap) + len(&#39;break&#39;)

    elif IS(node, Continue):
        ret = findNodeStart(node, s, idxmap) + len(&#39;continue&#39;)

    elif IS(node, Global):
        ret = startSeq(s, &#39;\n&#39;, findNodeStart(node, s, idxmap))

    elif IS(node, Import):
        ret = findNodeStart(node, s, idxmap) + len(&#39;import&#39;)

    elif IS(node, ImportFrom):
        ret = findNodeStart(node, s, idxmap) + len(&#39;from&#39;)

    else:
        # print &quot;[findNodeEnd] unrecognized node:&quot;, node, &quot;type:&quot;, type(node)
        start = findNodeStart(node, s, idxmap)
        if start &lt;&gt; None:
            ret = start + 3
        else:
            ret = None

    if ret == None and hasattr(node, &#39;lineno&#39;):
        raise TypeError(&quot;got None for node that has lineno&quot;, node)

    if IS(node, AST) and ret &lt;&gt; None:
        node.nodeEnd = ret

    return ret</span>




#-------------------------------------------------------------
#                    adding missing Names
#-------------------------------------------------------------

<span class='d'>def addMissingNames(node, s, idxmap):

    if hasattr(node, &#39;extraAttribute&#39;):
        return

    if IS(node, list):
        for n in node:
            addMissingNames(n, s, idxmap)

    elif IS(node, ClassDef):
        start = findNodeStart(node, s, idxmap) + len(&#39;class&#39;)
        node.nameName = str2Name(s, start, idxmap)
        node._fields += (&#39;nameName&#39;,)

    elif IS(node, FunctionDef):
        start = findNodeStart(node, s, idxmap) + len(&#39;def&#39;)
        node.nameName = str2Name(s, start, idxmap)
        node._fields += (&#39;nameName&#39;,)

        if node.args.vararg &lt;&gt; None:
            if len(node.args.args) &gt; 0:
                vstart = findNodeEnd(node.args.args[-1], s, idxmap)
            else:
                vstart = findNodeEnd(node.nameName, s, idxmap)
            vname = str2Name(s, vstart, idxmap)
            node.varargName = vname
        else:
            node.varargName = None
        node._fields += (&#39;varargName&#39;,)

        if node.args.kwarg &lt;&gt; None:
            if len(node.args.args) &gt; 0:
                kstart = findNodeEnd(node.args.args[-1], s, idxmap)
            else:
                kstart = findNodeEnd(node.varargName, s, idxmap)
            kname = str2Name(s, kstart, idxmap)
            node.kwargName = kname
        else:
            node.kwargName = None
        node._fields += (&#39;kwargName&#39;,)

    elif IS(node, Attribute):
        start = findNodeEnd(node.value, s, idxmap)
        name = str2Name(s, start, idxmap)
        node.attrName = name
        node._fields = (&#39;value&#39;, &#39;attrName&#39;)  # remove attr for node size accuracy

    elif IS(node, Compare):
        node.opsName = convertOps(node.ops, s,
                                  findNodeStart(node, s, idxmap), idxmap)
        node._fields += (&#39;opsName&#39;,)

    elif (IS(node, BoolOp) or
          IS(node, BinOp) or
          IS(node, UnaryOp) or
          IS(node, AugAssign)):
        if hasattr(node, &#39;left&#39;):
            start = findNodeEnd(node.left, s, idxmap)
        else:
            start = findNodeStart(node, s, idxmap)
        ops = convertOps([node.op], s, start, idxmap)
        node.opName = ops[0]
        node._fields += (&#39;opName&#39;,)

    elif IS(node, Import):
        nameNames = []
        next = findNodeStart(node, s, idxmap) + len(&#39;import&#39;)
        name = str2Name(s, next, idxmap)
        while name &lt;&gt; None and next &lt; len(s) and s[next] &lt;&gt; &#39;\n&#39;:
            nameNames.append(name)
            next = name.nodeEnd
            name = str2Name(s, next, idxmap)
        node.nameNames = nameNames
        node._fields += (&#39;nameNames&#39;,)

    node.extraAttribute = True</span>



#-------------------------------------------------------------
#              utilities used by improve AST functions
#-------------------------------------------------------------

# find a sequence in a string s, returning the start point
<span class='d'>def startSeq(s, pat, start):
    try:
        return s.index(pat, start)
    except ValueError:
        return len(s)</span>



# find a sequence in a string s, returning the end point
<span class='d'>def endSeq(s, pat, start):
    try:
        return s.index(pat, start) + len(pat)
    except ValueError:
        return len(s)</span>



# find matching close paren from start
<span class='d'>def matchParen(s, open, close, start):
    while s[start] &lt;&gt; open and start &lt; len(s):
        start += 1
    if start &gt;= len(s):
        return len(s)

    left = 1
    i = start + 1
    while left &gt; 0 and i &lt; len(s):
        if s[i] == open:
            left += 1
        elif s[i] == close:
            left -= 1
        i += 1
    return i</span>



# build table for lineno &lt;-&gt; index oonversion
<span class='d'>def buildIndexMap(s):
    line = 0
    col = 0
    idx = 0
    idxmap = [0]
    while idx &lt; len(s):
        if s[idx] == &#39;\n&#39;:
            idxmap.append(idx + 1)
            line += 1
        idx += 1
    return idxmap</span>



# convert (line, col) to offset index
<span class='d'>def mapIdx(idxmap, line, col):
    return idxmap[line-1] + col</span>



# convert offset index into (line, col)
<span class='d'>def mapLineCol(idxmap, idx):
    line = 0
    for start in idxmap:
        if idx &lt; start:
            break
        line += 1
    col = idx - idxmap[line-1]
    return (line, col</span>)



# convert string to Name
<span class='d'>def str2Name(s, start, idxmap):
    i = start;
    while i &lt; len(s) and not isAlpha(s[i]):
        i += 1
    startIdx = i
    ret = []
    while i &lt; len(s) and isAlpha(s[i]):
        ret.append(s[i])
        i += 1
    endIdx = i
    id1 = &#39;&#39;.join(ret)

    if id1 == &#39;&#39;:
        return None
    else:
        name = Name(id1, None)
        name.nodeStart = startIdx
        name.nodeEnd = endIdx
        name.lineno, name.col_offset = mapLineCol(idxmap, startIdx)
        return name</span>



<span class='d'>def convertOps(ops, s, start, idxmap):
    syms = map(lambda op: opsMap[type(op)], ops)
    i = start
    j = 0
    ret = []
    while i &lt; len(s) and j &lt; len(syms):
        oplen = len(syms[j])
        if s[i:i+oplen] == syms[j]:
            opName = Name(syms[j], None)
            opName.nodeStart = i
            opName.nodeEnd = i+oplen
            opName.lineno, opName.col_offset = mapLineCol(idxmap, i)
            ret.append(opName)
            j += 1
            i = opName.nodeEnd
        else:
            i += 1
    return ret</span>


# lookup table for operators for convertOps
<span class='d'>opsMap = {
    # compare:
    Eq     : &#39;==&#39;,
    NotEq  : &#39;&lt;&gt;&#39;,
    Lt     : &#39;&lt;&#39;,
    LtE    : &#39;&lt;=&#39;,
    Gt     : &#39;&gt;&#39;,
    GtE    : &#39;&gt;=&#39;,
    In     : &#39;in&#39;,
    NotIn  : &#39;not in&#39;,

    # BoolOp
    Or  : &#39;or&#39;,
    And : &#39;and&#39;,
    Not : &#39;not&#39;,

    # BinOp
    Add  : &#39;+&#39;,
    Sub  : &#39;-&#39;,
    Mult : &#39;*&#39;,
    Div  : &#39;/&#39;,
    Mod  : &#39;%&#39;,

    # UnaryOp
    USub : &#39;-&#39;,
    UAdd : &#39;+&#39;,
}</span>






#-------------------------------------------------------------
#                        HTML generation
#-------------------------------------------------------------


#-------------------- types and utilities ----------------------

<span class='d'>class Tag:
    def __init__(self, tag, idx, start=-1):
        self.tag = tag
        self.idx = idx
        self.start = start
    def __repr__(self):
        return &quot;tag:&quot; + str(self.tag) + &quot;:&quot; + str(self.idx)</span>



# escape for HTML
<span class='d'>def escape(s):
    s = s.replace(&#39;&quot;&#39;, &#39;&quot;&#39;)
    s = s.replace(&quot;&#39;&quot;, &#39;&#39;&#39;)
    s = s.replace(&quot;&lt;&quot;, &#39;&lt;&#39;)
    s = s.replace(&quot;&gt;&quot;, &#39;&gt;&#39;)
    return s</span>



<span class='d'>uidCount = -1
</span><span class='d'>uidHash = {}</span>
<span class='d'>def clearUID():
    global uidCount, uidHash
    uidCount = -1
    uidHash = {}</span>


<span class='d'>def uid(node):
    if uidHash.has_key(node):
        return uidHash[node]

    global uidCount
    uidCount += 1
    uidHash[node] = str(uidCount)
    return str(uidCount)</span>



<span class='d'>def lineId(lineno):
    return &#39;L&#39; + str(lineno)</span>;


<span class='d'>def qs(s):
    return &quot;&#39;&quot; + s + &quot;&#39;&quot;</span>



#-------------------- main HTML generating function ------------------

<span class='d'>def genHTML(text, changes, side):
    ltags = lineTags(text)
    ctags = changeTags(text, changes, side)
    ktags = keywordTags(side)
    body = applyTags(text, ltags + ctags + ktags, side)

    out = []
    out.append(&#39;&lt;html&gt;\n&#39;)
    out.append(&#39;&lt;head&gt;\n&#39;)
    out.append(&#39;&lt;META http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=utf-8&quot;&gt;\n&#39;)
    out.append(&#39;&lt;LINK href=&quot;diff.css&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot;&gt;\n&#39;)
    out.append(&#39;&lt;script type=&quot;text/javascript&quot; src=&quot;nav.js&quot;&gt;&lt;/script&gt;\n&#39;)
    out.append(&#39;&lt;/head&gt;\n&#39;)
    out.append(&#39;&lt;body&gt;\n&#39;)

    out.append(&#39;&lt;pre&gt;\n&#39;)
    out.append(body)
    out.append(&#39;&lt;/pre&gt;\n&#39;)

    # out.append(&#39;&lt;/body&gt;\n&#39;)
    # out.append(&#39;&lt;/html&gt;\n&#39;)

    return &#39;&#39;.join(out)</span>



# put the tags generated by changeTags into the text and create HTML
<span class='d'>def applyTags(s, tags, side):
    tags = sorted(tags, key = lambda t: (t.idx, -t.start))
    curr = 0
    out = []
    for t in tags:
        while curr &lt; t.idx and curr &lt; len(s):
            out.append(escape(s[curr]))
            curr += 1
        out.append(t.tag)

    while curr &lt; len(s):
        out.append(escape(s[curr]))
        curr += 1
    return &#39;&#39;.join(out)</span>




#--------------------- tag generation functions ----------------------

<span class='d'>def changeTags(s, changes, side):
    tags = []
    for r in changes:
        key = r.orig if side == &#39;left&#39; else r.cur
        if hasattr(key, &#39;lineno&#39;):
            start = nodeStart(key)
            if IS(key, FunctionDef):
                end = start + len(&#39;def&#39;)
            elif IS(key, ClassDef):
                end = start + len(&#39;class&#39;)
            else:
                end = nodeEnd(key)

            if r.orig &lt;&gt; None and r.cur &lt;&gt; None:
                # &lt;a ...&gt; for change and move
                tags.append(Tag(linkTagStart(r, side), start))
                tags.append(Tag(&quot;&lt;/a&gt;&quot;, end, start))
            else:
                # &lt;span ...&gt; for deletion and insertion
                tags.append(Tag(spanStart(r), start))
                tags.append(Tag(&#39;&lt;/span&gt;&#39;, end, start))

    return tags</span>



<span class='d'>def lineTags(s):
    out = []
    lineno = 1;
    curr = 0
    while curr &lt; len(s):
        if curr == 0 or s[curr-1] == &#39;\n&#39;:
            out.append(Tag(&#39;&lt;div class=&quot;line&quot; id=&quot;L&#39; + str(lineno) + &#39;&quot;&gt;&#39;, curr))
            out.append(Tag(&#39;&lt;span class=&quot;lineno&quot;&gt;&#39; + str(lineno) + &#39; &lt;/span&gt;&#39;, curr))
        if s[curr] == &#39;\n&#39;:
            out.append(Tag(&#39;&lt;/div&gt;&#39;, curr))
            lineno += 1
        curr += 1
    out.append(Tag(&#39;&lt;/div&gt;&#39;, curr))
    return out</span>



<span class='d'>def keywordTags(side):
    tags = []
    allNodes = allNodes1 if side == &#39;left&#39; else allNodes2
    for node in allNodes:
        if type(node) in keywordMap:
            kw = keywordMap[type(node)]
            start = nodeStart(node)
            if src(node)[:len(kw)] == kw:
                startTag = (Tag(&#39;&lt;span class=&quot;keyword&quot;&gt;&#39;, start))
                tags.append(startTag)
                endTag = Tag(&#39;&lt;/span&gt;&#39;, start + len(kw), start)
                tags.append(endTag)
    return tags</span>


<span class='d'>def spanStart(diff):
    if diff.cur == None:
        cls = &quot;deletion&quot;
    else:
        cls = &quot;insertion&quot;
    text = escape(describeChange(diff))
    return &#39;&lt;span class=&quot;&#39; + cls + &#39;&quot; title=&quot;&#39; + text + &#39;&quot;&gt;&#39;</span>



<span class='d'>def linkTagStart(diff, side):
    if side == &#39;left&#39;:
        me, other = diff.orig, diff.cur
    else:
        me, other = diff.cur, diff.orig

    text = escape(describeChange(diff))
    if diff.cost &gt; 0:
        cls = &quot;change&quot;
    else:
        cls = &quot;move&quot;

    return (&#39;&lt;a id=&quot;&#39; + uid(me) + &#39;&quot; &#39;
            + &#39; class=&quot;&#39; + cls + &#39;&quot; &#39;
            + &#39; title=&quot;&#39; + text + &#39;&quot; &#39;
            + &#39;onclick=&quot;highlight(&#39;
                          + qs(uid(me)) + &quot;,&quot;
                          + qs(uid(other)) + &quot;,&quot;
                          + qs(lineId(me.lineno)) + &quot;,&quot;
                          + qs(lineId(other.lineno)) + &#39;)&quot;&gt;&#39;</span>)


<span class='d'>keywordMap = {
    FunctionDef : &#39;def&#39;,
    ClassDef    : &#39;class&#39;,
    For         : &#39;for&#39;,
    While       : &#39;while&#39;,
    If          : &#39;if&#39;,
    With        : &#39;with&#39;,
    Return      : &#39;return&#39;,
    Yield       : &#39;yield&#39;,
    Global      : &#39;global&#39;,
    Raise       : &#39;raise&#39;,
    Pass        : &#39;pass&#39;,
    TryExcept   : &#39;try&#39;,
    TryFinally  : &#39;try&#39;,
    }</span>




# human readable description of node

<span class='d'>def describeNode(node):

    def code(s):
        return &quot;&#39;&quot; + s + &quot;&#39;&quot;

    def short(node):
        if IS(node, Module):
            ret = &quot;module&quot;
        elif IS(node, Import):
            ret = &quot;import statement&quot;
        elif IS(node, Name):
            ret = code(node.id)
        elif IS(node, Attribute):
            ret = code(short(node.value) + &quot;.&quot; + short(node.attrName))
        elif IS(node, FunctionDef):
            ret = &quot;function &quot; + code(node.name)
        elif IS(node, ClassDef):
            ret = &quot;class &quot; + code(node.name)
        elif IS(node, Call):
            ret = &quot;call to &quot; + code(short(node.func))
        elif IS(node, Assign):
            ret = &quot;assignment&quot;
        elif IS(node, If):
            ret = &quot;if statement&quot;
        elif IS(node, While):
            ret = &quot;while loop&quot;
        elif IS(node, For):
            ret = &quot;for loop&quot;
        elif IS(node, Yield):
            ret = &quot;yield&quot;
        elif IS(node, TryExcept) or IS(node, TryFinally):
            ret = &quot;try statement&quot;
        elif IS(node, Compare):
            ret = &quot;comparison &quot; + src(node)
        elif IS(node, Return):
            ret = &quot;return &quot; + short(node.value)
        elif IS(node, Print):
            ret = (&quot;print &quot; + short(node.dest) +
                   &quot;, &quot; if (node.dest!=None) else &quot;&quot; + printList(node.values))
        elif IS(node, Expr):
            ret = &quot;expression &quot; + short(node.value)
        elif IS(node, Num):
            ret = str(node.n)
        elif IS(node, Str):
            if len(node.s) &gt; 20:
                ret = &quot;string &quot; + code(node.s[:20]) + &quot;...&quot;
            else:
                ret = &quot;string &quot; + code(node.s)
        elif IS(node, Tuple):
            ret = &quot;tuple (&quot; + src(node) + &quot;)&quot;
        elif IS(node, BinOp):
            ret = (short(node.left) + &quot; &quot; +
                   node.opName.id + &quot; &quot; + short(node.right))
        elif IS(node, BoolOp):
            ret = src(node)
        elif IS(node, UnaryOp):
            ret = node.opName.id + &quot; &quot; + short(node.operand)
        elif IS(node, Pass):
            ret = &quot;pass&quot;
        elif IS(node, list):
            ret = map(short, node)
        else:
            ret = str(type(node))
        return ret

    ret = short(node)
    if hasattr(node, &#39;lineno&#39;):
        ret = re.sub(&quot; *(line [0-9]+)&quot;, &#39;&#39;, ret)
        return ret + &quot; (line &quot; + str(node.lineno) + &quot;)&quot;
    else:
        return ret</span>




# describe a change in a human readable fashion
<span class='d'>def describeChange(diff):

    ratio = diff.similarity()
    sim = str(ratio)

    if ratio == 1.0:
        sim = &quot; (unchanged)&quot;
    else:
        sim = &quot; (similarity %.1f%%)&quot; % (ratio * 100)

    if diff.isFrame:
        wrap = &quot;wrap &quot;
    else:
        wrap = &quot;&quot;

    if diff.cur == None:
        ret = wrap + describeNode(diff.orig) + &quot; deleted&quot;
    elif diff.orig == None:
        ret = wrap + describeNode(diff.cur) + &quot; inserted&quot;
    elif nodeName(diff.orig) &lt;&gt; nodeName(diff.cur):
        ret = (describeNode(diff.orig) +
               &quot; renamed to &quot; + describeNode(diff.cur) + sim)
    elif diff.cost == 0 and diff.orig.lineno &lt;&gt; diff.cur.lineno:
        ret = (describeNode(diff.orig) +
               &quot; moved to &quot; + describeNode(diff.cur) + sim)
    elif diff.cost == 0:
        ret = describeNode(diff.orig) + &quot; unchanged&quot;
    else:
        ret = (describeNode(diff.orig) +
               &quot; changed to &quot; + describeNode(diff.cur) + sim)

    return ret</span>





#-------------------------------------------------------------
#                     main HTML based command
#-------------------------------------------------------------

<a id='2790' tid='2791' class='c'>def <a id='2788' tid='2789' class='u'>diff</a>(<a id='2490' tid='2491' class='u'>file1</a>, <a id='2488' tid='2489' class='u'>file2</a>, <a id='2486' tid='2487' class='u'>move</a>=<a id='2484' tid='2485' class='u'>True</a>):

    <a id='2494' tid='2495' class='u'>import</a> <a id='2492' tid='2493' class='u'>time</a>
    print(<a id='2496' tid='2497' class='u'>&quot;\nJob started at %s, %s\n&quot;</a> <a id='2504' tid='2505' class='u'>%</a> (<a id='2502' tid='2503' class='u'>time.ctime</a>(), <a id='2500' tid='2501' class='u'>time.tzname</a>[<a id='2498' tid='2499' class='u'>0</a>]))
    <a id='2506' tid='2507' class='c'>startTime</a> = <a id='2508' tid='2509' class='u'>time.time</a>()
    <a id='2512' tid='2513' class='u'>checkpoint</a>(<a id='2510' tid='2511' class='c'>startTime</a>)

    <a id='2514' tid='2515' class='c'>cleanUp</a>()

    # base files names
    <a id='2516' tid='2517' class='c'>baseName1</a> = <a id='2520' tid='2521' class='c'>pyFileName</a>(<a id='2518' tid='2519' class='u'>file1</a>)
    <a id='2522' tid='2523' class='c'>baseName2</a> = <a id='2526' tid='2527' class='c'>pyFileName</a>(<a id='2524' tid='2525' class='u'>file2</a>)

    # get AST of file1
    <a id='2528' tid='2529' class='u'>f1</a> = <a id='2534' tid='2535' class='u'>open</a>(<a id='2532' tid='2533' class='u'>file1</a>, <a id='2530' tid='2531' class='u'>&#39;r&#39;</a>);
    <a id='2536' tid='2537' class='u'>lines1</a> = <a id='2538' tid='2539' class='u'>f1.read</a>()
    <a id='2540' tid='2541' class='u'>f1.close</a>()
    <a id='2542' tid='2543' class='u'>node1</a> = <a id='2546' tid='2547' class='u'>parse</a>(<a id='2544' tid='2545' class='u'>lines1</a>)
    <a id='2556' tid='2557' class='c'>improveAST</a>(<a id='2554' tid='2555' class='u'>node1</a>, <a id='2552' tid='2553' class='u'>lines1</a>, <a id='2550' tid='2551' class='u'>file1</a>, <a id='2548' tid='2549' class='u'>&#39;left&#39;</a>)

    # get AST of file2
    <a id='2558' tid='2559' class='u'>f2</a> = <a id='2564' tid='2565' class='u'>open</a>(<a id='2562' tid='2563' class='u'>file2</a>, <a id='2560' tid='2561' class='u'>&#39;r&#39;</a>);
    <a id='2566' tid='2567' class='u'>lines2</a> = <a id='2568' tid='2569' class='u'>f2.read</a>()
    <a id='2570' tid='2571' class='u'>f2.close</a>()
    <a id='2572' tid='2573' class='u'>node2</a> = <a id='2576' tid='2577' class='u'>parse</a>(<a id='2574' tid='2575' class='u'>lines2</a>)
    <a id='2586' tid='2587' class='c'>improveAST</a>(<a id='2584' tid='2585' class='u'>node2</a>, <a id='2582' tid='2583' class='u'>lines2</a>, <a id='2580' tid='2581' class='u'>file2</a>, <a id='2578' tid='2579' class='u'>&#39;right&#39;</a>)


    print(<a id='2588' tid='2589' class='u'>&quot;[parse] finished in %s. Now start to diff.&quot;</a> <a id='2594' tid='2595' class='u'>%</a> <a id='2592' tid='2593' class='c'>sec2min</a>(<a id='2590' tid='2591' class='u'>checkpoint</a>()))

    # get the changes

    (<a id='2596' tid='2597' class='u'>changes</a>, <a id='2598' tid='2599' class='u'>cost</a>) = <a id='2612' tid='2613' class='c'>diffNode</a>(<a id='2610' tid='2611' class='u'>node1</a>, <a id='2608' tid='2609' class='u'>node2</a>, <a id='2606' tid='2607' class='u'>nil</a>, <a id='2604' tid='2605' class='u'>nil</a>, <a id='2602' tid='2603' class='u'>0</a>, <a id='2600' tid='2601' class='u'>False</a>)

    print (<a id='2614' tid='2615' class='u'>&quot;\n[diff] processed %d nodes in %s.&quot;</a>
           <a id='2622' tid='2623' class='u'>%</a> (<a id='2620' tid='2621' class='c'>stat.diffCount</a>, <a id='2618' tid='2619' class='c'>sec2min</a>(<a id='2616' tid='2617' class='u'>checkpoint</a>())))

    if <a id='2624' tid='2625' class='u'>move</a>:
#        print &quot;changes:&quot;, changes
        (<a id='2626' tid='2627' class='u'>changes</a>, <a id='2628' tid='2629' class='u'>cost</a>) = <a id='2634' tid='2635' class='c'>closure</a>((<a id='2632' tid='2633' class='u'>changes</a>, <a id='2630' tid='2631' class='u'>cost</a>))

        print(<a id='2636' tid='2637' class='c'>&quot;\n[closure] finished in %s.&quot;</a> <a id='2642' tid='2643' class='u'>%</a> <a id='2640' tid='2641' class='c'>sec2min</a>(<a id='2638' tid='2639' class='u'>checkpoint</a>()))



    #---------------------- print final stats ---------------------
    <a id='2644' tid='2645' class='u'>size1</a> = <a id='2648' tid='2649' class='c'>nodeSize</a>(<a id='2646' tid='2647' class='u'>node1</a>)
    <a id='2650' tid='2651' class='u'>size2</a> = <a id='2654' tid='2655' class='c'>nodeSize</a>(<a id='2652' tid='2653' class='u'>node2</a>)
    <a id='2656' tid='2657' class='u'>total</a> = <a id='2662' tid='2663' class='u'>size1</a> <a id='2658' tid='2659' class='u'>+</a> <a id='2660' tid='2661' class='u'>size2</a>

    <a id='2664' tid='2665' class='u'>report</a> = <a id='2666' tid='2667' class='u'>&quot;&quot;</a>
    <a id='2668' tid='2669' class='u'>report</a> <a id='2676' tid='2677' class='u'>+</a>= (<a id='2674' tid='2675' class='u'>&quot;\n--------------------- summary -----------------------&quot;</a>) <a id='2670' tid='2671' class='u'>+</a> <a id='2672' tid='2673' class='u'>&quot;\n&quot;</a>
    <a id='2678' tid='2679' class='u'>report</a> <a id='2690' tid='2691' class='u'>+</a>= (<a id='2684' tid='2685' class='u'>&quot;- total changes (chars):  %d&quot;</a> <a id='2688' tid='2689' class='u'>%</a> <a id='2686' tid='2687' class='u'>cost</a>)                  <a id='2680' tid='2681' class='u'>+</a> <a id='2682' tid='2683' class='u'>&quot;\n&quot;</a>
    <a id='2692' tid='2693' class='u'>report</a> <a id='2708' tid='2709' class='u'>+</a>= (<a id='2698' tid='2699' class='u'>&quot;- total code size:        %d (left: %d  right: %d)&quot;</a>
               <a id='2706' tid='2707' class='u'>%</a> (<a id='2704' tid='2705' class='u'>total</a>, <a id='2702' tid='2703' class='u'>size1</a>, <a id='2700' tid='2701' class='u'>size2</a>))                                <a id='2694' tid='2695' class='u'>+</a> <a id='2696' tid='2697' class='u'>&quot;\n&quot;</a>
    <a id='2710' tid='2711' class='u'>report</a> <a id='2722' tid='2723' class='u'>+</a>= (<a id='2716' tid='2717' class='u'>&quot;- total moved pieces:     %d&quot;</a> <a id='2720' tid='2721' class='u'>%</a> <a id='2718' tid='2719' class='c'>stat.moveCount</a>)        <a id='2712' tid='2713' class='u'>+</a> <a id='2714' tid='2715' class='u'>&quot;\n&quot;</a>
    <a id='2724' tid='2725' class='u'>report</a> <a id='2744' tid='2745' class='u'>+</a>= (<a id='2730' tid='2731' class='u'>&quot;- percentage of change:   %.1f%%&quot;</a>
               <a id='2742' tid='2743' class='u'>%</a> (<a id='2736' tid='2737' class='u'>div</a>(<a id='2738' tid='2739' class='u'>cost</a>, <a id='2740' tid='2741' class='u'>total</a>) <a id='2732' tid='2733' class='u'>*</a> <a id='2734' tid='2735' class='u'>100</a>))                             <a id='2726' tid='2727' class='u'>+</a> <a id='2728' tid='2729' class='u'>&quot;\n&quot;</a>
    <a id='2746' tid='2747' class='u'>report</a> <a id='2754' tid='2755' class='u'>+</a>= (<a id='2752' tid='2753' class='u'>&quot;-----------------------------------------------------&quot;</a>)   <a id='2748' tid='2749' class='u'>+</a> <a id='2750' tid='2751' class='u'>&quot;\n&quot;</a>

    print <a id='2756' tid='2757' class='u'>report</a>


    #---------------------- generation HTML ---------------------
    # write left file
    <span class='d'>leftChanges = filterlist(lambda p: p.orig &lt;&gt; None, changes)</span>
    <span class='d'>html1 = genHTML(lines1, leftChanges, &#39;left&#39;)</span>

    <span class='d'>outname1 = baseName1 + &#39;.html&#39;</span>
    <span class='d'>outfile1 = open(outname1, &#39;w&#39;)</span>
    <a id='2760' tid='2761' class='c'>outfile1.write</a>(<a id='2758' tid='2759' class='c'>html1</a>)
    <span class='d'>outfile1.write(&#39;&lt;div class=&quot;stats&quot;&gt;&lt;pre class=&quot;stats&quot;&gt;&#39;)</span>
    <span class='d'>outfile1.write(report)</span>
    <span class='d'>outfile1.write(&#39;&lt;/pre&gt;&lt;/div&gt;&#39;)</span>
    <span class='d'>outfile1.write(&#39;&lt;/body&gt;\n&#39;)</span>
    <span class='d'>outfile1.write(&#39;&lt;/html&gt;\n&#39;)</span>
    <span class='d'>outfile1.close()</span>


    # write right file
    <span class='d'>rightChanges = filterlist(lambda p: p.cur &lt;&gt; None, changes)</span>
    <span class='d'>html2 = genHTML(lines2, rightChanges, &#39;right&#39;)</span>

    <span class='d'>outname2 = baseName2 + &#39;.html&#39;</span>
    <span class='d'>outfile2 = open(outname2, &#39;w&#39;)</span>
    <span class='d'>outfile2.write(html2)</span>
    <span class='d'>outfile2.write(&#39;&lt;div class=&quot;stats&quot;&gt;&lt;pre class=&quot;stats&quot;&gt;&#39;)</span>
    <span class='d'>outfile2.write(report)</span>
    <span class='d'>outfile2.write(&#39;&lt;/pre&gt;&lt;/div&gt;&#39;)</span>
    <span class='d'>outfile2.write(&#39;&lt;/body&gt;\n&#39;)</span>
    <span class='d'>outfile2.write(&#39;&lt;/html&gt;\n&#39;)</span>
    <span class='d'>outfile2.close()</span>


    # write frame file
    <span class='d'>framename = baseName1 + &quot;-&quot; + baseName2 + &quot;.html&quot;</span>
    <span class='d'>framefile = open(framename, &#39;w&#39;)</span>
    <span class='d'>framefile.write(&#39;&lt;frameset cols=&quot;50%,50%&quot;&gt;\n&#39;)</span>
    <span class='d'>framefile.write(&#39;&lt;frame name=&quot;left&quot; src=&quot;&#39; + baseName1 + &#39;.html&quot;&gt;\n&#39;)</span>
    <span class='d'>framefile.write(&#39;&lt;frame name=&quot;right&quot; src=&quot;&#39; + baseName2 + &#39;.html&quot;&gt;\n&#39;)</span>
    <span class='d'>framefile.write(&#39;&lt;/frameset&gt;\n&#39;)</span>
    <span class='d'>framefile.close()</span>

    <a id='2762' tid='2763' class='u'>dur</a> = <a id='2768' tid='2769' class='u'>time.time</a>() <a id='2764' tid='2765' class='u'>-</a> <a id='2766' tid='2767' class='c'>startTime</a>
    print(<a id='2770' tid='2771' class='u'>&quot;\n[summary] Job finished at %s, %s&quot;</a> <a id='2778' tid='2779' class='u'>%</a>
          (<a id='2776' tid='2777' class='u'>time.ctime</a>(), <a id='2774' tid='2775' class='u'>time.tzname</a>[<a id='2772' tid='2773' class='u'>0</a>]))
    print(<a id='2780' tid='2781' class='u'>&quot;\n\tTotal duration: %s&quot;</a> <a id='2786' tid='2787' class='u'>%</a> <a id='2784' tid='2785' class='c'>sec2min</a>(<a id='2782' tid='2783' class='u'>dur</a>))</a>




<a id='2818' tid='2819' class='c'>def <a id='2816' tid='2817' class='c'>cleanUp</a>():
    <a id='2792' tid='2793' class='c'>clearStrDistCache</a>()
    <a id='2794' tid='2795' class='c'>clearUID</a>()

    global allNodes1, allNodes2
    <a id='2796' tid='2797' class='u'>allNodes1</a> = <a id='2798' tid='2799' class='u'>set</a>()
    <a id='2800' tid='2801' class='u'>allNodes2</a> = <a id='2802' tid='2803' class='u'>set</a>()

    <a id='2804' tid='2805' class='c'>stat.diffCount</a> = <a id='2806' tid='2807' class='u'>0</a>
    <a id='2808' tid='2809' class='c'>stat.moveCount</a> = <a id='2810' tid='2811' class='u'>0</a>
    <a id='2812' tid='2813' class='c'>stat.moveSavings</a> = <a id='2814' tid='2815' class='u'>0</a></a>



<a id='2846' tid='2847' class='c'>def <a id='2844' tid='2845' class='c'>sec2min</a>(<a id='2820' tid='2821' class='u'>s</a>):
    if <a id='2826' tid='2827' class='u'>s</a> <a id='2822' tid='2823' class='u'>&lt;</a> <a id='2824' tid='2825' class='u'>60</a>:
        return (<a id='2832' tid='2833' class='u'>&quot;%.1f seconds&quot;</a> <a id='2828' tid='2829' class='u'>%</a> <a id='2830' tid='2831' class='u'>s</a>)
    else:
        return (<a id='2842' tid='2843' class='u'>&quot;%.1f minutes&quot;</a> <a id='2834' tid='2835' class='u'>%</a> <a id='2836' tid='2837' class='u'>div</a>(<a id='2838' tid='2839' class='u'>s</a>, <a id='2840' tid='2841' class='u'>60</a>)</a>)



<a id='2848' tid='2849' class='c'>lastCheckpoint</a> = <a id='2850' tid='2851' class='u'>None</a>
<a id='2888' tid='2889' class='c'>def <a id='2886' tid='2887' class='u'>checkpoint</a>(<a id='2854' tid='2855' class='u'>init</a>=<a id='2852' tid='2853' class='u'>None</a>):
    <a id='2858' tid='2859' class='u'>import</a> <a id='2856' tid='2857' class='u'>time</a>
    global lastCheckpoint
    if <a id='2864' tid='2865' class='u'>init</a> <a id='2860' tid='2861' class='u'>&lt;&gt;</a> <a id='2862' tid='2863' class='u'>None</a>:
        <a id='2866' tid='2867' class='c'>lastCheckpoint</a> = <a id='2868' tid='2869' class='u'>init</a>
        return <a id='2870' tid='2871' class='u'>None</a>
    else:
        <a id='2872' tid='2873' class='u'>dur</a> = <a id='2878' tid='2879' class='u'>time.time</a>() <a id='2874' tid='2875' class='u'>-</a> <a id='2876' tid='2877' class='c'>lastCheckpoint</a>
        <a id='2880' tid='2881' class='c'>lastCheckpoint</a> = <a id='2882' tid='2883' class='u'>time.time</a>()
        return <a id='2884' tid='2885' class='u'>dur</a></a>




#-------------------------------------------------------------
#                      text-based interfaces
#-------------------------------------------------------------

## text-based main command
<a id='2954' tid='2955' class='c'>def <a id='2952' tid='2953' class='c'>printDiff</a>(<a id='2892' tid='2893' class='u'>file1</a>, <a id='2890' tid='2891' class='u'>file2</a>):
    (<a id='2894' tid='2895' class='u'>m</a>, <a id='2896' tid='2897' class='u'>c</a>) = <a id='2902' tid='2903' class='c'>diffFile</a>(<a id='2900' tid='2901' class='u'>file1</a>, <a id='2898' tid='2899' class='u'>file2</a>)
    print <a id='2904' tid='2905' class='u'>&quot;----------&quot;</a>, <a id='2906' tid='2907' class='u'>file1</a>, <a id='2908' tid='2909' class='u'>&quot;&lt;&lt;&lt;&quot;</a>, <a id='2910' tid='2911' class='u'>c</a>, <a id='2912' tid='2913' class='u'>&quot;&gt;&gt;&gt;&quot;</a>, <a id='2914' tid='2915' class='u'>file2</a>, <a id='2916' tid='2917' class='u'>&quot;-----------&quot;</a>

    <a id='2918' tid='2919' class='u'>ms</a> = <a id='2922' tid='2923' class='u'>pylist</a>(<a id='2920' tid='2921' class='u'>m</a>)
    <a id='2924' tid='2925' class='u'>ms</a> = <a id='2934' tid='2935' class='u'>sorted</a>(<a id='2932' tid='2933' class='u'>ms</a>, key=lambda <a id='2926' tid='2927' class='u'>d</a>: <a id='2930' tid='2931' class='c'>nodeStart</a>(<a id='2928' tid='2929' class='u'>d.orig</a>))
    print <a id='2936' tid='2937' class='u'>&quot;\n-------------------- changes(&quot;</a>, <a id='2938' tid='2939' class='u'>len</a>(<a id='2940' tid='2941' class='u'>ms</a>), <a id='2942' tid='2943' class='u'>&quot;)---------------------- &quot;</a>
    for <a id='2944' tid='2945' class='u'>m0</a> in <a id='2946' tid='2947' class='u'>ms</a>:
        print <a id='2948' tid='2949' class='u'>m0</a>

    print <a id='2950' tid='2951' class='u'>&quot;\n-------------------  end  ----------------------- &quot;</a></a>




<a id='2990' tid='2991' class='c'>def <a id='2988' tid='2989' class='c'>diffFile</a>(<a id='2958' tid='2959' class='u'>file1</a>, <a id='2956' tid='2957' class='u'>file2</a>):
    <a id='2960' tid='2961' class='u'>node1</a> = <a id='2964' tid='2965' class='c'>parseFile</a>(<a id='2962' tid='2963' class='u'>file1</a>)
    <a id='2966' tid='2967' class='u'>node2</a> = <a id='2970' tid='2971' class='c'>parseFile</a>(<a id='2968' tid='2969' class='u'>file2</a>)
    return <a id='2986' tid='2987' class='c'>closure</a>(<a id='2984' tid='2985' class='c'>diffNode</a>(<a id='2982' tid='2983' class='u'>node1</a>, <a id='2980' tid='2981' class='u'>node2</a>, <a id='2978' tid='2979' class='u'>nil</a>, <a id='2976' tid='2977' class='u'>nil</a>, <a id='2974' tid='2975' class='u'>0</a>, <a id='2972' tid='2973' class='u'>False</a>))</a>




# printing support for debugging use
<span class='d'>def iter_fields(node):
    &quot;&quot;&quot;Iterate over all existing fields, excluding &#39;ctx&#39;.&quot;&quot;&quot;
    for field in node._fields:
        try:
            if field &lt;&gt; &#39;ctx&#39;:
                yield field, getattr(node, field)
        except AttributeError:
            pass</span>


<span class='d'>def dump(node, annotate_fields=True, include_attributes=False):
    def _format(node):
        if isinstance(node, AST):
            fields = [(a, _format(b)) for a, b in iter_fields(node)]
            rv = &#39;%s(%s&#39; % (node.__class__.__name__, &#39;, &#39;.join(
                (&#39;%s=%s&#39; % field for field in fields)
                if annotate_fields else
                (b for a, b in fields)
            ))
            if include_attributes and node._attributes:
                rv += fields and &#39;, &#39; or &#39; &#39;
                rv += &#39;, &#39;.join(&#39;%s=%s&#39; % (a, _format(getattr(node, a)))
                                for a in node._attributes)
            return rv + &#39;)&#39;
        elif isinstance(node, list):
            return &#39;[%s]&#39; % &#39;, &#39;.join(_format(x) for x in node)
        return repr(node)
    if not isinstance(node, AST):
        raise TypeError(&#39;expected AST, got %r&#39; % node.__class__.__name__)
    return _format(node)</span>

<span class='d'>def printList(ls):
    if (ls == None or ls == []):
        return &quot;&quot;
    elif (len(ls) == 1):
        return str(ls[0])
    else:
        return str(ls)</span>




# for debugging use
<span class='d'>def printAst(node):
    if (IS(node, Module)):
        ret = &quot;module:&quot; + str(node.body)
    elif (IS(node, Name)):
        ret = str(node.id)
    elif (IS(node, Attribute)):
        if hasattr(node, &#39;attrName&#39;):
            ret = str(node.value) + &quot;.&quot; + str(node.attrName)
        else:
            ret = str(node.value) + &quot;.&quot; + str(node.attr)
    elif (IS(node, FunctionDef)):
        if hasattr(node, &#39;nameName&#39;):
            ret = &quot;fun:&quot; + str(node.nameName)
        else:
            ret = &quot;fun:&quot; + str(node.name)
    elif (IS(node, ClassDef)):
        ret = &quot;class:&quot; + str(node.name)
    elif (IS(node, Call)):
        ret = &quot;call:&quot; + str(node.func) + &quot;:(&quot; + printList(node.args) + &quot;)&quot;
    elif (IS(node, Assign)):
        ret = &quot;(&quot; + printList(node.targets) + &quot; &lt;- &quot; + printAst(node.value) + &quot;)&quot;
    elif (IS(node, If)):
        ret = &quot;if &quot; + str(node.test) + &quot;:&quot; + printList(node.body) + &quot;:&quot; + printList(node.orelse)
    elif (IS(node, Compare)):
        ret = str(node.left) + &quot;:&quot; + printList(node.ops) + &quot;:&quot; + printList(node.comparators)
    elif (IS(node, Return)):
        ret = &quot;return &quot; + repr(node.value)
    elif (IS(node, Print)):
        ret = &quot;print(&quot; + (str(node.dest) + &quot;, &quot; if (node.dest!=None) else &quot;&quot;) + printList(node.values) + &quot;)&quot;
    elif (IS(node, Expr)):
        ret = &quot;expr:&quot; + str(node.value)
    elif (IS(node, Num)):
        ret = &quot;num:&quot; + str(node.n)
    elif (IS(node, Str)):
        ret = &#39;str:&quot;&#39; + str(node.s) + &#39;&quot;&#39;
    elif (IS(node, BinOp)):
        ret = str(node.left) + &quot; &quot; + str(node.op) + &quot; &quot; + str(node.right)
    elif (IS(node, Add)):
        ret = &#39;+&#39;
    elif (IS(node, Mult)):
        ret = &#39;*&#39;
    elif IS(node, NotEq):
        ret = &#39;&lt;&gt;&#39;
    elif (IS(node, Eq)):
        ret = &#39;==&#39;
    elif (IS(node, Pass)):
        ret = &quot;pass&quot;
    elif IS(node,list):
        ret = printList(node)
    else:
        ret = str(type(node))

    if hasattr(node, &#39;lineno&#39;):
        return re.sub(&quot;@[0-9]+&quot;, &#39;&#39;, ret) + &quot;@&quot; + str(node.lineno)
    elif hasattr(node, &#39;nodeStart&#39;):
        return re.sub(&quot;@[0-9]+&quot;, &#39;&#39;, ret) + &quot;%&quot; + str(nodeStart(node))
    else:
        return ret</span>


<span class='d'>def installPrinter():
    import inspect, ast
    for name, obj in inspect.getmembers(ast):
        if (inspect.isclass(obj) and not (obj == AST)):
            obj.__repr__ = printAst</span>

<span class='d'>installPrinter()</span>

# demo
# diff(&#39;demos/demo1.py&#39;, &#39;demos/demo2.py&#39;)
</pre></div><div id="right" class="src"><pre><a id="rightstart" tid="leftstart"></a>#!/usr/bin/env python

<a id='3' tid='2' class='u'>import</a> <a id='1' tid='0' class='u'>sys</a>
<a id='7' tid='6' class='u'>import</a> <a id='5' tid='4' class='u'>re</a>
<span class='i'>import</span> cProfile

<a id='9' tid='8' class='u'>from</a> ast import *
<a id='11' tid='10' class='u'>from</a> lists import *

<span class='i'>from</span> parameters import *
<span class='i'>from</span> improve_ast import *
<span class='i'>from</span> htmlize import *
<span class='i'>from</span> utils import *



#------------------------------- types ------------------------------
# global storage of running stats
<a id='21' tid='20' class='u'>class <a id='19' tid='18' class='u'>Stat</a>:
    <a id='17' tid='16' class='u'>def <a id='15' tid='14' class='u'>__init__</a>(<a id='13' tid='12' class='u'>self</a>):
        pass</a></a>

<a id='23' tid='22' class='u'>stat</a> = <a id='25' tid='24' class='u'>Stat</a>()



# The difference between nodes are stored as a Change structure.
<a id='215' tid='214' class='c'>class <a id='213' tid='212' class='u'>Change</a>:
    <a id='99' tid='98' class='c'>def <a id='97' tid='96' class='u'>__init__</a>(<a id='37' tid='36' class='u'>self</a>, <a id='35' tid='34' class='u'>orig</a>, <a id='33' tid='32' class='u'>cur</a>, <a id='31' tid='30' class='u'>cost</a>, <a id='29' tid='28' class='c'>is_frame</a>=<a id='27' tid='26' class='u'>False</a>):
        <a id='39' tid='38' class='u'>self.orig</a> = <a id='41' tid='40' class='u'>orig</a>
        <a id='43' tid='42' class='u'>self.cur</a> = <a id='45' tid='44' class='u'>cur</a>
        if <a id='51' tid='50' class='u'>orig</a> <a id='47' tid='46' class='u'>==</a> <a id='49' tid='48' class='u'>None</a>:
            <a id='53' tid='52' class='u'>self.cost</a> = <a id='57' tid='56' class='c'>node_size</a>(<a id='55' tid='54' class='u'>cur</a>)
        elif <a id='63' tid='62' class='u'>cur</a> <a id='59' tid='58' class='u'>==</a> <a id='61' tid='60' class='u'>None</a>:
            <a id='65' tid='64' class='u'>self.cost</a> = <a id='69' tid='68' class='c'>node_size</a>(<a id='67' tid='66' class='u'>orig</a>)
        elif <a id='75' tid='74' class='u'>cost</a> <a id='71' tid='70' class='u'>==</a> <a id='73' tid='72' class='u'>&#39;all&#39;</a>:
            <a id='77' tid='76' class='u'>self.cost</a> = <a id='85' tid='84' class='c'>node_size</a>(<a id='87' tid='86' class='u'>orig</a>) <a id='79' tid='78' class='u'>+</a> <a id='81' tid='80' class='c'>node_size</a>(<a id='83' tid='82' class='u'>cur</a>)
        else:
            <a id='89' tid='88' class='u'>self.cost</a> = <a id='91' tid='90' class='u'>cost</a>
        <a id='93' tid='92' class='c'>self.is_frame</a> = <a id='95' tid='94' class='c'>is_frame</a></a>
    <a id='183' tid='182' class='c'>def <a id='181' tid='180' class='u'>__repr__</a>(<a id='101' tid='100' class='u'>self</a>):
        <a id='103' tid='102' class='u'>fr</a> = <a id='107' tid='106' class='u'>&quot;F&quot;</a> if <a id='109' tid='108' class='c'>self.is_frame</a> else <a id='105' tid='104' class='u'>&quot;-&quot;</a>
        <a id='125' tid='124' class='u'>def <a id='123' tid='122' class='u'>hole</a>(<a id='111' tid='110' class='u'>x</a>):
            if <a id='117' tid='116' class='u'>x</a> <a id='113' tid='112' class='u'>==</a> <a id='115' tid='114' class='u'>None</a>:
                return <a id='119' tid='118' class='u'>&quot;[]&quot;</a>
            else:
                return <a id='121' tid='120' class='u'>x</a></a>
        return (<a id='147' tid='146' class='u'>&quot;(C:&quot;</a> <a id='155' tid='154' class='u'>+</a> <a id='153' tid='152' class='u'>str</a>(<a id='151' tid='150' class='u'>hole</a>(<a id='149' tid='148' class='u'>self.orig</a>)) <a id='143' tid='142' class='u'>+</a> <a id='145' tid='144' class='u'>&quot;:&quot;</a> <a id='163' tid='162' class='u'>+</a> <a id='161' tid='160' class='u'>str</a>(<a id='159' tid='158' class='u'>hole</a>(<a id='157' tid='156' class='u'>self.cur</a>))
                <a id='139' tid='138' class='u'>+</a> <a id='141' tid='140' class='u'>&quot;:&quot;</a> <a id='169' tid='168' class='u'>+</a> <a id='167' tid='166' class='u'>str</a>(<a id='165' tid='164' class='u'>self.cost</a>) <a id='135' tid='134' class='u'>+</a> <a id='137' tid='136' class='u'>&quot;:&quot;</a> <a id='175' tid='174' class='u'>+</a> <a id='173' tid='172' class='u'>str</a>(<a id='171' tid='170' class='u'>self.similarity</a>())
                <a id='131' tid='130' class='u'>+</a> <a id='133' tid='132' class='u'>&quot;:&quot;</a> <a id='179' tid='178' class='u'>+</a> <a id='177' tid='176' class='u'>fr</a> <a id='127' tid='126' class='u'>+</a> <a id='129' tid='128' class='u'>&quot;)&quot;</a></a>)
    <a id='211' tid='210' class='c'>def <a id='209' tid='208' class='u'>similarity</a>(<a id='185' tid='184' class='u'>self</a>):
        <a id='187' tid='186' class='u'>total</a> = <a id='195' tid='194' class='c'>node_size</a>(<a id='197' tid='196' class='u'>self.orig</a>) <a id='189' tid='188' class='u'>+</a> <a id='191' tid='190' class='c'>node_size</a>(<a id='193' tid='192' class='u'>self.cur</a>)
        return <a id='207' tid='206' class='u'>1</a> <a id='199' tid='198' class='u'>-</a> <a id='201' tid='200' class='u'>div</a>(<a id='203' tid='202' class='u'>self.cost</a>, <a id='205' tid='204' class='u'>total</a>)</a></a>



# Three major kinds of changes:
# * modification
# * deletion
# *insertion
<a id='235' tid='234' class='c'>def <a id='233' tid='232' class='c'>mod_node</a>(<a id='221' tid='220' class='u'>node1</a>, <a id='219' tid='218' class='u'>node2</a>, <a id='217' tid='216' class='u'>cost</a>):
    return <a id='231' tid='230' class='u'>loner</a>(<a id='229' tid='228' class='u'>Change</a>(<a id='227' tid='226' class='u'>node1</a>, <a id='225' tid='224' class='u'>node2</a>, <a id='223' tid='222' class='u'>cost</a>))</a>

<a id='253' tid='252' class='c'>def <a id='251' tid='250' class='c'>del_node</a>(<a id='237' tid='236' class='u'>node</a>):
    return <a id='249' tid='248' class='u'>loner</a>(<a id='247' tid='246' class='u'>Change</a>(<a id='245' tid='244' class='u'>node</a>, <a id='243' tid='242' class='u'>None</a>, <a id='241' tid='240' class='c'>node_size</a>(<a id='239' tid='238' class='u'>node</a>)))</a>

<a id='271' tid='270' class='c'>def <a id='269' tid='268' class='c'>ins_node</a>(<a id='255' tid='254' class='u'>node</a>):
    return <a id='267' tid='266' class='u'>loner</a>(<a id='265' tid='264' class='u'>Change</a>(<a id='263' tid='262' class='u'>None</a>, <a id='261' tid='260' class='u'>node</a>, <a id='259' tid='258' class='c'>node_size</a>(<a id='257' tid='256' class='u'>node</a>)))</a>



# general cache table for acceleration
<a id='341' tid='340' class='u'>class <a id='339' tid='338' class='u'>Cache</a>:
    <a id='279' tid='278' class='u'>def <a id='277' tid='276' class='u'>__init__</a>(<a id='273' tid='272' class='u'>self</a>):
        <a id='275' tid='274' class='u'>self.table</a> = {}</a>
    <a id='293' tid='292' class='u'>def <a id='291' tid='290' class='u'>__repr__</a>(<a id='281' tid='280' class='u'>self</a>):
        return <a id='289' tid='288' class='u'>&quot;Cache:&quot;</a> <a id='283' tid='282' class='u'>+</a> <a id='285' tid='284' class='u'>str</a>(<a id='287' tid='286' class='u'>self.table</a>)</a>
    <a id='303' tid='302' class='u'>def <a id='301' tid='300' class='u'>__len__</a>(<a id='295' tid='294' class='u'>self</a>):
        return <a id='299' tid='298' class='u'>len</a>(<a id='297' tid='296' class='u'>self.table</a>)</a>
    <a id='319' tid='318' class='u'>def <a id='317' tid='316' class='u'>put</a>(<a id='309' tid='308' class='u'>self</a>, <a id='307' tid='306' class='u'>key</a>, <a id='305' tid='304' class='u'>value</a>):
        <a id='311' tid='310' class='u'>self.table</a>[<a id='313' tid='312' class='u'>key</a>] = <a id='315' tid='314' class='u'>value</a></a>
    <a id='337' tid='336' class='u'>def <a id='335' tid='334' class='u'>get</a>(<a id='323' tid='322' class='u'>self</a>, <a id='321' tid='320' class='u'>key</a>):
        if <a id='327' tid='326' class='u'>self.table.has_key</a>(<a id='325' tid='324' class='u'>key</a>):
            return <a id='331' tid='330' class='u'>self.table</a>[<a id='329' tid='328' class='u'>key</a>]
        else:
            return <a id='333' tid='332' class='u'>None</a></a></a>



# 2-D array table for memoization of dynamic programming
<a id='375' tid='374' class='c'>def <a id='373' tid='372' class='c'>create_table</a>(<a id='345' tid='344' class='u'>x</a>, <a id='343' tid='342' class='u'>y</a>):
    <a id='347' tid='346' class='u'>table</a> = []
    for <a id='349' tid='348' class='u'>i</a> in <a id='357' tid='356' class='u'>range</a>(<a id='355' tid='354' class='u'>x</a><a id='351' tid='350' class='u'>+</a><a id='353' tid='352' class='u'>1</a>):
        <a id='369' tid='368' class='u'>table.append</a>([<a id='367' tid='366' class='u'>None</a>] <a id='359' tid='358' class='u'>*</a> (<a id='361' tid='360' class='u'>y</a><a id='365' tid='364' class='u'>+</a><a id='363' tid='362' class='u'>1</a>))
    return <a id='371' tid='370' class='u'>table</a></a>

<a id='391' tid='390' class='u'>def <a id='389' tid='388' class='u'>tableLookup</a>(<a id='381' tid='380' class='u'>t</a>, <a id='379' tid='378' class='u'>x</a>, <a id='377' tid='376' class='u'>y</a>):
    return <a id='385' tid='384' class='u'>t</a>[<a id='387' tid='386' class='u'>x</a>]</a>[<a id='383' tid='382' class='u'>y</a>]

<a id='411' tid='410' class='u'>def <a id='409' tid='408' class='u'>tablePut</a>(<a id='399' tid='398' class='u'>t</a>, <a id='397' tid='396' class='u'>x</a>, <a id='395' tid='394' class='u'>y</a>, <a id='393' tid='392' class='u'>v</a>):
    <a id='403' tid='402' class='u'>t</a>[<a id='401' tid='400' class='u'>x</a>][<a id='405' tid='404' class='u'>y</a>] = <a id='407' tid='406' class='u'>v</a></a>





#-------------------------------------------------------------
#                  string distance function
#-------------------------------------------------------------

### diff cache for AST nodes
<a id='413' tid='412' class='c'>str_dist_cache</a> = <a id='415' tid='414' class='u'>Cache</a>()
<span class='i'>def clear_str_dist_cache():
    global str_dist_cache
    str_dist_cache = Cache()</span>


### string distance function
<a id='519' tid='518' class='c'>def <a id='517' tid='516' class='c'>str_dist</a>(<a id='419' tid='418' class='u'>s1</a>, <a id='417' tid='416' class='u'>s2</a>):
    <a id='421' tid='420' class='u'>cached</a> = <a id='427' tid='426' class='c'>str_dist_cache.get</a>((<a id='425' tid='424' class='u'>s1</a>, <a id='423' tid='422' class='u'>s2</a>))
    if <a id='433' tid='432' class='u'>cached</a> <a id='429' tid='428' class='u'>&lt;&gt;</a> <a id='431' tid='430' class='u'>None</a>:
        return <a id='435' tid='434' class='u'>cached</a>

    if <a id='451' tid='450' class='u'>len</a>(<a id='453' tid='452' class='u'>s1</a>) <a id='447' tid='446' class='u'>&gt;</a> <a id='449' tid='448' class='u'>100</a> <a id='437' tid='436' class='u'>or</a> <a id='443' tid='442' class='u'>len</a>(<a id='445' tid='444' class='u'>s2</a>) <a id='439' tid='438' class='u'>&gt;</a> <a id='441' tid='440' class='u'>100</a>:
        if <a id='459' tid='458' class='u'>s1</a> <a id='455' tid='454' class='u'>&lt;&gt;</a> <a id='457' tid='456' class='u'>s2</a>:
            return <a id='461' tid='460' class='u'>2.0</a>
        else:
            return <a id='463' tid='462' class='u'>0</a>

    <a id='465' tid='464' class='u'>table</a> = <a id='475' tid='474' class='c'>create_table</a>(<a id='473' tid='472' class='u'>len</a>(<a id='471' tid='470' class='u'>s1</a>), <a id='469' tid='468' class='u'>len</a>(<a id='467' tid='466' class='u'>s2</a>))
    <a id='477' tid='476' class='u'>d</a> = <a id='485' tid='484' class='u'>dist1</a>(<a id='483' tid='482' class='u'>table</a>, <a id='481' tid='480' class='u'>s1</a>, <a id='479' tid='478' class='u'>s2</a>)
    <a id='487' tid='486' class='u'>ret</a> = <a id='505' tid='504' class='u'>div</a>(<a id='503' tid='502' class='u'>2</a><a id='499' tid='498' class='u'>*</a><a id='501' tid='500' class='u'>d</a>, <a id='495' tid='494' class='u'>len</a>(<a id='497' tid='496' class='u'>s1</a>) <a id='489' tid='488' class='u'>+</a> <a id='491' tid='490' class='u'>len</a>(<a id='493' tid='492' class='u'>s2</a>))

    <a id='513' tid='512' class='c'>str_dist_cache.put</a>((<a id='511' tid='510' class='u'>s1</a>, <a id='509' tid='508' class='u'>s2</a>), <a id='507' tid='506' class='u'>ret</a>)
    return <a id='515' tid='514' class='u'>ret</a></a>


# the main dynamic programming part
# similar to the structure of diff_list
<a id='693' tid='692' class='u'>def <a id='691' tid='690' class='u'>dist1</a>(<a id='525' tid='524' class='u'>table</a>, <a id='523' tid='522' class='u'>s1</a>, <a id='521' tid='520' class='u'>s2</a>):
    <a id='547' tid='546' class='u'>def <a id='545' tid='544' class='u'>memo</a>(<a id='527' tid='526' class='u'>v</a>):
        <a id='541' tid='540' class='u'>tablePut</a>(<a id='539' tid='538' class='u'>table</a>, <a id='537' tid='536' class='u'>len</a>(<a id='535' tid='534' class='u'>s1</a>), <a id='533' tid='532' class='u'>len</a>(<a id='531' tid='530' class='u'>s2</a>), <a id='529' tid='528' class='u'>v</a>)
        return <a id='543' tid='542' class='u'>v</a></a>

    <a id='549' tid='548' class='u'>cached</a> = <a id='561' tid='560' class='u'>tableLookup</a>(<a id='559' tid='558' class='u'>table</a>, <a id='557' tid='556' class='u'>len</a>(<a id='555' tid='554' class='u'>s1</a>), <a id='553' tid='552' class='u'>len</a>(<a id='551' tid='550' class='u'>s2</a>))
    if (<a id='567' tid='566' class='u'>cached</a> <a id='563' tid='562' class='u'>&lt;&gt;</a> <a id='565' tid='564' class='u'>None</a>):
        return <a id='569' tid='568' class='u'>cached</a>

    if <a id='575' tid='574' class='u'>s1</a> <a id='571' tid='570' class='u'>==</a> <a id='573' tid='572' class='u'>&#39;&#39;</a>:
        return <a id='581' tid='580' class='u'>memo</a>(<a id='579' tid='578' class='u'>len</a>(<a id='577' tid='576' class='u'>s2</a>))
    elif <a id='587' tid='586' class='u'>s2</a> <a id='583' tid='582' class='u'>==</a> <a id='585' tid='584' class='u'>&#39;&#39;</a>:
        return <a id='593' tid='592' class='u'>memo</a>(<a id='591' tid='590' class='u'>len</a>(<a id='589' tid='588' class='u'>s1</a>))
    else:
        if <a id='601' tid='600' class='u'>s1</a>[<a id='603' tid='602' class='u'>0</a>] <a id='595' tid='594' class='u'>==</a> <a id='599' tid='598' class='u'>s2</a>[<a id='597' tid='596' class='u'>0</a>]:
            <a id='605' tid='604' class='u'>d0</a> = <a id='607' tid='606' class='u'>0</a>
        elif <a id='619' tid='618' class='u'>s1</a>[<a id='621' tid='620' class='u'>0</a>].<a id='617' tid='616' class='u'>lower</a>() <a id='609' tid='608' class='u'>==</a> <a id='613' tid='612' class='u'>s2</a>[<a id='611' tid='610' class='u'>0</a>].<a id='615' tid='614' class='u'>lower</a>():
            <a id='623' tid='622' class='u'>d0</a> = <a id='625' tid='624' class='u'>1</a>
        else:
            <a id='627' tid='626' class='u'>d0</a> = <a id='629' tid='628' class='u'>2</a>

        <a id='631' tid='630' class='u'>d0</a> = <a id='647' tid='646' class='u'>d0</a> <a id='633' tid='632' class='u'>+</a> <a id='635' tid='634' class='u'>dist1</a>(<a id='637' tid='636' class='u'>table</a>, <a id='639' tid='638' class='u'>s1</a>[<a id='641' tid='640' class='u'>1</a>:], <a id='643' tid='642' class='u'>s2</a>[<a id='645' tid='644' class='u'>1</a>:])
        <a id='649' tid='648' class='u'>d1</a> = <a id='663' tid='662' class='u'>1</a> <a id='651' tid='650' class='u'>+</a> <a id='653' tid='652' class='u'>dist1</a>(<a id='655' tid='654' class='u'>table</a>, <a id='657' tid='656' class='u'>s1</a>[<a id='659' tid='658' class='u'>1</a>:], <a id='661' tid='660' class='u'>s2</a>)
        <a id='665' tid='664' class='u'>d2</a> = <a id='679' tid='678' class='u'>1</a> <a id='667' tid='666' class='u'>+</a> <a id='669' tid='668' class='u'>dist1</a>(<a id='671' tid='670' class='u'>table</a>, <a id='673' tid='672' class='u'>s1</a>, <a id='675' tid='674' class='u'>s2</a>[<a id='677' tid='676' class='u'>1</a>:])
        return <a id='689' tid='688' class='u'>memo</a>(<a id='687' tid='686' class='u'>min</a>(<a id='685' tid='684' class='u'>d0</a>, <a id='683' tid='682' class='u'>d1</a>, <a id='681' tid='680' class='u'>d2</a>))</a>




#-------------------------------------------------------------
#                        diff of nodes
#-------------------------------------------------------------

<a id='695' tid='694' class='c'>stat.diff_count</a> = <a id='697' tid='696' class='u'>0</a>
<a id='1331' tid='1330' class='c'>def <a id='1329' tid='1328' class='c'>diff_node</a>(<a id='709' tid='708' class='u'>node1</a>, <a id='707' tid='706' class='u'>node2</a>, <a id='705' tid='704' class='u'>env1</a>, <a id='703' tid='702' class='u'>env2</a>, <a id='701' tid='700' class='u'>depth</a>, <a id='699' tid='698' class='u'>move</a>):

    # try substructural diff
    <a id='765' tid='764' class='c'>def <a id='763' tid='762' class='u'>trysub</a>((<a id='713' tid='712' class='u'>changes</a>, <a id='711' tid='710' class='u'>cost</a>)):
        if <a id='715' tid='714' class='u'>not</a> <a id='717' tid='716' class='u'>move</a>:
            return (<a id='721' tid='720' class='u'>changes</a>, <a id='719' tid='718' class='u'>cost</a>)
        elif <a id='729' tid='728' class='c'>can_move</a>(<a id='727' tid='726' class='u'>node1</a>, <a id='725' tid='724' class='u'>node2</a>, <a id='723' tid='722' class='u'>cost</a>):
            return (<a id='733' tid='732' class='u'>changes</a>, <a id='731' tid='730' class='u'>cost</a>)
        else:
            <a id='735' tid='734' class='u'>mc1</a> = <a id='749' tid='748' class='c'>diff_subnode</a>(<a id='747' tid='746' class='u'>node1</a>, <a id='745' tid='744' class='u'>node2</a>, <a id='743' tid='742' class='u'>env1</a>, <a id='741' tid='740' class='u'>env2</a>, <a id='739' tid='738' class='u'>depth</a>, <a id='737' tid='736' class='u'>move</a>)
            if <a id='755' tid='754' class='u'>mc1</a> <a id='751' tid='750' class='u'>&lt;&gt;</a> <a id='753' tid='752' class='u'>None</a>:
                return <a id='757' tid='756' class='u'>mc1</a>
            else:
                return (<a id='761' tid='760' class='u'>changes</a>, <a id='759' tid='758' class='u'>cost</a></a>)

    if <a id='781' tid='780' class='c'>isinstance</a>(<a id='779' tid='778' class='u'>node1</a>, <a id='777' tid='776' class='u'>list</a>) <a id='767' tid='766' class='u'>and</a> <a id='769' tid='768' class='u'>not</a> <a id='771' tid='770' class='c'>isinstance</a>(<a id='773' tid='772' class='u'>node2</a>, <a id='775' tid='774' class='u'>list</a>):
        return <a id='795' tid='794' class='c'>diff_node</a>(<a id='793' tid='792' class='u'>node1</a>, [<a id='791' tid='790' class='u'>node2</a>], <a id='789' tid='788' class='u'>env1</a>, <a id='787' tid='786' class='u'>env2</a>, <a id='785' tid='784' class='u'>depth</a>, <a id='783' tid='782' class='u'>move</a>)

    if <a id='805' tid='804' class='u'>not</a> <a id='807' tid='806' class='c'>isinstance</a>(<a id='809' tid='808' class='u'>node1</a>, <a id='811' tid='810' class='u'>list</a>) <a id='797' tid='796' class='u'>and</a> <a id='803' tid='802' class='c'>isinstance</a>(<a id='801' tid='800' class='u'>node2</a>, <a id='799' tid='798' class='u'>list</a>):
        return <a id='825' tid='824' class='c'>diff_node</a>([<a id='823' tid='822' class='u'>node1</a>], <a id='821' tid='820' class='u'>node2</a>, <a id='819' tid='818' class='u'>env1</a>, <a id='817' tid='816' class='u'>env2</a>, <a id='815' tid='814' class='u'>depth</a>, <a id='813' tid='812' class='u'>move</a>)

    if (<a id='839' tid='838' class='c'>isinstance</a>(<a id='837' tid='836' class='u'>node1</a>, <a id='835' tid='834' class='u'>list</a>) <a id='827' tid='826' class='u'>and</a> <a id='833' tid='832' class='c'>isinstance</a>(<a id='831' tid='830' class='u'>node2</a>, <a id='829' tid='828' class='u'>list</a>)):
        <a id='841' tid='840' class='u'>node1</a> = <a id='845' tid='844' class='c'>serialize_if</a>(<a id='843' tid='842' class='u'>node1</a>)
        <a id='847' tid='846' class='u'>node2</a> = <a id='851' tid='850' class='c'>serialize_if</a>(<a id='849' tid='848' class='u'>node2</a>)
        <a id='853' tid='852' class='u'>table</a> = <a id='863' tid='862' class='c'>create_table</a>(<a id='861' tid='860' class='u'>len</a>(<a id='859' tid='858' class='u'>node1</a>), <a id='857' tid='856' class='u'>len</a>(<a id='855' tid='854' class='u'>node2</a>))
        return <a id='879' tid='878' class='c'>diff_list</a>(<a id='877' tid='876' class='u'>table</a>, <a id='875' tid='874' class='u'>node1</a>, <a id='873' tid='872' class='u'>node2</a>, <a id='871' tid='870' class='u'>env1</a>, <a id='869' tid='868' class='u'>env2</a>, <a id='867' tid='866' class='u'>0</a>, <a id='865' tid='864' class='u'>move</a>)

    # statistics
    <a id='881' tid='880' class='c'>stat.diff_count</a> <a id='885' tid='884' class='u'>+</a>= <a id='883' tid='882' class='u'>1</a>
    if <a id='891' tid='890' class='c'>stat.diff_count</a> <a id='895' tid='894' class='u'>%</a> <a id='893' tid='892' class='u'>1000</a> <a id='887' tid='886' class='u'>==</a> <a id='889' tid='888' class='u'>0</a>:
        <a id='897' tid='896' class='u'>dot</a>()

    if <a id='903' tid='902' class='u'>node1</a> <a id='899' tid='898' class='u'>==</a> <a id='901' tid='900' class='u'>node2</a>:
        return (<a id='913' tid='912' class='c'>mod_node</a>(<a id='911' tid='910' class='u'>node1</a>, <a id='909' tid='908' class='u'>node2</a>, <a id='907' tid='906' class='u'>0</a>), <a id='905' tid='904' class='u'>0</a>)

    if <a id='927' tid='926' class='c'>isinstance</a>(<a id='925' tid='924' class='u'>node1</a>, <a id='923' tid='922' class='u'>Num</a>) <a id='915' tid='914' class='u'>and</a> <a id='921' tid='920' class='c'>isinstance</a>(<a id='919' tid='918' class='u'>node2</a>, <a id='917' tid='916' class='u'>Num</a>):
        if <a id='933' tid='932' class='u'>node1.n</a> <a id='929' tid='928' class='u'>==</a> <a id='931' tid='930' class='u'>node2.n</a>:
            return (<a id='943' tid='942' class='c'>mod_node</a>(<a id='941' tid='940' class='u'>node1</a>, <a id='939' tid='938' class='u'>node2</a>, <a id='937' tid='936' class='u'>0</a>), <a id='935' tid='934' class='u'>0</a>)
        else:
            return (<a id='953' tid='952' class='c'>mod_node</a>(<a id='951' tid='950' class='u'>node1</a>, <a id='949' tid='948' class='u'>node2</a>, <a id='947' tid='946' class='u'>1</a>), <a id='945' tid='944' class='u'>1</a>)

    if <a id='967' tid='966' class='c'>isinstance</a>(<a id='965' tid='964' class='u'>node1</a>, <a id='963' tid='962' class='u'>Str</a>) <a id='955' tid='954' class='u'>and</a> <a id='961' tid='960' class='c'>isinstance</a>(<a id='959' tid='958' class='u'>node2</a>, <a id='957' tid='956' class='u'>Str</a>):
        <a id='969' tid='968' class='u'>cost</a> = <a id='975' tid='974' class='c'>str_dist</a>(<a id='973' tid='972' class='u'>node1.s</a>, <a id='971' tid='970' class='u'>node2.s</a>)
        return (<a id='985' tid='984' class='c'>mod_node</a>(<a id='983' tid='982' class='u'>node1</a>, <a id='981' tid='980' class='u'>node2</a>, <a id='979' tid='978' class='u'>cost</a>), <a id='977' tid='976' class='u'>cost</a>)

    if (<a id='999' tid='998' class='c'>isinstance</a>(<a id='997' tid='996' class='u'>node1</a>, <a id='995' tid='994' class='u'>Name</a>) <a id='987' tid='986' class='u'>and</a> <a id='993' tid='992' class='c'>isinstance</a>(<a id='991' tid='990' class='u'>node2</a>, <a id='989' tid='988' class='u'>Name</a>)):
        <a id='1001' tid='1000' class='u'>v1</a> = <a id='1007' tid='1006' class='u'>lookup</a>(<a id='1005' tid='1004' class='u'>node1.id</a>, <a id='1003' tid='1002' class='u'>env1</a>)
        <a id='1009' tid='1008' class='u'>v2</a> = <a id='1015' tid='1014' class='u'>lookup</a>(<a id='1013' tid='1012' class='u'>node2.id</a>, <a id='1011' tid='1010' class='u'>env2</a>)
        if <a id='1037' tid='1036' class='u'>v1</a> <a id='1033' tid='1032' class='u'>&lt;&gt;</a> <a id='1035' tid='1034' class='u'>v2</a> <a id='1017' tid='1016' class='u'>or</a> (<a id='1031' tid='1030' class='u'>v1</a> <a id='1027' tid='1026' class='u'>==</a> <a id='1029' tid='1028' class='u'>None</a> <a id='1019' tid='1018' class='u'>and</a> <a id='1025' tid='1024' class='u'>v2</a> <a id='1021' tid='1020' class='u'>==</a> <a id='1023' tid='1022' class='u'>None</a>):
            <a id='1039' tid='1038' class='u'>cost</a> = <a id='1045' tid='1044' class='c'>str_dist</a>(<a id='1043' tid='1042' class='u'>node1.id</a>, <a id='1041' tid='1040' class='u'>node2.id</a>)
            return (<a id='1055' tid='1054' class='c'>mod_node</a>(<a id='1053' tid='1052' class='u'>node1</a>, <a id='1051' tid='1050' class='u'>node2</a>, <a id='1049' tid='1048' class='u'>cost</a>), <a id='1047' tid='1046' class='u'>cost</a>)
        else:                           # same variable
            return (<a id='1065' tid='1064' class='c'>mod_node</a>(<a id='1063' tid='1062' class='u'>node1</a>, <a id='1061' tid='1060' class='u'>node2</a>, <a id='1059' tid='1058' class='u'>0</a>), <a id='1057' tid='1056' class='u'>0</a>)

    if (<a id='1109' tid='1108' class='c'>isinstance</a>(<a id='1107' tid='1106' class='u'>node1</a>, <a id='1105' tid='1104' class='u'>Attribute</a>) <a id='1097' tid='1096' class='u'>and</a> <a id='1103' tid='1102' class='c'>isinstance</a>(<a id='1101' tid='1100' class='u'>node2</a>, <a id='1099' tid='1098' class='u'>Name</a>) <a id='1067' tid='1066' class='u'>or</a>
        <a id='1095' tid='1094' class='c'>isinstance</a>(<a id='1093' tid='1092' class='u'>node1</a>, <a id='1091' tid='1090' class='u'>Name</a>) <a id='1083' tid='1082' class='u'>and</a> <a id='1089' tid='1088' class='c'>isinstance</a>(<a id='1087' tid='1086' class='u'>node2</a>, <a id='1085' tid='1084' class='u'>Attribute</a>) or
        <a id='1081' tid='1080' class='c'>isinstance</a>(<a id='1079' tid='1078' class='u'>node1</a>, <a id='1077' tid='1076' class='u'>Attribute</a>) <a id='1069' tid='1068' class='u'>and</a> <a id='1075' tid='1074' class='c'>isinstance</a>(<a id='1073' tid='1072' class='u'>node2</a>, <a id='1071' tid='1070' class='u'>Attribute</a>)):
        <a id='1111' tid='1110' class='u'>s1</a> = <a id='1115' tid='1114' class='c'>attr_to_str</a>(<a id='1113' tid='1112' class='u'>node1</a>)
        <a id='1117' tid='1116' class='u'>s2</a> = <a id='1121' tid='1120' class='c'>attr_to_str</a>(<a id='1119' tid='1118' class='u'>node2</a>)
        if <a id='1135' tid='1134' class='u'>s1</a> <a id='1131' tid='1130' class='u'>&lt;&gt;</a> <a id='1133' tid='1132' class='u'>None</a> <a id='1123' tid='1122' class='u'>and</a> <a id='1129' tid='1128' class='u'>s2</a> <a id='1125' tid='1124' class='u'>&lt;&gt;</a> <a id='1127' tid='1126' class='u'>None</a>:
            <a id='1137' tid='1136' class='u'>cost</a> = <a id='1143' tid='1142' class='c'>str_dist</a>(<a id='1141' tid='1140' class='u'>s1</a>, <a id='1139' tid='1138' class='u'>s2</a>)
            return (<a id='1153' tid='1152' class='c'>mod_node</a>(<a id='1151' tid='1150' class='u'>node1</a>, <a id='1149' tid='1148' class='u'>node2</a>, <a id='1147' tid='1146' class='u'>cost</a>), <a id='1145' tid='1144' class='u'>cost</a>)
        # else fall through for things like f(x).y vs x.y

    if <a id='1167' tid='1166' class='c'>isinstance</a>(<a id='1165' tid='1164' class='u'>node1</a>, <a id='1163' tid='1162' class='u'>Module</a>) <a id='1155' tid='1154' class='u'>and</a> <a id='1161' tid='1160' class='c'>isinstance</a>(<a id='1159' tid='1158' class='u'>node2</a>, <a id='1157' tid='1156' class='u'>Module</a>):
        return <a id='1181' tid='1180' class='c'>diff_node</a>(<a id='1179' tid='1178' class='u'>node1.body</a>, <a id='1177' tid='1176' class='u'>node2.body</a>, <a id='1175' tid='1174' class='u'>env1</a>, <a id='1173' tid='1172' class='u'>env2</a>, <a id='1171' tid='1170' class='u'>depth</a>, <a id='1169' tid='1168' class='u'>move</a>)

    # other AST nodes
    if (<a id='1205' tid='1204' class='c'>isinstance</a>(<a id='1203' tid='1202' class='u'>node1</a>, <a id='1201' tid='1200' class='u'>AST</a>) <a id='1183' tid='1182' class='u'>and</a> <a id='1199' tid='1198' class='c'>isinstance</a>(<a id='1197' tid='1196' class='u'>node2</a>, <a id='1195' tid='1194' class='u'>AST</a>) and
        <a id='1191' tid='1190' class='u'>type</a>(<a id='1193' tid='1192' class='u'>node1</a>) <a id='1185' tid='1184' class='u'>==</a> <a id='1189' tid='1188' class='u'>type</a>(<a id='1187' tid='1186' class='u'>node2</a>)):

        <a id='1207' tid='1206' class='u'>fs1</a> = <a id='1211' tid='1210' class='c'>node_fields</a>(<a id='1209' tid='1208' class='u'>node1</a>)
        <a id='1213' tid='1212' class='u'>fs2</a> = <a id='1217' tid='1216' class='c'>node_fields</a>(<a id='1215' tid='1214' class='u'>node2</a>)
        <a id='1219' tid='1218' class='u'>changes</a>, <a id='1221' tid='1220' class='u'>cost</a> = <a id='1225' tid='1224' class='u'>nil</a>, <a id='1223' tid='1222' class='u'>0</a>

        for <a id='1227' tid='1226' class='u'>i</a> in <a id='1233' tid='1232' class='u'>xrange</a>(<a id='1231' tid='1230' class='u'>len</a>(<a id='1229' tid='1228' class='u'>fs1</a>)):
            (<a id='1235' tid='1234' class='u'>m</a>, <a id='1237' tid='1236' class='u'>c</a>) = <a id='1255' tid='1254' class='c'>diff_node</a>(<a id='1253' tid='1252' class='u'>fs1</a>[<a id='1251' tid='1250' class='u'>i</a>], <a id='1249' tid='1248' class='u'>fs2</a>[<a id='1247' tid='1246' class='u'>i</a>], <a id='1245' tid='1244' class='u'>env1</a>, <a id='1243' tid='1242' class='u'>env2</a>, <a id='1241' tid='1240' class='u'>depth</a>, <a id='1239' tid='1238' class='u'>move</a>)
            <a id='1257' tid='1256' class='u'>changes</a> = <a id='1263' tid='1262' class='u'>append</a>(<a id='1261' tid='1260' class='u'>m</a>, <a id='1259' tid='1258' class='u'>changes</a>)
            <a id='1265' tid='1264' class='u'>cost</a> <a id='1269' tid='1268' class='u'>+</a>= <a id='1267' tid='1266' class='u'>c</a>

        return <a id='1275' tid='1274' class='u'>trysub</a>((<a id='1273' tid='1272' class='u'>changes</a>, <a id='1271' tid='1270' class='u'>cost</a>))

    if (<a id='1293' tid='1292' class='u'>type</a>(<a id='1295' tid='1294' class='u'>node1</a>) <a id='1287' tid='1286' class='u'>==</a> <a id='1291' tid='1290' class='u'>type</a>(<a id='1289' tid='1288' class='u'>node2</a>) <a id='1277' tid='1276' class='u'>and</a>
             <a id='1285' tid='1284' class='c'>is_empty_container</a>(<a id='1283' tid='1282' class='u'>node1</a>) and <a id='1281' tid='1280' class='c'>is_empty_container</a>(<a id='1279' tid='1278' class='u'>node2</a>)):
        return (<a id='1305' tid='1304' class='c'>mod_node</a>(<a id='1303' tid='1302' class='u'>node1</a>, <a id='1301' tid='1300' class='u'>node2</a>, <a id='1299' tid='1298' class='u'>0</a>), <a id='1297' tid='1296' class='u'>0</a>)

    # all unmatched types and unequal values
    return <a id='1327' tid='1326' class='u'>trysub</a>((<a id='1325' tid='1324' class='u'>append</a>(<a id='1323' tid='1322' class='c'>del_node</a>(<a id='1321' tid='1320' class='u'>node1</a>), <a id='1319' tid='1318' class='c'>ins_node</a>(<a id='1317' tid='1316' class='u'>node2</a>)),
                   <a id='1313' tid='1312' class='c'>node_size</a>(<a id='1315' tid='1314' class='u'>node1</a>) <a id='1307' tid='1306' class='u'>+</a> <a id='1309' tid='1308' class='c'>node_size</a>(<a id='1311' tid='1310' class='u'>node2</a>)))</a>



########################## diff of a list ##########################

# diff_list is the main part of dynamic programming

<a id='1765' tid='1764' class='c'>def <a id='1763' tid='1762' class='c'>diff_list</a>(<a id='1345' tid='1344' class='u'>table</a>, <a id='1343' tid='1342' class='u'>ls1</a>, <a id='1341' tid='1340' class='u'>ls2</a>, <a id='1339' tid='1338' class='u'>env1</a>, <a id='1337' tid='1336' class='u'>env2</a>, <a id='1335' tid='1334' class='u'>depth</a>, <a id='1333' tid='1332' class='u'>move</a>):

    <a id='1367' tid='1366' class='u'>def <a id='1365' tid='1364' class='u'>memo</a>(<a id='1347' tid='1346' class='u'>v</a>):
        <a id='1361' tid='1360' class='u'>tablePut</a>(<a id='1359' tid='1358' class='u'>table</a>, <a id='1357' tid='1356' class='u'>len</a>(<a id='1355' tid='1354' class='u'>ls1</a>), <a id='1353' tid='1352' class='u'>len</a>(<a id='1351' tid='1350' class='u'>ls2</a>), <a id='1349' tid='1348' class='u'>v</a>)
        return <a id='1363' tid='1362' class='u'>v</a></a>

    <a id='1643' tid='1642' class='c'>def <a id='1641' tid='1640' class='u'>guess</a>(<a id='1377' tid='1376' class='u'>table</a>, <a id='1375' tid='1374' class='u'>ls1</a>, <a id='1373' tid='1372' class='u'>ls2</a>, <a id='1371' tid='1370' class='u'>env1</a>, <a id='1369' tid='1368' class='u'>env2</a>):
        (<a id='1379' tid='1378' class='u'>m0</a>, <a id='1381' tid='1380' class='u'>c0</a>) = <a id='1399' tid='1398' class='c'>diff_node</a>(<a id='1397' tid='1396' class='u'>ls1</a>[<a id='1395' tid='1394' class='u'>0</a>], <a id='1393' tid='1392' class='u'>ls2</a>[<a id='1391' tid='1390' class='u'>0</a>], <a id='1389' tid='1388' class='u'>env1</a>, <a id='1387' tid='1386' class='u'>env2</a>, <a id='1385' tid='1384' class='u'>depth</a>, <a id='1383' tid='1382' class='u'>move</a>)
        (<a id='1401' tid='1400' class='u'>m1</a>, <a id='1403' tid='1402' class='u'>c1</a>) = <a id='1423' tid='1422' class='c'>diff_list</a>(<a id='1421' tid='1420' class='u'>table</a>, <a id='1419' tid='1418' class='u'>ls1</a>[<a id='1417' tid='1416' class='u'>1</a>:], <a id='1415' tid='1414' class='u'>ls2</a>[<a id='1413' tid='1412' class='u'>1</a>:], <a id='1411' tid='1410' class='u'>env1</a>, <a id='1409' tid='1408' class='u'>env2</a>, <a id='1407' tid='1406' class='u'>depth</a>, <a id='1405' tid='1404' class='u'>move</a>)
        <a id='1425' tid='1424' class='u'>cost1</a> = <a id='1431' tid='1430' class='u'>c1</a> <a id='1427' tid='1426' class='u'>+</a> <a id='1429' tid='1428' class='u'>c0</a>

        if ((<a id='1465' tid='1464' class='c'>is_frame</a>(<a id='1463' tid='1462' class='u'>ls1</a>[<a id='1461' tid='1460' class='u'>0</a>]) <a id='1433' tid='1432' class='u'>and</a>
             <a id='1459' tid='1458' class='c'>is_frame</a>(<a id='1457' tid='1456' class='u'>ls2</a>[<a id='1455' tid='1454' class='u'>0</a>]) and
             <a id='1445' tid='1444' class='u'>not</a> <a id='1447' tid='1446' class='u'>nodeFramed</a>(<a id='1449' tid='1448' class='u'>ls1</a>[<a id='1451' tid='1450' class='u'>0</a>], <a id='1453' tid='1452' class='u'>m0</a>) and
             <a id='1435' tid='1434' class='u'>not</a> <a id='1437' tid='1436' class='u'>nodeFramed</a>(<a id='1439' tid='1438' class='u'>ls2</a>[<a id='1441' tid='1440' class='u'>0</a>], <a id='1443' tid='1442' class='u'>m0</a>))):
            <a id='1467' tid='1466' class='c'>frame_change</a> = <a id='1479' tid='1478' class='c'>mod_node</a>(<a id='1477' tid='1476' class='u'>ls1</a>[<a id='1475' tid='1474' class='u'>0</a>], <a id='1473' tid='1472' class='u'>ls2</a>[<a id='1471' tid='1470' class='u'>0</a>], <a id='1469' tid='1468' class='u'>c0</a>)
        else:
            <a id='1481' tid='1480' class='c'>frame_change</a> = <a id='1483' tid='1482' class='u'>nil</a>

        # short cut 1 (func and classes with same names)
        if <a id='1495' tid='1494' class='c'>can_move</a>(<a id='1493' tid='1492' class='u'>ls1</a>[<a id='1491' tid='1490' class='u'>0</a>], <a id='1489' tid='1488' class='u'>ls2</a>[<a id='1487' tid='1486' class='u'>0</a>], <a id='1485' tid='1484' class='u'>c0</a>):
            return (<a id='1505' tid='1504' class='u'>append</a>(<a id='1503' tid='1502' class='c'>frame_change</a>, <a id='1501' tid='1500' class='u'>m0</a>, <a id='1499' tid='1498' class='u'>m1</a>), <a id='1497' tid='1496' class='u'>cost1</a>)

        else:  # do more work
            (<a id='1507' tid='1506' class='u'>m2</a>, <a id='1509' tid='1508' class='u'>c2</a>) = <a id='1527' tid='1526' class='c'>diff_list</a>(<a id='1525' tid='1524' class='u'>table</a>, <a id='1523' tid='1522' class='u'>ls1</a>[<a id='1521' tid='1520' class='u'>1</a>:], <a id='1519' tid='1518' class='u'>ls2</a>, <a id='1517' tid='1516' class='u'>env1</a>, <a id='1515' tid='1514' class='u'>env2</a>, <a id='1513' tid='1512' class='u'>depth</a>, <a id='1511' tid='1510' class='u'>move</a>)
            (<a id='1529' tid='1528' class='u'>m3</a>, <a id='1531' tid='1530' class='u'>c3</a>) = <a id='1549' tid='1548' class='c'>diff_list</a>(<a id='1547' tid='1546' class='u'>table</a>, <a id='1545' tid='1544' class='u'>ls1</a>, <a id='1543' tid='1542' class='u'>ls2</a>[<a id='1541' tid='1540' class='u'>1</a>:], <a id='1539' tid='1538' class='u'>env1</a>, <a id='1537' tid='1536' class='u'>env2</a>, <a id='1535' tid='1534' class='u'>depth</a>, <a id='1533' tid='1532' class='u'>move</a>)
            <a id='1551' tid='1550' class='u'>cost2</a> = <a id='1561' tid='1560' class='u'>c2</a> <a id='1553' tid='1552' class='u'>+</a> <a id='1555' tid='1554' class='c'>node_size</a>(<a id='1557' tid='1556' class='u'>ls1</a>[<a id='1559' tid='1558' class='u'>0</a>])
            <a id='1563' tid='1562' class='u'>cost3</a> = <a id='1573' tid='1572' class='u'>c3</a> <a id='1565' tid='1564' class='u'>+</a> <a id='1567' tid='1566' class='c'>node_size</a>(<a id='1569' tid='1568' class='u'>ls2</a>[<a id='1571' tid='1570' class='u'>0</a>])

            if (<a id='1589' tid='1588' class='u'>not</a> <a id='1591' tid='1590' class='c'>different_def</a>(<a id='1593' tid='1592' class='u'>ls1</a>[<a id='1595' tid='1594' class='u'>0</a>], <a id='1597' tid='1596' class='u'>ls2</a>[<a id='1599' tid='1598' class='u'>0</a>]) <a id='1575' tid='1574' class='u'>and</a>
                <a id='1587' tid='1586' class='u'>cost1</a> <a id='1583' tid='1582' class='u'>&lt;=</a> <a id='1585' tid='1584' class='u'>cost2</a> and <a id='1581' tid='1580' class='u'>cost1</a> <a id='1577' tid='1576' class='u'>&lt;=</a> <a id='1579' tid='1578' class='u'>cost3</a>):
                return (<a id='1609' tid='1608' class='u'>append</a>(<a id='1607' tid='1606' class='c'>frame_change</a>, <a id='1605' tid='1604' class='u'>m0</a>, <a id='1603' tid='1602' class='u'>m1</a>), <a id='1601' tid='1600' class='u'>cost1</a>)
            elif (<a id='1615' tid='1614' class='u'>cost2</a> <a id='1611' tid='1610' class='u'>&lt;=</a> <a id='1613' tid='1612' class='u'>cost3</a>):
                return (<a id='1627' tid='1626' class='u'>append</a>(<a id='1625' tid='1624' class='c'>del_node</a>(<a id='1623' tid='1622' class='u'>ls1</a>[<a id='1621' tid='1620' class='u'>0</a>]), <a id='1619' tid='1618' class='u'>m2</a>), <a id='1617' tid='1616' class='u'>cost2</a>)
            else:
                return (<a id='1639' tid='1638' class='u'>append</a>(<a id='1637' tid='1636' class='c'>ins_node</a>(<a id='1635' tid='1634' class='u'>ls2</a>[<a id='1633' tid='1632' class='u'>0</a>]), <a id='1631' tid='1630' class='u'>m3</a>), <a id='1629' tid='1628' class='u'>cost3</a></a>)

    # cache look up
    <a id='1645' tid='1644' class='u'>cached</a> = <a id='1657' tid='1656' class='u'>tableLookup</a>(<a id='1655' tid='1654' class='u'>table</a>, <a id='1653' tid='1652' class='u'>len</a>(<a id='1651' tid='1650' class='u'>ls1</a>), <a id='1649' tid='1648' class='u'>len</a>(<a id='1647' tid='1646' class='u'>ls2</a>))
    if (<a id='1663' tid='1662' class='u'>cached</a> <a id='1659' tid='1658' class='u'>&lt;&gt;</a> <a id='1661' tid='1660' class='u'>None</a>):
        return <a id='1665' tid='1664' class='u'>cached</a>

    if (<a id='1675' tid='1674' class='u'>ls1</a> <a id='1673' tid='1672' class='u'>==</a> [] <a id='1667' tid='1666' class='u'>and</a> <a id='1671' tid='1670' class='u'>ls2</a> <a id='1669' tid='1668' class='u'>==</a> []):
        return <a id='1681' tid='1680' class='u'>memo</a>((<a id='1679' tid='1678' class='u'>nil</a>, <a id='1677' tid='1676' class='u'>0</a>))

    elif (<a id='1691' tid='1690' class='u'>ls1</a> <a id='1689' tid='1688' class='u'>&lt;&gt;</a> [] <a id='1683' tid='1682' class='u'>and</a> <a id='1687' tid='1686' class='u'>ls2</a> <a id='1685' tid='1684' class='u'>&lt;&gt;</a> []):
        return <a id='1705' tid='1704' class='u'>memo</a>(<a id='1703' tid='1702' class='u'>guess</a>(<a id='1701' tid='1700' class='u'>table</a>, <a id='1699' tid='1698' class='u'>ls1</a>, <a id='1697' tid='1696' class='u'>ls2</a>, <a id='1695' tid='1694' class='u'>env1</a>, <a id='1693' tid='1692' class='u'>env2</a>))

    elif <a id='1709' tid='1708' class='u'>ls1</a> <a id='1707' tid='1706' class='u'>==</a> []:
        <a id='1711' tid='1710' class='u'>d</a> = <a id='1713' tid='1712' class='u'>nil</a>
        for <a id='1715' tid='1714' class='u'>n</a> in <a id='1717' tid='1716' class='u'>ls2</a>:
            <a id='1719' tid='1718' class='u'>d</a> = <a id='1727' tid='1726' class='u'>append</a>(<a id='1725' tid='1724' class='c'>ins_node</a>(<a id='1723' tid='1722' class='u'>n</a>), <a id='1721' tid='1720' class='u'>d</a>)
        return <a id='1735' tid='1734' class='u'>memo</a>((<a id='1733' tid='1732' class='u'>d</a>, <a id='1731' tid='1730' class='c'>node_size</a>(<a id='1729' tid='1728' class='u'>ls2</a>)))

    else: # ls2 == []:
        <a id='1737' tid='1736' class='u'>d</a> = <a id='1739' tid='1738' class='u'>nil</a>
        for <a id='1741' tid='1740' class='u'>n</a> in <a id='1743' tid='1742' class='u'>ls1</a>:
            <a id='1745' tid='1744' class='u'>d</a> = <a id='1753' tid='1752' class='u'>append</a>(<a id='1751' tid='1750' class='c'>del_node</a>(<a id='1749' tid='1748' class='u'>n</a>), <a id='1747' tid='1746' class='u'>d</a>)
        return <a id='1761' tid='1760' class='u'>memo</a>((<a id='1759' tid='1758' class='u'>d</a>, <a id='1757' tid='1756' class='c'>node_size</a>(<a id='1755' tid='1754' class='u'>ls1</a>)))</a>




###################### diff into a subnode #######################

# Subnode diff is only used in the moving phase. There is no
# need to compare the substructure of two nodes in the first
# run, because they will be reconsidered if we just consider
# them to be complete deletion and insertions.

<a id='2071' tid='2070' class='c'>def <a id='2069' tid='2068' class='c'>diff_subnode</a>(<a id='1777' tid='1776' class='u'>node1</a>, <a id='1775' tid='1774' class='u'>node2</a>, <a id='1773' tid='1772' class='u'>env1</a>, <a id='1771' tid='1770' class='u'>env2</a>, <a id='1769' tid='1768' class='u'>depth</a>, <a id='1767' tid='1766' class='u'>move</a>):

    if (<a id='1801' tid='1800' class='u'>depth</a> <a id='1797' tid='1796' class='u'>&gt;=</a> <a id='1799' tid='1798' class='u'>FRAME_DEPTH</a> <a id='1779' tid='1778' class='u'>or</a>
        <a id='1793' tid='1792' class='c'>node_size</a>(<a id='1795' tid='1794' class='u'>node1</a>) <a id='1789' tid='1788' class='u'>&lt;</a> <a id='1791' tid='1790' class='u'>FRAME_SIZE</a> or
        <a id='1785' tid='1784' class='c'>node_size</a>(<a id='1787' tid='1786' class='u'>node2</a>) <a id='1781' tid='1780' class='u'>&lt;</a> <a id='1783' tid='1782' class='u'>FRAME_SIZE</a>):
        return <a id='1803' tid='1802' class='u'>None</a>

    if <a id='1817' tid='1816' class='c'>isinstance</a>(<a id='1815' tid='1814' class='u'>node1</a>, <a id='1813' tid='1812' class='u'>AST</a>) <a id='1805' tid='1804' class='u'>and</a> <a id='1811' tid='1810' class='c'>isinstance</a>(<a id='1809' tid='1808' class='u'>node2</a>, <a id='1807' tid='1806' class='u'>AST</a>):

        if <a id='1825' tid='1824' class='c'>node_size</a>(<a id='1827' tid='1826' class='u'>node1</a>) <a id='1819' tid='1818' class='u'>==</a> <a id='1823' tid='1822' class='c'>node_size</a>(<a id='1821' tid='1820' class='u'>node2</a>):
            return <a id='1829' tid='1828' class='u'>None</a>

        if <a id='1835' tid='1834' class='c'>isinstance</a>(<a id='1833' tid='1832' class='u'>node1</a>, <a id='1831' tid='1830' class='u'>Expr</a>):
            <a id='1837' tid='1836' class='u'>node1</a> = <a id='1839' tid='1838' class='u'>node1.value</a>

        if <a id='1845' tid='1844' class='c'>isinstance</a>(<a id='1843' tid='1842' class='u'>node2</a>, <a id='1841' tid='1840' class='u'>Expr</a>):
            <a id='1847' tid='1846' class='u'>node2</a> = <a id='1849' tid='1848' class='u'>node2.value</a>

        if (<a id='1857' tid='1856' class='c'>node_size</a>(<a id='1859' tid='1858' class='u'>node1</a>) <a id='1851' tid='1850' class='u'>&lt;</a> <a id='1855' tid='1854' class='c'>node_size</a>(<a id='1853' tid='1852' class='u'>node2</a>)):
            for <a id='1861' tid='1860' class='u'>f</a> in <a id='1865' tid='1864' class='c'>node_fields</a>(<a id='1863' tid='1862' class='u'>node2</a>):
                (<a id='1867' tid='1866' class='u'>m0</a>, <a id='1869' tid='1868' class='u'>c0</a>) = <a id='1887' tid='1886' class='c'>diff_node</a>(<a id='1885' tid='1884' class='u'>node1</a>, <a id='1883' tid='1882' class='u'>f</a>, <a id='1881' tid='1880' class='u'>env1</a>, <a id='1879' tid='1878' class='u'>env2</a>, <a id='1877' tid='1876' class='u'>depth</a><a id='1873' tid='1872' class='u'>+</a><a id='1875' tid='1874' class='u'>1</a>, <a id='1871' tid='1870' class='u'>move</a>)
                if <a id='1895' tid='1894' class='c'>can_move</a>(<a id='1893' tid='1892' class='u'>node1</a>, <a id='1891' tid='1890' class='u'>f</a>, <a id='1889' tid='1888' class='u'>c0</a>):
                    if <a id='1897' tid='1896' class='u'>not</a> <a id='1899' tid='1898' class='c'>isinstance</a>(<a id='1901' tid='1900' class='u'>f</a>, <a id='1903' tid='1902' class='u'>list</a>):
                        <a id='1905' tid='1904' class='u'>m1</a> = <a id='1913' tid='1912' class='c'>mod_node</a>(<a id='1911' tid='1910' class='u'>node1</a>, <a id='1909' tid='1908' class='u'>f</a>, <a id='1907' tid='1906' class='u'>c0</a>)
                    else:
                        <a id='1915' tid='1914' class='u'>m1</a> = <a id='1917' tid='1916' class='u'>nil</a>
                    <a id='1919' tid='1918' class='u'>framecost</a> = <a id='1927' tid='1926' class='c'>node_size</a>(<a id='1929' tid='1928' class='u'>node2</a>) <a id='1921' tid='1920' class='u'>-</a> <a id='1923' tid='1922' class='c'>node_size</a>(<a id='1925' tid='1924' class='u'>node1</a>)
                    <a id='1931' tid='1930' class='u'>m2</a> = <a id='1943' tid='1942' class='u'>loner</a>(<a id='1941' tid='1940' class='u'>Change</a>(<a id='1939' tid='1938' class='u'>None</a>, <a id='1937' tid='1936' class='u'>node2</a>, <a id='1935' tid='1934' class='u'>framecost</a>, <a id='1933' tid='1932' class='u'>True</a>))
                    return (<a id='1957' tid='1956' class='u'>append</a>(<a id='1955' tid='1954' class='u'>m2</a>, <a id='1953' tid='1952' class='u'>m1</a>, <a id='1951' tid='1950' class='u'>m0</a>), <a id='1949' tid='1948' class='u'>c0</a> <a id='1945' tid='1944' class='u'>+</a> <a id='1947' tid='1946' class='u'>framecost</a>)

        if (<a id='1965' tid='1964' class='c'>node_size</a>(<a id='1967' tid='1966' class='u'>node1</a>) <a id='1959' tid='1958' class='u'>&gt;</a> <a id='1963' tid='1962' class='c'>node_size</a>(<a id='1961' tid='1960' class='u'>node2</a>)):
            for <a id='1969' tid='1968' class='u'>f</a> in <a id='1973' tid='1972' class='c'>node_fields</a>(<a id='1971' tid='1970' class='u'>node1</a>):
                (<a id='1975' tid='1974' class='u'>m0</a>, <a id='1977' tid='1976' class='u'>c0</a>) = <a id='1995' tid='1994' class='c'>diff_node</a>(<a id='1993' tid='1992' class='u'>f</a>, <a id='1991' tid='1990' class='u'>node2</a>, <a id='1989' tid='1988' class='u'>env1</a>, <a id='1987' tid='1986' class='u'>env2</a>, <a id='1985' tid='1984' class='u'>depth</a><a id='1981' tid='1980' class='u'>+</a><a id='1983' tid='1982' class='u'>1</a>, <a id='1979' tid='1978' class='u'>move</a>)
                if <a id='2003' tid='2002' class='c'>can_move</a>(<a id='2001' tid='2000' class='u'>f</a>, <a id='1999' tid='1998' class='u'>node2</a>, <a id='1997' tid='1996' class='u'>c0</a>):
                    <a id='2005' tid='2004' class='u'>framecost</a> = <a id='2013' tid='2012' class='c'>node_size</a>(<a id='2015' tid='2014' class='u'>node1</a>) <a id='2007' tid='2006' class='u'>-</a> <a id='2009' tid='2008' class='c'>node_size</a>(<a id='2011' tid='2010' class='u'>node2</a>)
                    if <a id='2017' tid='2016' class='u'>not</a> <a id='2019' tid='2018' class='c'>isinstance</a>(<a id='2021' tid='2020' class='u'>f</a>, <a id='2023' tid='2022' class='u'>list</a>):
                        <a id='2025' tid='2024' class='u'>m1</a> = <a id='2033' tid='2032' class='c'>mod_node</a>(<a id='2031' tid='2030' class='u'>f</a>, <a id='2029' tid='2028' class='u'>node2</a>, <a id='2027' tid='2026' class='u'>c0</a>)
                    else:
                        <a id='2035' tid='2034' class='u'>m1</a> = <a id='2037' tid='2036' class='u'>nil</a>
                    <a id='2039' tid='2038' class='u'>m2</a> = <a id='2051' tid='2050' class='u'>loner</a>(<a id='2049' tid='2048' class='u'>Change</a>(<a id='2047' tid='2046' class='u'>node1</a>, <a id='2045' tid='2044' class='u'>None</a>, <a id='2043' tid='2042' class='u'>framecost</a>, <a id='2041' tid='2040' class='u'>True</a>))
                    return (<a id='2065' tid='2064' class='u'>append</a>(<a id='2063' tid='2062' class='u'>m2</a>, <a id='2061' tid='2060' class='u'>m1</a>, <a id='2059' tid='2058' class='u'>m0</a>), <a id='2057' tid='2056' class='u'>c0</a> <a id='2053' tid='2052' class='u'>+</a> <a id='2055' tid='2054' class='u'>framecost</a>)

    return <a id='2067' tid='2066' class='u'>None</a></a>





##########################################################################
##                          move detection
##########################################################################
<a id='2091' tid='2090' class='c'>def <a id='2089' tid='2088' class='c'>move_candidate</a>(<a id='2073' tid='2072' class='u'>node</a>):
    return (<a id='2087' tid='2086' class='c'>is_def</a>(<a id='2085' tid='2084' class='u'>node</a>) <a id='2075' tid='2074' class='u'>or</a> <a id='2081' tid='2080' class='c'>node_size</a>(<a id='2083' tid='2082' class='u'>node</a>) <a id='2077' tid='2076' class='u'>&gt;=</a> <a id='2079' tid='2078' class='u'>MOVE_SIZE</a></a>)


<a id='2093' tid='2092' class='c'>stat.move_count</a> = <a id='2095' tid='2094' class='u'>0</a>
<a id='2097' tid='2096' class='c'>stat.move_savings</a> = <a id='2099' tid='2098' class='u'>0</a>
<a id='2375' tid='2374' class='c'>def <a id='2373' tid='2372' class='c'>get_moves</a>(<a id='2105' tid='2104' class='u'>ds</a>, <a id='2103' tid='2102' class='u'>round</a>=<a id='2101' tid='2100' class='u'>0</a>):

    <a id='2107' tid='2106' class='u'>dels</a> = <a id='2131' tid='2130' class='u'>pylist</a>(<a id='2129' tid='2128' class='u'>filterlist</a>(lambda <a id='2127' tid='2126' class='u'>p</a>: (<a id='2111' tid='2110' class='u'>p.cur</a> <a id='2115' tid='2114' class='u'>==</a> <a id='2113' tid='2112' class='u'>None</a> <a id='2125' tid='2124' class='u'>and</a>
                                        <a id='2117' tid='2116' class='c'>move_candidate</a>(<a id='2119' tid='2118' class='u'>p.orig</a>) and
                                        <a id='2123' tid='2122' class='u'>not</a> <a id='2121' tid='2120' class='c'>p.is_frame</a>),
                             <a id='2109' tid='2108' class='u'>ds</a>))
    <a id='2133' tid='2132' class='u'>adds</a> = <a id='2157' tid='2156' class='u'>pylist</a>(<a id='2155' tid='2154' class='u'>filterlist</a>(lambda <a id='2153' tid='2152' class='u'>p</a>: (<a id='2137' tid='2136' class='u'>p.orig</a> <a id='2141' tid='2140' class='u'>==</a> <a id='2139' tid='2138' class='u'>None</a> <a id='2151' tid='2150' class='u'>and</a>
                                        <a id='2143' tid='2142' class='c'>move_candidate</a>(<a id='2145' tid='2144' class='u'>p.cur</a>) and
                                        <a id='2149' tid='2148' class='u'>not</a> <a id='2147' tid='2146' class='c'>p.is_frame</a>),
                             <a id='2135' tid='2134' class='u'>ds</a>))

    # print &quot;dels=&quot;, dels
    # print &quot;adds=&quot;, adds

    <a id='2159' tid='2158' class='u'>matched</a> = []
    <a id='2161' tid='2160' class='u'>newChanges</a>, <a id='2163' tid='2162' class='u'>total</a> = <a id='2167' tid='2166' class='u'>nil</a>, <a id='2165' tid='2164' class='u'>0</a>

    print(<a id='2169' tid='2168' class='c'>&quot;\n[move #%d] %d * %d = %d pairs of nodes to consider ...&quot;</a>
          <a id='2191' tid='2190' class='u'>%</a> (<a id='2189' tid='2188' class='u'>round</a>, <a id='2187' tid='2186' class='u'>len</a>(<a id='2185' tid='2184' class='u'>dels</a>), <a id='2183' tid='2182' class='u'>len</a>(<a id='2181' tid='2180' class='u'>adds</a>), <a id='2177' tid='2176' class='u'>len</a>(<a id='2179' tid='2178' class='u'>dels</a>) <a id='2171' tid='2170' class='u'>*</a> <a id='2173' tid='2172' class='u'>len</a>(<a id='2175' tid='2174' class='u'>adds</a>)))

    for <a id='2193' tid='2192' class='u'>d0</a> in <a id='2195' tid='2194' class='u'>dels</a>:
        for <a id='2197' tid='2196' class='u'>a0</a> in <a id='2199' tid='2198' class='u'>adds</a>:
            (<a id='2201' tid='2200' class='u'>node1</a>, <a id='2203' tid='2202' class='u'>node2</a>) = (<a id='2207' tid='2206' class='u'>d0.orig</a>, <a id='2205' tid='2204' class='u'>a0.cur</a>)
            (<a id='2209' tid='2208' class='u'>changes</a>, <a id='2211' tid='2210' class='u'>cost</a>) = <a id='2225' tid='2224' class='c'>diff_node</a>(<a id='2223' tid='2222' class='u'>node1</a>, <a id='2221' tid='2220' class='u'>node2</a>, <a id='2219' tid='2218' class='u'>nil</a>, <a id='2217' tid='2216' class='u'>nil</a>, <a id='2215' tid='2214' class='u'>0</a>, <a id='2213' tid='2212' class='u'>True</a>)
            <a id='2227' tid='2226' class='u'>nterms</a> = <a id='2235' tid='2234' class='c'>node_size</a>(<a id='2237' tid='2236' class='u'>node1</a>) <a id='2229' tid='2228' class='u'>+</a> <a id='2231' tid='2230' class='c'>node_size</a>(<a id='2233' tid='2232' class='u'>node2</a>)

            if (<a id='2259' tid='2258' class='c'>can_move</a>(<a id='2257' tid='2256' class='u'>node1</a>, <a id='2255' tid='2254' class='u'>node2</a>, <a id='2253' tid='2252' class='u'>cost</a>) <a id='2239' tid='2238' class='u'>or</a>
                <a id='2251' tid='2250' class='u'>nodeFramed</a>(<a id='2249' tid='2248' class='u'>node1</a>, <a id='2247' tid='2246' class='u'>changes</a>) or
                <a id='2245' tid='2244' class='u'>nodeFramed</a>(<a id='2243' tid='2242' class='u'>node2</a>, <a id='2241' tid='2240' class='u'>changes</a>)):

                <a id='2263' tid='2262' class='u'>matched.append</a>(<a id='2261' tid='2260' class='u'>d0</a>)
                <a id='2267' tid='2266' class='u'>matched.append</a>(<a id='2265' tid='2264' class='u'>a0</a>)
                <a id='2271' tid='2270' class='u'>adds.remove</a>(<a id='2269' tid='2268' class='u'>a0</a>)
                <a id='2273' tid='2272' class='u'>newChanges</a> = <a id='2279' tid='2278' class='u'>append</a>(<a id='2277' tid='2276' class='u'>changes</a>, <a id='2275' tid='2274' class='u'>newChanges</a>)
                <a id='2281' tid='2280' class='u'>total</a> <a id='2285' tid='2284' class='u'>+</a>= <a id='2283' tid='2282' class='u'>cost</a>

                if (<a id='2305' tid='2304' class='u'>not</a> <a id='2307' tid='2306' class='u'>nodeFramed</a>(<a id='2309' tid='2308' class='u'>node1</a>, <a id='2311' tid='2310' class='u'>changes</a>) <a id='2287' tid='2286' class='u'>and</a>
                    <a id='2297' tid='2296' class='u'>not</a> <a id='2299' tid='2298' class='u'>nodeFramed</a>(<a id='2301' tid='2300' class='u'>node2</a>, <a id='2303' tid='2302' class='u'>changes</a>) and
                    <a id='2295' tid='2294' class='c'>is_def</a>(<a id='2293' tid='2292' class='u'>node1</a>) and <a id='2291' tid='2290' class='c'>is_def</a>(<a id='2289' tid='2288' class='u'>node2</a>)):
                    <a id='2313' tid='2312' class='u'>newChanges</a> = <a id='2325' tid='2324' class='u'>append</a>(<a id='2323' tid='2322' class='c'>mod_node</a>(<a id='2321' tid='2320' class='u'>node1</a>, <a id='2319' tid='2318' class='u'>node2</a>, <a id='2317' tid='2316' class='u'>cost</a>),
                                        <a id='2315' tid='2314' class='u'>newChanges</a>)

                <a id='2327' tid='2326' class='c'>stat.move_savings</a> <a id='2331' tid='2330' class='u'>+</a>= <a id='2329' tid='2328' class='u'>nterms</a>
                <a id='2333' tid='2332' class='c'>stat.move_count</a> <a id='2337' tid='2336' class='u'>+</a>=<a id='2335' tid='2334' class='u'>1</a>
                if <a id='2343' tid='2342' class='c'>stat.move_count</a> <a id='2347' tid='2346' class='u'>%</a> <a id='2345' tid='2344' class='u'>1000</a> <a id='2339' tid='2338' class='u'>==</a> <a id='2341' tid='2340' class='u'>0</a>:
                    <a id='2349' tid='2348' class='u'>dot</a>()

                break

    print(<a id='2351' tid='2350' class='u'>&quot;\n\t%d matched pairs found with %d new changes.&quot;</a>
          <a id='2365' tid='2364' class='u'>%</a> (<a id='2363' tid='2362' class='u'>len</a>(<a id='2361' tid='2360' class='u'>pylist</a>(<a id='2359' tid='2358' class='u'>matched</a>)), <a id='2357' tid='2356' class='u'>len</a>(<a id='2355' tid='2354' class='u'>pylist</a>(<a id='2353' tid='2352' class='u'>newChanges</a>))))

    # print &quot;matches=&quot;, matched
    # print &quot;newChanges=&quot;, newChanges

    return (<a id='2371' tid='2370' class='u'>matched</a>, <a id='2369' tid='2368' class='u'>newChanges</a>, <a id='2367' tid='2366' class='u'>total</a></a>)



# Get moves repeatedly because new moves may introduce new
# deletions and insertions.

<a id='2483' tid='2482' class='c'>def <a id='2481' tid='2480' class='c'>find_all_moves</a>(<a id='2377' tid='2376' class='u'>res</a>):
    (<a id='2379' tid='2378' class='u'>changes</a>, <a id='2381' tid='2380' class='u'>cost</a>) = <a id='2383' tid='2382' class='u'>res</a>
    <a id='2385' tid='2384' class='u'>matched</a> = <a id='2387' tid='2386' class='u'>None</a>
    <a id='2389' tid='2388' class='u'>moveround</a> = <a id='2391' tid='2390' class='u'>1</a>

    while <a id='2403' tid='2402' class='u'>moveround</a> <a id='2399' tid='2398' class='u'>&lt;=</a> <a id='2401' tid='2400' class='u'>MOVE_ROUND</a> <a id='2393' tid='2392' class='u'>and</a> <a id='2397' tid='2396' class='u'>matched</a> <a id='2395' tid='2394' class='u'>&lt;&gt;</a> []:
        (<a id='2405' tid='2404' class='u'>matched</a>, <a id='2407' tid='2406' class='u'>newChanges</a>, <a id='2409' tid='2408' class='u'>c</a>) = <a id='2415' tid='2414' class='c'>get_moves</a>(<a id='2413' tid='2412' class='u'>changes</a>, <a id='2411' tid='2410' class='u'>moveround</a>)
        <a id='2417' tid='2416' class='u'>moveround</a> <a id='2421' tid='2420' class='u'>+</a>= <a id='2419' tid='2418' class='u'>1</a>
        # print &quot;matched:&quot;, matched
        # print &quot;changes:&quot;, changes
        <a id='2423' tid='2422' class='u'>changes</a> = <a id='2435' tid='2434' class='u'>filterlist</a>(lambda <a id='2433' tid='2432' class='u'>c</a>: <a id='2427' tid='2426' class='u'>c</a> <a id='2431' tid='2430' class='u'>not in</a> <a id='2429' tid='2428' class='u'>matched</a>, <a id='2425' tid='2424' class='u'>changes</a>)
        <a id='2437' tid='2436' class='u'>changes</a> = <a id='2443' tid='2442' class='u'>append</a>(<a id='2441' tid='2440' class='u'>newChanges</a>, <a id='2439' tid='2438' class='u'>changes</a>)
        <a id='2445' tid='2444' class='u'>savings</a> = <a id='2463' tid='2462' class='u'>sum</a>(<a id='2461' tid='2460' class='u'>map</a>(lambda <a id='2459' tid='2458' class='u'>p</a>: <a id='2451' tid='2450' class='c'>node_size</a>(<a id='2449' tid='2448' class='u'>p.orig</a>) <a id='2457' tid='2456' class='u'>+</a> <a id='2455' tid='2454' class='c'>node_size</a>(<a id='2453' tid='2452' class='u'>p.cur</a>), <a id='2447' tid='2446' class='u'>matched</a>))
        <a id='2465' tid='2464' class='u'>cost</a> = <a id='2471' tid='2470' class='u'>cost</a> <a id='2475' tid='2474' class='u'>+</a> <a id='2473' tid='2472' class='u'>c</a> <a id='2467' tid='2466' class='u'>-</a> <a id='2469' tid='2468' class='u'>savings</a>
    return (<a id='2479' tid='2478' class='u'>changes</a>, <a id='2477' tid='2476' class='u'>cost</a></a>)








#-------------------------------------------------------------
#                     main HTML based command
#-------------------------------------------------------------

<a id='2791' tid='2790' class='c'>def <a id='2789' tid='2788' class='u'>diff</a>(<a id='2491' tid='2490' class='u'>file1</a>, <a id='2489' tid='2488' class='u'>file2</a>, <a id='2487' tid='2486' class='u'>move</a>=<a id='2485' tid='2484' class='u'>True</a>):

    <a id='2495' tid='2494' class='u'>import</a> <a id='2493' tid='2492' class='u'>time</a>
    print(<a id='2497' tid='2496' class='u'>&quot;\nJob started at %s, %s\n&quot;</a> <a id='2505' tid='2504' class='u'>%</a> (<a id='2503' tid='2502' class='u'>time.ctime</a>(), <a id='2501' tid='2500' class='u'>time.tzname</a>[<a id='2499' tid='2498' class='u'>0</a>]))
    <a id='2507' tid='2506' class='c'>start_time</a> = <a id='2509' tid='2508' class='u'>time.time</a>()
    <a id='2513' tid='2512' class='u'>checkpoint</a>(<a id='2511' tid='2510' class='c'>start_time</a>)

    <a id='2515' tid='2514' class='c'>cleanup</a>()

    # base files names
    <a id='2517' tid='2516' class='c'>base1</a> = <a id='2521' tid='2520' class='c'>base_name</a>(<a id='2519' tid='2518' class='u'>file1</a>)
    <a id='2523' tid='2522' class='c'>base2</a> = <a id='2527' tid='2526' class='c'>base_name</a>(<a id='2525' tid='2524' class='u'>file2</a>)

    # get AST of file1
    <a id='2529' tid='2528' class='u'>f1</a> = <a id='2535' tid='2534' class='u'>open</a>(<a id='2533' tid='2532' class='u'>file1</a>, <a id='2531' tid='2530' class='u'>&#39;r&#39;</a>);
    <a id='2537' tid='2536' class='u'>lines1</a> = <a id='2539' tid='2538' class='u'>f1.read</a>()
    <a id='2541' tid='2540' class='u'>f1.close</a>()
    <a id='2543' tid='2542' class='u'>node1</a> = <a id='2547' tid='2546' class='u'>parse</a>(<a id='2545' tid='2544' class='u'>lines1</a>)
    <a id='2557' tid='2556' class='c'>improve_ast</a>(<a id='2555' tid='2554' class='u'>node1</a>, <a id='2553' tid='2552' class='u'>lines1</a>, <a id='2551' tid='2550' class='u'>file1</a>, <a id='2549' tid='2548' class='u'>&#39;left&#39;</a>)

    # get AST of file2
    <a id='2559' tid='2558' class='u'>f2</a> = <a id='2565' tid='2564' class='u'>open</a>(<a id='2563' tid='2562' class='u'>file2</a>, <a id='2561' tid='2560' class='u'>&#39;r&#39;</a>);
    <a id='2567' tid='2566' class='u'>lines2</a> = <a id='2569' tid='2568' class='u'>f2.read</a>()
    <a id='2571' tid='2570' class='u'>f2.close</a>()
    <a id='2573' tid='2572' class='u'>node2</a> = <a id='2577' tid='2576' class='u'>parse</a>(<a id='2575' tid='2574' class='u'>lines2</a>)
    <a id='2587' tid='2586' class='c'>improve_ast</a>(<a id='2585' tid='2584' class='u'>node2</a>, <a id='2583' tid='2582' class='u'>lines2</a>, <a id='2581' tid='2580' class='u'>file2</a>, <a id='2579' tid='2578' class='u'>&#39;right&#39;</a>)


    print(<a id='2589' tid='2588' class='u'>&quot;[parse] finished in %s. Now start to diff.&quot;</a> <a id='2595' tid='2594' class='u'>%</a> <a id='2593' tid='2592' class='c'>sec_to_min</a>(<a id='2591' tid='2590' class='u'>checkpoint</a>()))

    # get the changes

    (<a id='2597' tid='2596' class='u'>changes</a>, <a id='2599' tid='2598' class='u'>cost</a>) = <a id='2613' tid='2612' class='c'>diff_node</a>(<a id='2611' tid='2610' class='u'>node1</a>, <a id='2609' tid='2608' class='u'>node2</a>, <a id='2607' tid='2606' class='u'>nil</a>, <a id='2605' tid='2604' class='u'>nil</a>, <a id='2603' tid='2602' class='u'>0</a>, <a id='2601' tid='2600' class='u'>False</a>)

    print (<a id='2615' tid='2614' class='u'>&quot;\n[diff] processed %d nodes in %s.&quot;</a>
           <a id='2623' tid='2622' class='u'>%</a> (<a id='2621' tid='2620' class='c'>stat.diff_count</a>, <a id='2619' tid='2618' class='c'>sec_to_min</a>(<a id='2617' tid='2616' class='u'>checkpoint</a>())))

    if <a id='2625' tid='2624' class='u'>move</a>:
        (<a id='2627' tid='2626' class='u'>changes</a>, <a id='2629' tid='2628' class='u'>cost</a>) = <a id='2635' tid='2634' class='c'>find_all_moves</a>((<a id='2633' tid='2632' class='u'>changes</a>, <a id='2631' tid='2630' class='u'>cost</a>))

        print(<a id='2637' tid='2636' class='c'>&quot;\nfinished in %s.&quot;</a> <a id='2643' tid='2642' class='u'>%</a> <a id='2641' tid='2640' class='c'>sec_to_min</a>(<a id='2639' tid='2638' class='u'>checkpoint</a>()))



    #---------------------- print final stats ---------------------
    <a id='2645' tid='2644' class='u'>size1</a> = <a id='2649' tid='2648' class='c'>node_size</a>(<a id='2647' tid='2646' class='u'>node1</a>)
    <a id='2651' tid='2650' class='u'>size2</a> = <a id='2655' tid='2654' class='c'>node_size</a>(<a id='2653' tid='2652' class='u'>node2</a>)
    <a id='2657' tid='2656' class='u'>total</a> = <a id='2663' tid='2662' class='u'>size1</a> <a id='2659' tid='2658' class='u'>+</a> <a id='2661' tid='2660' class='u'>size2</a>

    <a id='2665' tid='2664' class='u'>report</a> = <a id='2667' tid='2666' class='u'>&quot;&quot;</a>
    <a id='2669' tid='2668' class='u'>report</a> <a id='2677' tid='2676' class='u'>+</a>= (<a id='2675' tid='2674' class='u'>&quot;\n--------------------- summary -----------------------&quot;</a>) <a id='2671' tid='2670' class='u'>+</a> <a id='2673' tid='2672' class='u'>&quot;\n&quot;</a>
    <a id='2679' tid='2678' class='u'>report</a> <a id='2691' tid='2690' class='u'>+</a>= (<a id='2685' tid='2684' class='u'>&quot;- total changes (chars):  %d&quot;</a> <a id='2689' tid='2688' class='u'>%</a> <a id='2687' tid='2686' class='u'>cost</a>)                  <a id='2681' tid='2680' class='u'>+</a> <a id='2683' tid='2682' class='u'>&quot;\n&quot;</a>
    <a id='2693' tid='2692' class='u'>report</a> <a id='2709' tid='2708' class='u'>+</a>= (<a id='2699' tid='2698' class='u'>&quot;- total code size:        %d (left: %d  right: %d)&quot;</a>
               <a id='2707' tid='2706' class='u'>%</a> (<a id='2705' tid='2704' class='u'>total</a>, <a id='2703' tid='2702' class='u'>size1</a>, <a id='2701' tid='2700' class='u'>size2</a>))                                <a id='2695' tid='2694' class='u'>+</a> <a id='2697' tid='2696' class='u'>&quot;\n&quot;</a>
    <a id='2711' tid='2710' class='u'>report</a> <a id='2723' tid='2722' class='u'>+</a>= (<a id='2717' tid='2716' class='u'>&quot;- total moved pieces:     %d&quot;</a> <a id='2721' tid='2720' class='u'>%</a> <a id='2719' tid='2718' class='c'>stat.move_count</a>)        <a id='2713' tid='2712' class='u'>+</a> <a id='2715' tid='2714' class='u'>&quot;\n&quot;</a>
    <a id='2725' tid='2724' class='u'>report</a> <a id='2745' tid='2744' class='u'>+</a>= (<a id='2731' tid='2730' class='u'>&quot;- percentage of change:   %.1f%%&quot;</a>
               <a id='2743' tid='2742' class='u'>%</a> (<a id='2737' tid='2736' class='u'>div</a>(<a id='2739' tid='2738' class='u'>cost</a>, <a id='2741' tid='2740' class='u'>total</a>) <a id='2733' tid='2732' class='u'>*</a> <a id='2735' tid='2734' class='u'>100</a>))                             <a id='2727' tid='2726' class='u'>+</a> <a id='2729' tid='2728' class='u'>&quot;\n&quot;</a>
    <a id='2747' tid='2746' class='u'>report</a> <a id='2755' tid='2754' class='u'>+</a>= (<a id='2753' tid='2752' class='u'>&quot;-----------------------------------------------------&quot;</a>)   <a id='2749' tid='2748' class='u'>+</a> <a id='2751' tid='2750' class='u'>&quot;\n&quot;</a>

    print <a id='2757' tid='2756' class='u'>report</a>


    #---------------------- generation HTML ---------------------

    <a id='2761' tid='2760' class='c'>htmlize</a>(<span class='i'>changes</span>, <a id='2759' tid='2758' class='c'>file1</a>, <span class='i'>file2</span>, <span class='i'>lines1</span>, <span class='i'>lines2</span>)

    <a id='2763' tid='2762' class='u'>dur</a> = <a id='2769' tid='2768' class='u'>time.time</a>() <a id='2765' tid='2764' class='u'>-</a> <a id='2767' tid='2766' class='c'>start_time</a>
    print(<a id='2771' tid='2770' class='u'>&quot;\n[summary] Job finished at %s, %s&quot;</a> <a id='2779' tid='2778' class='u'>%</a>
          (<a id='2777' tid='2776' class='u'>time.ctime</a>(), <a id='2775' tid='2774' class='u'>time.tzname</a>[<a id='2773' tid='2772' class='u'>0</a>]))
    print(<a id='2781' tid='2780' class='u'>&quot;\n\tTotal duration: %s&quot;</a> <a id='2787' tid='2786' class='u'>%</a> <a id='2785' tid='2784' class='c'>sec_to_min</a>(<a id='2783' tid='2782' class='u'>dur</a>))</a>




<a id='2819' tid='2818' class='c'>def <a id='2817' tid='2816' class='c'>cleanup</a>():
    <a id='2793' tid='2792' class='c'>clear_str_dist_cache</a>()
    <a id='2795' tid='2794' class='c'>clear_uid</a>()

    global allNodes1, allNodes2
    <a id='2797' tid='2796' class='u'>allNodes1</a> = <a id='2799' tid='2798' class='u'>set</a>()
    <a id='2801' tid='2800' class='u'>allNodes2</a> = <a id='2803' tid='2802' class='u'>set</a>()

    <a id='2805' tid='2804' class='c'>stat.diff_count</a> = <a id='2807' tid='2806' class='u'>0</a>
    <a id='2809' tid='2808' class='c'>stat.move_count</a> = <a id='2811' tid='2810' class='u'>0</a>
    <a id='2813' tid='2812' class='c'>stat.move_savings</a> = <a id='2815' tid='2814' class='u'>0</a></a>



<a id='2847' tid='2846' class='c'>def <a id='2845' tid='2844' class='c'>sec_to_min</a>(<a id='2821' tid='2820' class='u'>s</a>):
    if <a id='2827' tid='2826' class='u'>s</a> <a id='2823' tid='2822' class='u'>&lt;</a> <a id='2825' tid='2824' class='u'>60</a>:
        return (<a id='2833' tid='2832' class='u'>&quot;%.1f seconds&quot;</a> <a id='2829' tid='2828' class='u'>%</a> <a id='2831' tid='2830' class='u'>s</a>)
    else:
        return (<a id='2843' tid='2842' class='u'>&quot;%.1f minutes&quot;</a> <a id='2835' tid='2834' class='u'>%</a> <a id='2837' tid='2836' class='u'>div</a>(<a id='2839' tid='2838' class='u'>s</a>, <a id='2841' tid='2840' class='u'>60</a>)</a>)



<a id='2849' tid='2848' class='c'>last_checkpoint</a> = <a id='2851' tid='2850' class='u'>None</a>
<a id='2889' tid='2888' class='c'>def <a id='2887' tid='2886' class='u'>checkpoint</a>(<a id='2855' tid='2854' class='u'>init</a>=<a id='2853' tid='2852' class='u'>None</a>):
    <a id='2859' tid='2858' class='u'>import</a> <a id='2857' tid='2856' class='u'>time</a>
    global last_checkpoint
    if <a id='2865' tid='2864' class='u'>init</a> <a id='2861' tid='2860' class='u'>&lt;&gt;</a> <a id='2863' tid='2862' class='u'>None</a>:
        <a id='2867' tid='2866' class='c'>last_checkpoint</a> = <a id='2869' tid='2868' class='u'>init</a>
        return <a id='2871' tid='2870' class='u'>None</a>
    else:
        <a id='2873' tid='2872' class='u'>dur</a> = <a id='2879' tid='2878' class='u'>time.time</a>() <a id='2875' tid='2874' class='u'>-</a> <a id='2877' tid='2876' class='c'>last_checkpoint</a>
        <a id='2881' tid='2880' class='c'>last_checkpoint</a> = <a id='2883' tid='2882' class='u'>time.time</a>()
        return <a id='2885' tid='2884' class='u'>dur</a></a>




#-------------------------------------------------------------
#                      text-based interfaces
#-------------------------------------------------------------

## print the diffs as text
<a id='2955' tid='2954' class='c'>def <a id='2953' tid='2952' class='c'>print_diff</a>(<a id='2893' tid='2892' class='u'>file1</a>, <a id='2891' tid='2890' class='u'>file2</a>):
    (<a id='2895' tid='2894' class='u'>m</a>, <a id='2897' tid='2896' class='u'>c</a>) = <a id='2903' tid='2902' class='c'>diff_file</a>(<a id='2901' tid='2900' class='u'>file1</a>, <a id='2899' tid='2898' class='u'>file2</a>)
    print <a id='2905' tid='2904' class='u'>&quot;----------&quot;</a>, <a id='2907' tid='2906' class='u'>file1</a>, <a id='2909' tid='2908' class='u'>&quot;&lt;&lt;&lt;&quot;</a>, <a id='2911' tid='2910' class='u'>c</a>, <a id='2913' tid='2912' class='u'>&quot;&gt;&gt;&gt;&quot;</a>, <a id='2915' tid='2914' class='u'>file2</a>, <a id='2917' tid='2916' class='u'>&quot;-----------&quot;</a>

    <a id='2919' tid='2918' class='u'>ms</a> = <a id='2923' tid='2922' class='u'>pylist</a>(<a id='2921' tid='2920' class='u'>m</a>)
    <a id='2925' tid='2924' class='u'>ms</a> = <a id='2935' tid='2934' class='u'>sorted</a>(<a id='2933' tid='2932' class='u'>ms</a>, key=lambda <a id='2927' tid='2926' class='u'>d</a>: <a id='2931' tid='2930' class='c'>node_start</a>(<a id='2929' tid='2928' class='u'>d.orig</a>))
    print <a id='2937' tid='2936' class='u'>&quot;\n-------------------- changes(&quot;</a>, <a id='2939' tid='2938' class='u'>len</a>(<a id='2941' tid='2940' class='u'>ms</a>), <a id='2943' tid='2942' class='u'>&quot;)---------------------- &quot;</a>
    for <a id='2945' tid='2944' class='u'>m0</a> in <a id='2947' tid='2946' class='u'>ms</a>:
        print <a id='2949' tid='2948' class='u'>m0</a>

    print <a id='2951' tid='2950' class='u'>&quot;\n-------------------  end  ----------------------- &quot;</a></a>




<a id='2991' tid='2990' class='c'>def <a id='2989' tid='2988' class='c'>diff_file</a>(<a id='2959' tid='2958' class='u'>file1</a>, <a id='2957' tid='2956' class='u'>file2</a>):
    <a id='2961' tid='2960' class='u'>node1</a> = <a id='2965' tid='2964' class='c'>parse_file</a>(<a id='2963' tid='2962' class='u'>file1</a>)
    <a id='2967' tid='2966' class='u'>node2</a> = <a id='2971' tid='2970' class='c'>parse_file</a>(<a id='2969' tid='2968' class='u'>file2</a>)
    return <a id='2987' tid='2986' class='c'>find_all_moves</a>(<a id='2985' tid='2984' class='c'>diff_node</a>(<a id='2983' tid='2982' class='u'>node1</a>, <a id='2981' tid='2980' class='u'>node2</a>, <a id='2979' tid='2978' class='u'>nil</a>, <a id='2977' tid='2976' class='u'>nil</a>, <a id='2975' tid='2974' class='u'>0</a>, <a id='2973' tid='2972' class='u'>False</a>))</a>


## if run under command line
## pydiff.py file1.py file2.py
<span class='i'>if len(sys.argv) == 3:
    file1 = sys.argv[1]
    file2 = sys.argv[2]
    diff(file1, file2)</span>
</pre></div></body>
</html>
